<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Токенатор — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .tokenator-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .preview-section {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin: 2rem 0;
    }
    .canvas-wrapper {
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      position: relative;
      min-width: 220px;
    }
    #tokenCanvas {
      background: #151025;
      border-radius: 50%;
      cursor: move;
      max-width: 100%;
      height: auto;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      background: rgba(26, 20, 45, 0.8);
      padding: 1.5rem;
      border-radius: 12px;
      margin-top: 1rem;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .form-row label {
      min-width: 140px;
      color: var(--accent);
      font-weight: 600;
    }
    .form-control, #charNameInput {
      flex: 1;
      padding: 0.6rem;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 6px;
      color: white;
    }
    .btn-group {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .toggle-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .toggle-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .preview-section {
        flex-direction: column;
        align-items: center;
      }
      .form-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="characters.html">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="#" class="active">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Токенатор</h1>
      <p>Создайте уникальный токен для своего персонажа</p>
    </div>

    <div class="tokenator-container">
      <div class="controls">
        <div class="form-row">
          <label for="imageUpload">Изображение:</label>
          <input type="file" id="imageUpload" accept="image/*">
        </div>

        <div class="form-row">
          <label>Имя персонажа:</label>
          <div style="flex: 1;">
            <input type="text" id="charNameInput" placeholder="Арагорн (оставьте пустым, чтобы скрыть)" maxlength="20">
            <div class="toggle-group" style="margin-top: 0.5rem;">
              <label>
                <input type="checkbox" id="showNameToggle" checked> Показывать имя
              </label>
              <button id="mirrorBtn" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.9rem;">↔ Отразить</button>
            </div>
          </div>
        </div>

        <div class="form-row">
          <label for="zoomSlider">Масштаб:</label>
          <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1" class="form-control" style="height: 28px;">
        </div>

        <div class="btn-group">
          <button id="generateBtn" class="btn btn-primary">Обновить токен</button>
          <button id="downloadBtn" class="btn btn-secondary" disabled>Скачать PNG</button>
          <button id="saveToStorageBtn" class="btn" style="background: #4ade80; color: #000;" disabled>Сохранить</button>
        </div>
      </div>

      <div class="preview-section">
        <div class="canvas-wrapper">
          <h3>Предпросмотр</h3>
          <canvas id="tokenCanvas" width="200" height="200"></canvas>
          <p style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">Перетаскивайте изображение внутри круга</p>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <script src="main.js" defer></script>
  <script>
    // DOM elements
    const imageUpload = document.getElementById('imageUpload');
    const charNameInput = document.getElementById('charNameInput');
    const showNameToggle = document.getElementById('showNameToggle');
    const mirrorBtn = document.getElementById('mirrorBtn');
    const zoomSlider = document.getElementById('zoomSlider');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveToStorageBtn = document.getElementById('saveToStorageBtn');
    const tokenCanvas = document.getElementById('tokenCanvas');
    const ctx = tokenCanvas.getContext('2d');

    // State
    let uploadedImage = null;
    let offsetX = 0;
    let offsetY = 0;
    let scale = 1;
    let isMirrored = false;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;

    // Load image
    imageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          // Сброс параметров
          offsetX = 0;
          offsetY = 0;
          scale = 1;
          isMirrored = false;
          zoomSlider.value = 1;
          charNameInput.value = '';
          showNameToggle.checked = true;
          generateBtn.disabled = false;
          renderToken();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Mirror image
    mirrorBtn.addEventListener('click', () => {
      isMirrored = !isMirrored;
      renderToken();
    });

    // Zoom
    zoomSlider.addEventListener('input', () => {
      scale = parseFloat(zoomSlider.value);
      renderToken();
    });

    // Drag interaction
    tokenCanvas.addEventListener('mousedown', (e) => {
      if (!uploadedImage) return;
      isDragging = true;
      dragStartX = e.offsetX;
      dragStartY = e.offsetY;
      tokenCanvas.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging || !uploadedImage) return;
      const rect = tokenCanvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;
      
      offsetX += (currentX - dragStartX);
      offsetY += (currentY - dragStartY);
      
      dragStartX = currentX;
      dragStartY = currentY;
      
      renderToken();
    });

    window.addEventListener('mouseup', () => {
      isDragging = false;
      tokenCanvas.style.cursor = 'move';
    });

    // Touch support (optional)
    tokenCanvas.addEventListener('touchstart', (e) => {
      if (!uploadedImage) return;
      isDragging = true;
      const touch = e.touches[0];
      dragStartX = touch.clientX - tokenCanvas.getBoundingClientRect().left;
      dragStartY = touch.clientY - tokenCanvas.getBoundingClientRect().top;
      e.preventDefault();
    });

    window.addEventListener('touchmove', (e) => {
      if (!isDragging || !uploadedImage) return;
      const touch = e.touches[0];
      const rect = tokenCanvas.getBoundingClientRect();
      const currentX = touch.clientX - rect.left;
      const currentY = touch.clientY - rect.top;
      
      offsetX += (currentX - dragStartX);
      offsetY += (currentY - dragStartY);
      
      dragStartX = currentX;
      dragStartY = currentY;
      
      renderToken();
      e.preventDefault();
    });

    window.addEventListener('touchend', () => {
      isDragging = false;
    });

    // Render token
    function renderToken() {
      if (!uploadedImage) return;

      ctx.clearRect(0, 0, tokenCanvas.width, tokenCanvas.height);

      // Apply circular mask
      ctx.save();
      ctx.beginPath();
      ctx.arc(100, 100, 100, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();

      // Draw image
      const img = uploadedImage;
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      const x = 100 - scaledWidth / 2 + offsetX;
      const y = 100 - scaledHeight / 2 + offsetY;

      ctx.save();
      if (isMirrored) {
        ctx.translate(200, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
      ctx.restore();

      ctx.restore();

      // Draw name if enabled
      if (showNameToggle.checked) {
        const name = charNameInput.value.trim() || '???';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 160, 200, 40);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(name, 100, 188);
      }

      // Enable buttons
      downloadBtn.disabled = false;
      saveToStorageBtn.disabled = false;
    }

    // Manual update
    generateBtn.addEventListener('click', renderToken);

    // Real-time name update
    charNameInput.addEventListener('input', renderToken);
    showNameToggle.addEventListener('change', renderToken);

    // Download token
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `${charNameInput.value.trim() || 'token'}.png`;
      link.href = tokenCanvas.toDataURL('image/png');
      link.click();
    });

    // Save to localStorage
    saveToStorageBtn.addEventListener('click', () => {
      const user = JSON.parse(localStorage.getItem('kdUser'));
      if (!user) {
        alert('Требуется регистрация для сохранения токенов.');
        return;
      }

      const tokenData = {
        id: Date.now(),
        name: charNameInput.value.trim() || 'Безымянный',
        owner: user.username,
        imageUrl: tokenCanvas.toDataURL('image/png'),
        createdAt: new Date().toISOString()
      };

      const tokens = JSON.parse(localStorage.getItem('kdTokens')) || [];
      tokens.push(tokenData);
      localStorage.setItem('kdTokens', JSON.stringify(tokens));

      alert(`Токен "${tokenData.name}" сохранён!`);
    });

    // Initialize UI
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const menuToggle = document.getElementById('menuToggle');

      if (menuToggle && sidebar && mainContent) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          mainContent.classList.toggle('sidebar-hidden');
        });

        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 576 && 
              !sidebar.classList.contains('hidden') && 
              !sidebar.contains(e.target) && 
              e.target !== menuToggle) {
            sidebar.classList.add('hidden');
            mainContent.classList.add('sidebar-hidden');
          }
        });
      }

      // Auth fallback
      setTimeout(() => {
        if (typeof initAuth !== 'function') {
          const user = JSON.parse(localStorage.getItem('kdUser'));
          const authBtn = document.getElementById('authButton');
          if (user) {
            document.getElementById('accountName').textContent = user.username;
            document.getElementById('accountRole').textContent = user.role === 'player' ? 'Игрок' : 'Мастер';
            document.getElementById('accountInfo').classList.add('active');
            authBtn.textContent = 'Выйти';
            authBtn.onclick = () => {
              localStorage.removeItem('kdUser');
              location.reload();
            };
          }
        }
      }, 100);
    });
  </script>
</body>
</html>
