<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢–æ–∫–µ–Ω–∞—Ç–æ—Ä ‚Äî Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .tokenator-container {
      max-width: 950px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .preview-section {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin: 2rem 0;
    }
    .canvas-wrapper {
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 1.2rem;
      text-align: center;
      min-width: 240px;
      position: relative;
    }
    #tokenCanvas {
      background: #151025;
      border-radius: 50%;
      cursor: move;
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    .mirror-btn {
      margin-top: 1rem;
      padding: 0.4rem 0.8rem;
      background: rgba(138, 43, 226, 0.3);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .mirror-btn:hover {
      background: rgba(138, 43, 226, 0.5);
      transform: scale(1.03);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      background: rgba(26, 20, 45, 0.8);
      padding: 1.5rem;
      border-radius: 12px;
      margin-top: 1rem;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .form-row > label {
      min-width: 140px;
      color: var(--accent);
      font-weight: 600;
    }
    .upload-area {
      flex: 1;
      border: 2px dashed var(--primary-light);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      background: rgba(10, 8, 29, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(138, 43, 226, 0.1);
    }
    .upload-area i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
      color: var(--accent);
    }
    #imageUpload {
      display: none;
    }
    .text-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.8rem;
      margin-top: 0.5rem;
    }
    .text-option-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-size: 0.85rem;
      color: #c9a0dc;
    }
    .text-option-group select,
    .text-option-group input {
      width: 100%;
      padding: 0.4rem;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: white;
    }
    .toggle-group {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 0.5rem;
    }
    .toggle-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      color: var(--accent);
    }
    .btn-group {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .scale-mode {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 0.3rem;
    }
    .scale-mode label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .preview-section {
        flex-direction: column;
        align-items: center;
      }
      .form-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-group {
        flex-direction: column;
      }
      .text-options {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
      <li><a href="parties.html">–ù–∞–±–æ—Ä –≤ –ø–∞—Ä—Ç–∏–∏</a></li>
      <li><a href="rules.html">–ü—Ä–∞–≤–∏–ª–∞ D&D</a></li>
      <li><a href="characters.html">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</a></li>
      <li><a href="tabletop.html">–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ</a></li>
      <li><a href="#" class="active">–¢–æ–∫–µ–Ω–∞—Ç–æ—Ä</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">‚ò∞</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">‚Äî</div>
          <div class="account-role" id="accountRole">‚Äî</div>
        </div>
        <button class="auth-btn" id="authButton">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
    </header>

    <div class="page-header">
      <h1>–¢–æ–∫–µ–Ω–∞—Ç–æ—Ä</h1>
      <p>–°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</p>
    </div>

    <div class="tokenator-container">
      <div class="controls">
        <div class="form-row">
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
          <div class="upload-area" id="uploadArea">
            <i>üñºÔ∏è</i>
            <div>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
            <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.3rem;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: JPG, PNG, WebP</div>
          </div>
          <input type="file" id="imageUpload" accept="image/*">
        </div>

        <div class="form-row">
          <label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
          <div style="flex: 1;">
            <input type="text" id="charNameInput" placeholder="–ê—Ä–∞–≥–æ—Ä–Ω" maxlength="20">
            <div class="toggle-group">
              <label>
                <input type="checkbox" id="showNameToggle" checked> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–º—è
              </label>
            </div>
            <div class="text-options">
              <div class="text-option-group">
                <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
                <input type="color" id="textColor" value="#ffffff">
              </div>
              <div class="text-option-group">
                <label>–®—Ä–∏—Ñ—Ç</label>
                <select id="fontFamily">
                  <option value="Arial">Arial</option>
                  <option value="Verdana">Verdana</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Courier New">Courier New</option>
                  <option value="Impact">Impact</option>
                  <option value="Tahoma">Tahoma</option>
                </select>
              </div>
              <div class="text-option-group">
                <label>–ù–∞—á–µ—Ä—Ç–∞–Ω–∏–µ</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" id="boldToggle"> –ñ–∏—Ä–Ω—ã–π
                  </label>
                  <label style="display: flex; align-items: center; gap: 0.3rem;">
                    <input type="checkbox" id="italicToggle"> –ö—É—Ä—Å–∏–≤
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <label>–ú–∞—Å—à—Ç–∞–±:</label>
          <div style="flex: 1;">
            <div class="scale-mode">
              <label>
                <input type="radio" name="scaleMode" value="fit" checked> –í–º–µ—Å—Ç–∏—Ç—å —Ü–µ–ª–∏–∫–æ–º
              </label>
              <label>
                <input type="radio" name="scaleMode" value="manual"> –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π
              </label>
            </div>
            <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1" style="width: 100%; margin-top: 0.5rem; height: 28px;">
            <div id="zoomValue" style="text-align: right; font-size: 0.85rem; color: var(--accent); margin-top: 0.2rem;">1.0√ó</div>
          </div>
        </div>

        <div class="btn-group">
          <button id="generateBtn" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
          <button id="downloadBtn" class="btn btn-secondary" disabled>–°–∫–∞—á–∞—Ç—å PNG</button>
        </div>
      </div>

      <div class="preview-section">
        <div class="canvas-wrapper">
          <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
          <canvas id="tokenCanvas" width="200" height="200"></canvas>
          <button class="mirror-btn" id="mirrorBtn">‚Üî –û—Ç—Ä–∞–∑–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <footer>
      <p>¬© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <script src="main.js" defer></script>
  <script>
    // DOM
    const imageUpload = document.getElementById('imageUpload');
    const uploadArea = document.getElementById('uploadArea');
    const charNameInput = document.getElementById('charNameInput');
    const showNameToggle = document.getElementById('showNameToggle');
    const mirrorBtn = document.getElementById('mirrorBtn');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const tokenCanvas = document.getElementById('tokenCanvas');
    const ctx = tokenCanvas.getContext('2d');
    const scaleModeRadios = document.querySelectorAll('input[name="scaleMode"]');

    // Text controls
    const textColor = document.getElementById('textColor');
    const fontFamily = document.getElementById('fontFamily');
    const boldToggle = document.getElementById('boldToggle');
    const italicToggle = document.getElementById('italicToggle');

    // State
    let uploadedImage = null;
    let offsetX = 0;
    let offsetY = 0;
    let manualScale = 1;
    let isMirrored = false;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let currentScaleMode = 'fit';

    // Calculate "fit" scale
    function calculateFitScale(img) {
      const canvasSize = 200;
      const scaleX = canvasSize / img.width;
      const scaleY = canvasSize / img.height;
      return Math.min(scaleX, scaleY) * 0.95; // 95% —á—Ç–æ–±—ã –Ω–µ –∫–∞—Å–∞–ª–æ—Å—å –∫—Ä–∞—ë–≤
    }

    // Styled upload
    uploadArea.addEventListener('click', () => imageUpload.click());
    imageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadArea.innerHTML = `<i>‚úÖ</i><div>–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name.split('.').shift()}</div>`;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          offsetX = 0; offsetY = 0; isMirrored = false;
          manualScale = 1;
          currentScaleMode = 'fit';
          document.querySelector('input[name="scaleMode"][value="fit"]').checked = true;
          zoomSlider.value = 1;
          zoomValue.textContent = '–ê–≤—Ç–æ';
          charNameInput.value = '';
          showNameToggle.checked = true;
          textColor.value = '#ffffff';
          fontFamily.value = 'Arial';
          boldToggle.checked = false;
          italicToggle.checked = false;
          generateBtn.disabled = false;
          renderToken();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Scale mode toggle
    scaleModeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        currentScaleMode = radio.value;
        if (currentScaleMode === 'fit') {
          zoomSlider.disabled = true;
          zoomValue.textContent = '–ê–≤—Ç–æ';
        } else {
          zoomSlider.disabled = false;
          zoomValue.textContent = `${manualScale.toFixed(1)}√ó`;
        }
        renderToken();
      });
    });

    // Zoom slider
    zoomSlider.addEventListener('input', () => {
      manualScale = parseFloat(zoomSlider.value);
      if (currentScaleMode === 'manual') {
        zoomValue.textContent = `${manualScale.toFixed(1)}√ó`;
        renderToken();
      }
    });

    // Mirror
    mirrorBtn.addEventListener('click', () => {
      isMirrored = !isMirrored;
      renderToken();
    });

    // Drag
    tokenCanvas.addEventListener('mousedown', (e) => {
      if (!uploadedImage) return;
      isDragging = true;
      const rect = tokenCanvas.getBoundingClientRect();
      dragStartX = e.clientX - rect.left;
      dragStartY = e.clientY - rect.top;
      tokenCanvas.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging || !uploadedImage) return;
      const rect = tokenCanvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;
      offsetX += (currentX - dragStartX);
      offsetY += (currentY - dragStartY);
      dragStartX = currentX;
      dragStartY = currentY;
      renderToken();
    });

    window.addEventListener('mouseup', () => {
      isDragging = false;
      tokenCanvas.style.cursor = 'move';
    });

    // Render
    function renderToken() {
      if (!uploadedImage) return;

      ctx.clearRect(0, 0, tokenCanvas.width, tokenCanvas.height);

      // Circular mask
      ctx.save();
      ctx.beginPath();
      ctx.arc(100, 100, 100, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();

      // Determine scale
      let finalScale;
      if (currentScaleMode === 'fit') {
        finalScale = calculateFitScale(uploadedImage);
      } else {
        finalScale = manualScale;
      }

      // Image
      const img = uploadedImage;
      const scaledW = img.width * finalScale;
      const scaledH = img.height * finalScale;
      const x = 100 - scaledW / 2 + offsetX;
      const y = 100 - scaledH / 2 + offsetY;

      ctx.save();
      if (isMirrored) {
        ctx.translate(200, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(img, x, y, scaledW, scaledH);
      ctx.restore();
      ctx.restore();

      // Text
      if (showNameToggle.checked) {
        const name = charNameInput.value.trim() || '???';
        const color = textColor.value;
        const font = fontFamily.value;
        const bold = boldToggle.checked ? 'bold ' : '';
        const italic = italicToggle.checked ? 'italic ' : '';
        const fontSize = '18px';

        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 160, 200, 40);

        ctx.fillStyle = color;
        ctx.font = `${italic}${bold}${fontSize} ${font}`;
        ctx.textAlign = 'center';
        ctx.fillText(name, 100, 188);
      }

      downloadBtn.disabled = false;
    }

    // Real-time updates
    const textControls = [charNameInput, showNameToggle, textColor, fontFamily, boldToggle, italicToggle];
    textControls.forEach(el => el.addEventListener('input', renderToken));
    generateBtn.addEventListener('click', renderToken);

    // Download
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `${charNameInput.value.trim() || 'token'}.png`;
      link.href = tokenCanvas.toDataURL('image/png');
      link.click();
    });

    // Init UI
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const menuToggle = document.getElementById('menuToggle');

      if (menuToggle && sidebar && mainContent) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          mainContent.classList.toggle('sidebar-hidden');
        });

        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 576 && 
              !sidebar.classList.contains('hidden') && 
              !sidebar.contains(e.target) && 
              e.target !== menuToggle) {
            sidebar.classList.add('hidden');
            mainContent.classList.add('sidebar-hidden');
          }
        });
      }

      // Auth fallback
      setTimeout(() => {
        if (typeof initAuth !== 'function') {
          const user = JSON.parse(localStorage.getItem('kdUser'));
          const authBtn = document.getElementById('authButton');
          if (user) {
            document.getElementById('accountName').textContent = user.username;
            document.getElementById('accountRole').textContent = user.role === 'player' ? '–ò–≥—Ä–æ–∫' : '–ú–∞—Å—Ç–µ—Ä';
            document.getElementById('accountInfo').classList.add('active');
            authBtn.textContent = '–í—ã–π—Ç–∏';
            authBtn.onclick = () => {
              localStorage.removeItem('kdUser');
              location.reload();
            };
          }
        }
      }, 100);
    });
  </script>
</body>
</html>
