<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="tokenator.html">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Хранилище персонажей</h1>
      <p>Создавайте и управляйте своими героями</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
    </div>

    <div class="characters-grid" id="charactersGrid">
      <!-- Персонажи будут отображаться здесь -->
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <!-- Редактор персонажа -->
  <div class="character-editor" id="characterEditor">
    <div class="editor-content">
      <div class="editor-header">
        <h2 id="editorTitle">Создание персонажа</h2>
        <button class="btn btn-secondary" id="closeEditor">✕ Закрыть</button>
      </div>

      <form id="characterForm">
        <div class="char-sheet-grid">
          <!-- Левая колонка -->
          <div>
            <!-- Основная информация -->
            <div class="char-section">
              <h3>Основная информация</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="charName">Имя персонажа *</label>
                  <input type="text" id="charName" class="form-control" required placeholder="Арагорн">
                </div>
                <div class="form-group">
                  <label for="playerName">Имя игрока</label>
                  <input type="text" id="playerName" class="form-control" placeholder="Ваше имя">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="charRace">Раса *</label>
                  <select id="charRace" class="form-control" required>
                    <option value="">Выберите расу</option>
                    <option value="Человек">Человек</option>
                    <option value="Эльф">Эльф</option>
                    <option value="Дварф">Дварф</option>
                    <option value="Халфлинг">Халфлинг</option>
                    <option value="Гном">Гном</option>
                    <option value="Полуэльф">Полуэльф</option>
                    <option value="Полуорк">Полуорк</option>
                    <option value="Тифлинг">Тифлинг</option>
                    <option value="Драконорождённый">Драконорождённый</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="charClass">Класс *</label>
                  <select id="charClass" class="form-control" required>
                    <option value="">Выберите класс</option>
                    <option value="Воин">Воин</option>
                    <option value="Паладин">Паладин</option>
                    <option value="Варвар">Варвар</option>
                    <option value="Плут">Плут</option>
                    <option value="Следопыт">Следопыт</option>
                    <option value="Жрец">Жрец</option>
                    <option value="Друид">Друид</option>
                    <option value="Волшебник">Волшебник</option>
                    <option value="Чародей">Чародей</option>
                    <option value="Колдун">Колдун</option>
                    <option value="Бард">Бард</option>
                    <option value="Монах">Монах</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="charLevel">Уровень *</label>
                  <input type="number" id="charLevel" class="form-control" min="1" max="20" value="1" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="charBackground">Предыстория</label>
                  <select id="charBackground" class="form-control">
                    <option value="">Выберите предысторию</option>
                    <option value="Благородный">Благородный</option>
                    <option value="Бродяга">Бродяга</option>
                    <option value="Мудрец">Мудрец</option>
                    <option value="Герой">Герой</option>
                    <option value="Народный герой">Народный герой</option>
                    <option value="Отшельник">Отшельник</option>
                    <option value="Чужеземец">Чужеземец</option>
                    <option value="Преступник">Преступник</option>
                    <option value="Солдат">Солдат</option>
                    <option value="Шарлатан">Шарлатан</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="charAlignment">Мировоззрение</label>
                  <select id="charAlignment" class="form-control">
                    <option value="">Выберите мировоззрение</option>
                    <option value="Законно-доброе">Законно-доброе</option>
                    <option value="Законно-нейтральное">Законно-нейтральное</option>
                    <option value="Законно-злое">Законно-злое</option>
                    <option value="Нейтрально-доброе">Нейтрально-доброе</option>
                    <option value="Истинно-нейтральное">Истинно-нейтральное</option>
                    <option value="Нейтрально-злое">Нейтрально-злое</option>
                    <option value="Хаотично-доброе">Хаотично-доброе</option>
                    <option value="Хаотично-нейтральное">Хаотично-нейтральное</option>
                    <option value="Хаотично-злое">Хаотично-злое</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Характеристики -->
            <div class="char-section">
              <h3>Характеристики</h3>
              <div class="abilities-grid" id="abilitiesGrid">
                <!-- JavaScript заполнит это -->
              </div>
            </div>

            <!-- Боевые параметры -->
            <div class="char-section">
              <h3>Боевые параметры</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="hitDice">Кость хитов</label>
                  <input type="text" id="hitDice" class="form-control" placeholder="1d10">
                </div>
                <div class="form-group">
                  <label for="maxHP">Макс. HP *</label>
                  <input type="number" id="maxHP" class="form-control" min="1" value="10" required>
                </div>
                <div class="form-group">
                  <label for="currentHP">Текущие HP *</label>
                  <input type="number" id="currentHP" class="form-control" min="0" value="10" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="armorClass">Класс доспеха (КД) *</label>
                  <input type="number" id="armorClass" class="form-control" min="10" value="10" required>
                </div>
                <div class="form-group">
                  <label for="speed">Скорость *</label>
                  <input type="number" id="speed" class="form-control" min="0" value="30" required>
                </div>
                <div class="form-group">
                  <label for="initiative">Инициатива</label>
                  <input type="number" id="initiative" class="form-control" value="0">
                </div>
              </div>
            </div>
          </div>

          <!-- Правая колонка -->
          <div>
            <!-- Навыки -->
            <div class="char-section">
              <h3>Навыки</h3>
              <div class="skills-grid" id="skillsGrid">
                <!-- JavaScript заполнит это -->
              </div>
            </div>

            <!-- Владение инструментами и языки -->
            <div class="char-section">
              <h3>Владение инструментами и языки</h3>
              <div class="form-group-full">
                <textarea id="proficiencies" class="form-control" rows="3" placeholder="Владение оружием, инструментами, языки..."></textarea>
              </div>
            </div>

            <!-- Черты и особенности -->
            <div class="char-section">
              <h3>Черты и особенности</h3>
              <div class="form-group-full">
                <textarea id="features" class="form-control" rows="4" placeholder="Расовая черты, классовые особенности, умения..."></textarea>
              </div>
            </div>

            <!-- Снаряжение -->
            <div class="char-section">
              <h3>Снаряжение</h3>
              <div class="form-group-full">
                <textarea id="equipment" class="form-control" rows="4" placeholder="Оружие, доспехи, предметы, золото..."></textarea>
              </div>
            </div>

            <!-- Внешность и описание -->
            <div class="char-section">
              <h3>Внешность и описание</h3>
              <div class="form-group-full">
                <textarea id="appearance" class="form-control" rows="3" placeholder="Внешность, характер, история..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="editor-actions">
          <button type="button" class="btn export-btn" id="exportJson">Экспорт в JSON</button>
          <button type="button" class="btn btn-secondary" id="cancelEdit">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить персонажа</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // DOM элементы
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const menuToggle = document.getElementById('menuToggle');
    const newCharBtn = document.getElementById('newCharBtn');
    const charactersGrid = document.getElementById('charactersGrid');
    const characterEditor = document.getElementById('characterEditor');
    const characterForm = document.getElementById('characterForm');
    const closeEditor = document.getElementById('closeEditor');
    const cancelEdit = document.getElementById('cancelEdit');
    const exportJsonBtn = document.getElementById('exportJson');
    const editorTitle = document.getElementById('editorTitle');
    const abilitiesGrid = document.getElementById('abilitiesGrid');
    const skillsGrid = document.getElementById('skillsGrid');
    const accountInfo = document.getElementById('accountInfo');
    const accountName = document.getElementById('accountName');
    const accountRole = document.getElementById('accountRole');
    const authButton = document.getElementById('authButton');

    let currentCharacterId = null;
    let editingCharacter = null;

    // Данные для характеристик и навыков
    const abilities = [
      { id: 'str', name: 'Сила', short: 'СИЛ' },
      { id: 'dex', name: 'Ловкость', short: 'ЛОВ' },
      { id: 'con', name: 'Телосложение', short: 'ТЕЛ' },
      { id: 'int', name: 'Интеллект', short: 'ИНТ' },
      { id: 'wis', name: 'Мудрость', short: 'МДР' },
      { id: 'cha', name: 'Харизма', short: 'ХАР' }
    ];

    const skills = [
      { id: 'acrobatics', name: 'Акробатика', ability: 'dex' },
      { id: 'animal', name: 'Уход за животными', ability: 'wis' },
      { id: 'arcana', name: 'Магия', ability: 'int' },
      { id: 'athletics', name: 'Атлетика', ability: 'str' },
      { id: 'deception', name: 'Обман', ability: 'cha' },
      { id: 'history', name: 'История', ability: 'int' },
      { id: 'insight', name: 'Проницательность', ability: 'wis' },
      { id: 'intimidation', name: 'Запугивание', ability: 'cha' },
      { id: 'investigation', name: 'Расследование', ability: 'int' },
      { id: 'medicine', name: 'Медицина', ability: 'wis' },
      { id: 'nature', name: 'Природа', ability: 'int' },
      { id: 'perception', name: 'Внимательность', ability: 'wis' },
      { id: 'performance', name: 'Выступление', ability: 'cha' },
      { id: 'persuasion', name: 'Убеждение', ability: 'cha' },
      { id: 'religion', name: 'Религия', ability: 'int' },
      { id: 'sleight', name: 'Ловкость рук', ability: 'dex' },
      { id: 'stealth', name: 'Скрытность', ability: 'dex' },
      { id: 'survival', name: 'Выживание', ability: 'wis' }
    ];

    // =============== ОБЩИЕ ФУНКЦИИ ===============

    // Toggle sidebar
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
      mainContent.classList.toggle('sidebar-hidden');
    });

    // Close sidebar on mobile
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 576 && !sidebar.classList.contains('hidden') && 
          !sidebar.contains(e.target) && e.target !== menuToggle) {
        sidebar.classList.add('hidden');
        mainContent.classList.add('sidebar-hidden');
      }
    });

    // Система аутентификации
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('kdUser'));
      if (!user) {
        alert('Требуется регистрация для доступа к персонажам.');
        window.location.href = 'register.html';
        return false;
      }
      return true;
    }

    function updateAuthUI() {
      const user = JSON.parse(localStorage.getItem('kdUser'));
      if (user) {
        accountName.textContent = user.username;
        accountRole.textContent = user.role === 'player' ? 'Игрок' : 'Мастер';
        accountInfo.classList.add('active');
        authButton.textContent = 'Выйти';
        authButton.onclick = () => {
          localStorage.removeItem('kdUser');
          updateAuthUI();
          window.location.reload();
        };
      } else {
        accountInfo.classList.remove('active');
        authButton.textContent = 'Войти / Регистрация';
        authButton.onclick = () => window.location.href = 'register.html';
      }
    }

    // =============== СИСТЕМА ПЕРСОНАЖЕЙ ===============

    // Инициализация хранилища персонажей
    function initCharacters() {
      if (!localStorage.getItem('kdCharacters')) {
        localStorage.setItem('kdCharacters', JSON.stringify([]));
      }
    }

    // Получить персонажей пользователя
    function getUserCharacters() {
      const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      const user = JSON.parse(localStorage.getItem('kdUser'));
      return allChars.filter(char => char.owner === user.username);
    }

    // Сохранить персонажа
    function saveCharacter(charData) {
      const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      const user = JSON.parse(localStorage.getItem('kdUser'));
      
      if (currentCharacterId) {
        // Редактирование существующего персонажа
        const index = allChars.findIndex(char => char.id === currentCharacterId);
        if (index !== -1) {
          allChars[index] = { 
            ...charData, 
            id: currentCharacterId, 
            owner: user.username,
            updatedAt: new Date().toISOString()
          };
        }
      } else {
        // Создание нового персонажа
        charData.id = Date.now();
        charData.owner = user.username;
        charData.createdAt = new Date().toISOString();
        charData.updatedAt = new Date().toISOString();
        allChars.push(charData);
      }
      
      localStorage.setItem('kdCharacters', JSON.stringify(allChars));
      return charData.id;
    }

    // Удалить персонажа
    function deleteCharacter(id) {
      let allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      allChars = allChars.filter(char => char.id !== id);
      localStorage.setItem('kdCharacters', JSON.stringify(allChars));
      renderCharacters();
    }

    // Отобразить сетку персонажей
    function renderCharacters() {
      const chars = getUserCharacters();
      if (chars.length === 0) {
        charactersGrid.innerHTML = `
          <div class="empty-state">
            <p>У вас пока нет персонажей.</p>
            <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.8;">
              Нажмите «+ Новый персонаж», чтобы создать первого героя!
            </p>
          </div>
        `;
        return;
      }

      charactersGrid.innerHTML = chars.map(char => `
        <div class="char-card">
          <div class="char-avatar">${char.name.charAt(0)}</div>
          <div class="char-name">${char.name}</div>
          <div class="char-class-level">${char.class || '—'}, ${char.level || 1} ур.</div>
          <div class="char-details">
            Раса: ${char.race || '—'}<br>
            HP: ${char.currentHP || 0}/${char.maxHP || 0}<br>
            КД: ${char.armorClass || 0}
          </div>
          <div class="char-actions">
            <button class="char-btn edit-btn" data-id="${char.id}">Редактировать</button>
            <button class="char-btn delete-btn" data-id="${char.id}">Удалить</button>
          </div>
        </div>
      `).join('');

      // Добавить обработчики событий
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editCharacter(parseInt(btn.dataset.id)));
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Удалить персонажа? Это действие нельзя отменить.')) {
            deleteCharacter(parseInt(btn.dataset.id));
          }
        });
      });
    }

    // =============== РЕДАКТОР ПЕРСОНАЖА ===============

    // Открыть редактор персонажа
    function openCharacterEditor(character = null) {
      currentCharacterId = character ? character.id : null;
      editingCharacter = character;
      
      editorTitle.textContent = character ? 'Редактирование персонажа' : 'Создание персонажа';
      
      // Заполняем форму данными, если редактируем
      if (character) {
        document.getElementById('charName').value = character.name || '';
        document.getElementById('playerName').value = character.playerName || '';
        document.getElementById('charRace').value = character.race || '';
        document.getElementById('charClass').value = character.class || '';
        document.getElementById('charLevel').value = character.level || 1;
        document.getElementById('charBackground').value = character.background || '';
        document.getElementById('charAlignment').value = character.alignment || '';
        document.getElementById('hitDice').value = character.hitDice || '';
        document.getElementById('maxHP').value = character.maxHP || '';
        document.getElementById('currentHP').value = character.currentHP || '';
        document.getElementById('armorClass').value = character.armorClass || '';
        document.getElementById('speed').value = character.speed || '';
        document.getElementById('initiative').value = character.initiative || 0;
        document.getElementById('proficiencies').value = character.proficiencies || '';
        document.getElementById('features').value = character.features || '';
        document.getElementById('equipment').value = character.equipment || '';
        document.getElementById('appearance').value = character.appearance || '';
        
        // Заполняем характеристики
        abilities.forEach(ability => {
          const scoreInput = document.getElementById(`${ability.id}Score`);
          if (scoreInput && character.abilities && character.abilities[ability.id]) {
            scoreInput.value = character.abilities[ability.id].score || 10;
            updateAbilityModifier(ability.id);
          }
        });
        
        // Заполняем навыки
        skills.forEach(skill => {
          const skillCheckbox = document.getElementById(`${skill.id}Proficient`);
          if (skillCheckbox && character.skills) {
            skillCheckbox.checked = character.skills[skill.id] || false;
          }
        });
      } else {
        // Сброс формы для нового персонажа
        characterForm.reset();
        document.getElementById('charLevel').value = 1;
        document.getElementById('maxHP').value = 10;
        document.getElementById('currentHP').value = 10;
        document.getElementById('armorClass').value = 10;
        document.getElementById('speed').value = 30;
        
        // Устанавливаем характеристики по умолчанию
        abilities.forEach(ability => {
          const scoreInput = document.getElementById(`${ability.id}Score`);
          if (scoreInput) {
            scoreInput.value = 10;
            updateAbilityModifier(ability.id);
          }
        });
      }
      
      characterEditor.style.display = 'block';
    }

    // Редактировать персонажа
    function editCharacter(id) {
      const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      const character = allChars.find(char => char.id === id);
      if (character) {
        openCharacterEditor(character);
      }
    }

    // Закрыть редактор
    function closeCharacterEditor() {
      characterEditor.style.display = 'none';
      currentCharacterId = null;
      editingCharacter = null;
    }

    // Рассчитать модификатор характеристики
    function calculateModifier(score) {
      return Math.floor((score - 10) / 2);
    }

    // Обновить отображение модификатора
    function updateAbilityModifier(abilityId) {
      const score = parseInt(document.getElementById(`${abilityId}Score`).value) || 10;
      const modifier = calculateModifier(score);
      const modElement = document.getElementById(`${abilityId}Mod`);
      if (modElement) {
        modElement.textContent = modifier >= 0 ? `+${modifier}` : modifier.toString();
        modElement.style.background = modifier >= 0 ? 'var(--success)' : 'var(--error)';
      }
    }

    // Экспорт в JSON
    function exportToJson() {
      const formData = getFormData();
      const jsonString = JSON.stringify(formData, null, 2);
      
      // Создаем и скачиваем файл
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${formData.name || 'character'}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`Персонаж "${formData.name}" экспортирован в JSON файл!`);
    }

    // Получить данные формы
    function getFormData() {
      const abilitiesData = {};
      abilities.forEach(ability => {
        const score = parseInt(document.getElementById(`${ability.id}Score`).value) || 10;
        abilitiesData[ability.id] = {
          name: ability.name,
          score: score,
          modifier: calculateModifier(score)
        };
      });
      
      const skillsData = {};
      skills.forEach(skill => {
        skillsData[skill.id] = document.getElementById(`${skill.id}Proficient`).checked;
      });
      
      return {
        name: document.getElementById('charName').value,
        playerName: document.getElementById('playerName').value,
        race: document.getElementById('charRace').value,
        class: document.getElementById('charClass').value,
        level: parseInt(document.getElementById('charLevel').value) || 1,
        background: document.getElementById('charBackground').value,
        alignment: document.getElementById('charAlignment').value,
        abilities: abilitiesData,
        skills: skillsData,
        hitDice: document.getElementById('hitDice').value,
        maxHP: parseInt(document.getElementById('maxHP').value) || 0,
        currentHP: parseInt(document.getElementById('currentHP').value) || 0,
        armorClass: parseInt(document.getElementById('armorClass').value) || 0,
        speed: parseInt(document.getElementById('speed').value) || 0,
        initiative: parseInt(document.getElementById('initiative').value) || 0,
        proficiencies: document.getElementById('proficiencies').value,
        features: document.getElementById('features').value,
        equipment: document.getElementById('equipment').value,
        appearance: document.getElementById('appearance').value
      };
    }

    // Инициализация карточек характеристик
    function initAbilityCards() {
      abilitiesGrid.innerHTML = abilities.map(ability => `
        <div class="ability-card">
          <div class="ability-name">${ability.short}</div>
          <input type="number" id="${ability.id}Score" class="ability-score" 
                 min="1" max="30" value="10" 
                 onchange="updateAbilityModifier('${ability.id}')">
          <div class="ability-mod" id="${ability.id}Mod">+0</div>
        </div>
      `).join('');
    }

    // Инициализация сетки навыков
    function initSkillsGrid() {
      skillsGrid.innerHTML = skills.map(skill => {
        const ability = abilities.find(a => a.id === skill.ability);
        return `
          <div class="skill-item">
            <input type="checkbox" id="${skill.id}Proficient">
            <label for="${skill.id}Proficient">${skill.name} (${ability.short})</label>
          </div>
        `;
      }).join('');
    }

    // =============== ОБРАБОТЧИКИ СОБЫТИЙ ===============

    newCharBtn.addEventListener('click', () => {
      if (!checkAuth()) return;
      openCharacterEditor();
    });

    closeEditor.addEventListener('click', closeCharacterEditor);
    cancelEdit.addEventListener('click', closeCharacterEditor);

    characterForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Базовая валидация
      const charName = document.getElementById('charName').value.trim();
      const charRace = document.getElementById('charRace').value;
      const charClass = document.getElementById('charClass').value;
      
      if (!charName) {
        alert('Пожалуйста, введите имя персонажа');
        return;
      }
      if (!charRace) {
        alert('Пожалуйста, выберите расу');
        return;
      }
      if (!charClass) {
        alert('Пожалуйста, выберите класс');
        return;
      }
      
      const charData = getFormData();
      saveCharacter(charData);
      closeCharacterEditor();
      renderCharacters();
      
      alert(`Персонаж "${charData.name}" успешно ${currentCharacterId ? 'обновлен' : 'создан'}!`);
    });

    exportJsonBtn.addEventListener('click', exportToJson);

    // Закрытие редактора по клику вне области
    characterEditor.addEventListener('click', (e) => {
      if (e.target === characterEditor) {
        closeCharacterEditor();
      }
    });

    // =============== ИНИЦИАЛИЗАЦИЯ ===============

    function init() {
      updateAuthUI();
      
      if (checkAuth()) {
        initCharacters();
        initAbilityCards();
        initSkillsGrid();
        renderCharacters();
        
        // Инициализируем модификаторы
        abilities.forEach(ability => updateAbilityModifier(ability.id));
      }
    }

    // Запуск приложения
    init();
  </script>

</body>
</html>

