<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .character-sheet {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 1rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      margin: 1rem;
    }

    .character-header {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1rem;
      background: rgba(10, 8, 29, 0.8);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .hp-section {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
      background: rgba(10, 8, 29, 0.6);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .ability-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .center-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .right-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .ability-block {
      background: rgba(26, 20, 45, 0.8);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .ability-header {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .ability-score {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
      background: rgba(10, 8, 29, 0.7);
      border: 2px solid var(--primary-light);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text);
    }

    .ability-modifier {
      background: var(--primary);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .saving-throw, .skill {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(138, 43, 226, 0.2);
      font-size: 0.9rem;
    }

    .saving-throw label, .skill label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .proficiency-bonus {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(138, 43, 226, 0.2);
      border-radius: 8px;
    }

    .death-saves {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .death-save-group {
      text-align: center;
    }

    .death-save-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: var(--accent);
    }

    .death-save-circles {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    .death-save-circle {
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .death-save-circle.filled {
      background: var(--accent);
    }

    .weapons-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    .weapons-table th,
    .weapons-table td {
      border: 1px solid var(--primary);
      padding: 0.5rem;
      text-align: left;
    }

    .weapons-table th {
      background: rgba(138, 43, 226, 0.3);
      color: var(--accent);
      font-weight: bold;
    }

    .coins-section {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .coin-group {
      text-align: center;
    }

    .coin-group label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      color: var(--accent);
      font-weight: bold;
    }

    .portrait-section {
      text-align: center;
      margin: 1rem 0;
    }

    .portrait-placeholder {
      width: 150px;
      height: 200px;
      background: rgba(26, 20, 45, 0.6);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.3s ease;
    }

    .portrait-placeholder:hover {
      border-color: var(--accent);
      background: rgba(138, 43, 226, 0.2);
    }

    .portrait-preview {
      max-width: 150px;
      max-height: 200px;
      border-radius: 8px;
      display: none;
      border: 2px solid var(--primary);
    }

    .section-title {
      color: var(--accent);
      border-bottom: 1px solid var(--primary);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .text-area {
      width: 100%;
      min-height: 100px;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--text);
      padding: 0.5rem;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.25rem 0;
      font-size: 0.9rem;
    }

    .checkbox-group label {
      cursor: pointer;
    }

    .initiative-speed {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-group {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      background: rgba(10, 8, 29, 0.7);
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .shield-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .shield-bonus {
      width: 60px;
      text-align: center;
    }

    .hit-dice-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .spellbook-section {
      grid-column: 1 / -1;
      margin-top: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--accent);
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 0.5rem;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 1200px) {
      .character-sheet {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="tokenator.html">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Редактор персонажа D&D 5e</h1>
      <p>Полный лист персонажа в стиле Long Story Short</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
      <button class="btn btn-primary" id="saveCharBtn">Сохранить</button>
      <button class="btn export-btn" id="exportJsonBtn">Экспорт JSON</button>
    </div>

    <!-- Основной лист персонажа -->
    <div class="character-sheet" id="characterSheet">
      <!-- Верхняя часть - основная информация -->
      <div class="character-header">
        <div class="form-group">
          <label>Имя персонажа</label>
          <input type="text" id="charName" class="form-control" placeholder="Арагорн">
        </div>
        <div class="form-group">
          <label>Предыстория</label>
          <input type="text" id="charBackground" class="form-control" placeholder="Странник">
        </div>
        <div class="form-group">
          <label>Класс</label>
          <input type="text" id="charClass" class="form-control" placeholder="Воин">
        </div>
        <div class="form-group">
          <label>Раса</label>
          <input type="text" id="charRace" class="form-control" placeholder="Человек">
        </div>
        <div class="form-group">
          <label>Подкласс</label>
          <input type="text" id="charSubclass" class="form-control" placeholder="Паладин">
        </div>
        <div class="form-group">
          <label>Уровень</label>
          <input type="number" id="charLevel" class="form-control" value="1" min="1" max="20">
        </div>
        <div class="form-group">
          <label>Опыт</label>
          <input type="number" id="charExp" class="form-control" value="0">
        </div>
        <div class="form-group">
          <label>Класс защиты</label>
          <input type="number" id="armorClass" class="form-control" value="10">
        </div>
        <div class="form-group shield-toggle">
          <label>
            <input type="checkbox" id="shieldToggle"> Щит
          </label>
          <input type="number" id="shieldBonus" class="form-control shield-bonus" value="2" min="0" max="5">
        </div>
      </div>

      <!-- Блок хитов -->
      <div class="hp-section">
        <div class="form-group">
          <label>Текущие хиты</label>
          <input type="number" id="currentHP" class="form-control" value="10">
        </div>
        <div class="form-group">
          <label>Временные хиты</label>
          <input type="number" id="tempHP" class="form-control" value="0">
        </div>
        <div class="form-group">
          <label>Максимум хитов</label>
          <input type="number" id="maxHP" class="form-control" value="10">
        </div>
        <div class="form-group hit-dice-selector">
          <label>Кости хитов:</label>
          <select id="hitDiceType" class="form-control">
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10" selected>d10</option>
            <option value="d12">d12</option>
          </select>
          <input type="number" id="hitDiceCount" class="form-control" value="1" min="0" style="width: 60px;">
        </div>
        <div class="form-group">
          <label>Спасброски от смерти</label>
          <div class="death-saves">
            <div class="death-save-group">
              <label>Успехи</label>
              <div class="death-save-circles" id="successCircles">
                <div class="death-save-circle" data-index="0"></div>
                <div class="death-save-circle" data-index="1"></div>
                <div class="death-save-circle" data-index="2"></div>
              </div>
            </div>
            <div class="death-save-group">
              <label>Провалы</label>
              <div class="death-save-circles" id="failureCircles">
                <div class="death-save-circle" data-index="0"></div>
                <div class="death-save-circle" data-index="1"></div>
                <div class="death-save-circle" data-index="2"></div>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" id="rollDeathSave" style="margin-top: 0.5rem; width: 100%;">
            Бросок спасброска
          </button>
        </div>
      </div>

      <!-- Левая колонка - характеристики -->
      <div class="ability-column">
        <div class="proficiency-bonus">
          Бонус владения: <span id="proficiencyBonus">+2</span>
        </div>

        <!-- Сила -->
        <div class="ability-block">
          <div class="ability-header">СИЛА</div>
          <input type="number" id="strScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="strMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="strSave"> Спасбросок</label>
            <span id="strSaveMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="athletics"> Атлетика</label>
            <span id="athleticsMod">+0</span>
          </div>
        </div>

        <!-- Ловкость -->
        <div class="ability-block">
          <div class="ability-header">ЛОВКОСТЬ</div>
          <input type="number" id="dexScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="dexMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="dexSave"> Спасбросок</label>
            <span id="dexSaveMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="acrobatics"> Акробатика</label>
            <span id="acrobaticsMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="sleight"> Ловкость рук</label>
            <span id="sleightMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="stealth"> Скрытность</label>
            <span id="stealthMod">+0</span>
          </div>
        </div>

        <!-- Телосложение -->
        <div class="ability-block">
          <div class="ability-header">ТЕЛОСЛОЖЕНИЕ</div>
          <input type="number" id="conScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="conMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="conSave"> Спасбросок</label>
            <span id="conSaveMod">+0</span>
          </div>
        </div>

        <!-- Интеллект -->
        <div class="ability-block">
          <div class="ability-header">ИНТЕЛЛЕКТ</div>
          <input type="number" id="intScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="intMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="intSave"> Спасбросок</label>
            <span id="intSaveMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="investigation"> Анализ</label>
            <span id="investigationMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="history"> История</label>
            <span id="historyMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="arcana"> Магия</label>
            <span id="arcanaMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="nature"> Природа</label>
            <span id="natureMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="religion"> Религия</label>
            <span id="religionMod">+0</span>
          </div>
        </div>

        <!-- Мудрость -->
        <div class="ability-block">
          <div class="ability-header">МУДРОСТЬ</div>
          <input type="number" id="wisScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="wisMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="wisSave"> Спасбросок</label>
            <span id="wisSaveMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="perception"> Внимательность</label>
            <span id="perceptionMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="survival"> Выживание</label>
            <span id="survivalMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="medicine"> Медицина</label>
            <span id="medicineMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="insight"> Проницательность</label>
            <span id="insightMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="animal"> Уход за животными</label>
            <span id="animalMod">+0</span>
          </div>
        </div>

        <!-- Харизма -->
        <div class="ability-block">
          <div class="ability-header">ХАРИЗМА</div>
          <input type="number" id="chaScore" class="ability-score" value="10" min="1" max="30">
          <div class="ability-modifier" id="chaMod">+0</div>
          <div class="saving-throw">
            <label><input type="checkbox" id="chaSave"> Спасбросок</label>
            <span id="chaSaveMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="performance"> Выступление</label>
            <span id="performanceMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="intimidation"> Запугивание</label>
            <span id="intimidationMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="deception"> Обман</label>
            <span id="deceptionMod">+0</span>
          </div>
          <div class="skill">
            <label><input type="checkbox" id="persuasion"> Убеждение</label>
            <span id="persuasionMod">+0</span>
          </div>
        </div>

        <!-- Инициатива и скорость -->
        <div class="ability-block">
          <div class="initiative-speed">
            <div class="stat-group">
              <div class="ability-header">ИНИЦИАТИВА</div>
              <div class="stat-value" id="initiativeValue">+0</div>
            </div>
            <div class="stat-group">
              <div class="ability-header">СКОРОСТЬ</div>
              <input type="number" id="speedValue" class="form-control" value="30" style="text-align: center;">
            </div>
          </div>
          <div class="stat-group" style="margin-top: 1rem;">
            <div class="ability-header">ПАССИВНОЕ ВОСПРИЯТИЕ</div>
            <div class="stat-value" id="passivePerceptionValue">10</div>
          </div>
        </div>
      </div>

      <!-- Центральная колонка -->
      <div class="center-column">
        <div class="ability-block">
          <div class="section-title">СОСТОЯНИЯ</div>
          <textarea id="conditions" class="text-area" placeholder="Состояния персонажа..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">ОРУЖИЕ И БОЕВЫЕ ЗАГОВОРЫ</div>
          <table class="weapons-table">
            <thead>
              <tr>
                <th>Название</th>
                <th>Бонус / Сложность</th>
                <th>Урон / Вид</th>
                <th>Заметки</th>
              </tr>
            </thead>
            <tbody id="weaponsTableBody">
              <tr>
                <td><input type="text" class="form-control" placeholder="Длинный меч"></td>
                <td><input type="text" class="form-control" placeholder="+5"></td>
                <td><input type="text" class="form-control" placeholder="1d8 рубящий"></td>
                <td><input type="text" class="form-control" placeholder=""></td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn btn-secondary" id="addWeapon" style="margin-top: 0.5rem; width: 100%;">
            + Добавить оружие
          </button>
        </div>

        <div class="ability-block">
          <div class="section-title">СПОСОБНОСТИ КЛАССА</div>
          <textarea id="classAbilities" class="text-area" placeholder="Способности класса..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">СПОСОБНОСТИ РАСЫ</div>
          <textarea id="raceAbilities" class="text-area" placeholder="Способности расы..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">ЧЕРТЫ</div>
          <textarea id="features" class="text-area" placeholder="Черты персонажа..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">ЗАМЕТКИ</div>
          <textarea id="notes" class="text-area" placeholder="Заметки..."></textarea>
        </div>
      </div>

      <!-- Правая колонка -->
      <div class="right-column">
        <div class="ability-block">
          <div class="section-title">ВЛАДЕНИЕ СНАРЯЖЕНИЕМ И УМЕНИЯ</div>
          
          <div style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--accent);">ДОСПЕХИ</div>
            <div class="checkbox-group">
              <input type="checkbox" id="lightArmor">
              <label for="lightArmor">Лёгкие</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="mediumArmor">
              <label for="mediumArmor">Средние</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="heavyArmor">
              <label for="heavyArmor">Тяжёлые</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="shieldProficiency">
              <label for="shieldProficiency">Щит</label>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--accent);">ОРУЖИЕ</div>
            <div class="checkbox-group">
              <input type="checkbox" id="simpleWeapons">
              <label for="simpleWeapons">Простое</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="martialWeapons">
              <label for="martialWeapons">Воинское</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="otherWeapons">
              <label for="otherWeapons">Другое</label>
            </div>
          </div>

          <div>
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--accent);">ВЛАДЕНИЕ ИНСТРУМЕНТАМИ И ЯЗЫКИ</div>
            <textarea id="toolProficiencies" class="text-area" placeholder="Инструменты и языки..."></textarea>
          </div>
        </div>

        <div class="ability-block">
          <div class="section-title">ПОРТРЕТ</div>
          <div class="portrait-section">
            <div class="portrait-placeholder" id="portraitPlaceholder">
              Нажмите для загрузки изображения
            </div>
            <img id="portraitPreview" class="portrait-preview" alt="Портрет персонажа">
            <input type="file" id="portraitUpload" accept="image/*" style="display: none;">
          </div>
        </div>

        <div class="ability-block">
          <div class="section-title">ЦЕЛИ И ЗАДАЧИ</div>
          <textarea id="goals" class="text-area" placeholder="Цели и задачи персонажа..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">ВНЕШНОСТЬ</div>
          <textarea id="appearance" class="text-area" placeholder="Описание внешности..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">ПРЕДЫСТОРИЯ И ЛИЧНЫЕ КАЧЕСТВА</div>
          <textarea id="personality" class="text-area" placeholder="Личные качества и предыстория..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">СНАРЯЖЕНИЕ</div>
          <textarea id="equipment" class="text-area" placeholder="Снаряжение персонажа..."></textarea>
        </div>

        <div class="ability-block">
          <div class="section-title">МОНЕТЫ</div>
          <div class="coins-section">
            <div class="coin-group">
              <label>ММ</label>
              <input type="number" id="cp" class="form-control" value="0" min="0">
            </div>
            <div class="coin-group">
              <label>СМ</label>
              <input type="number" id="sp" class="form-control" value="0" min="0">
            </div>
            <div class="coin-group">
              <label>ЗМ</label>
              <input type="number" id="gp" class="form-control" value="0" min="0">
            </div>
            <div class="coin-group">
              <label>ЭМ</label>
              <input type="number" id="ep" class="form-control" value="0" min="0">
            </div>
            <div class="coin-group">
              <label>ПМ</label>
              <input type="number" id="pp" class="form-control" value="0" min="0">
            </div>
          </div>
        </div>
      </div>

      <!-- Книга заклинаний -->
      <div class="spellbook-section">
        <div class="ability-block">
          <div class="section-title">КНИГА ЗАКЛИНАНИЙ</div>
          <textarea id="spellbook" class="text-area" placeholder="Заклинания персонажа..." style="min-height: 200px;"></textarea>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <script>
    // Полный функциональный код редактора персонажей
    document.addEventListener('DOMContentLoaded', function() {
      // Инициализация всех функций редактора
      initCharacterSheet();
    });

    function initCharacterSheet() {
      // Инициализация всех обработчиков событий и расчетов
      initAbilityScores();
      initSkills();
      initDeathSaves();
      initWeapons();
      initPortrait();
      initCalculations();
      initEventListeners();
    }

    function initAbilityScores() {
      const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
      abilities.forEach(ability => {
        const scoreInput = document.getElementById(`${ability}Score`);
        if (scoreInput) {
          scoreInput.addEventListener('input', () => updateAbilityModifier(ability));
        }
      });
    }

    function updateAbilityModifier(abilityId) {
      const score = parseInt(document.getElementById(`${abilityId}Score`).value) || 10;
      const modifier = Math.floor((score - 10) / 2);
      const modElement = document.getElementById(`${abilityId}Mod`);
      
      if (modElement) {
        modElement.textContent = modifier >= 0 ? `+${modifier}` : modifier.toString();
      }
      
      updateSkills(abilityId);
      updateCalculations();
    }

    function initSkills() {
      const skills = {
        str: ['athletics'],
        dex: ['acrobatics', 'sleight', 'stealth'],
        int: ['investigation', 'history', 'arcana', 'nature', 'religion'],
        wis: ['perception', 'survival', 'medicine', 'insight', 'animal'],
        cha: ['performance', 'intimidation', 'deception', 'persuasion']
      };

      Object.entries(skills).forEach(([ability, skillList]) => {
        skillList.forEach(skill => {
          const checkbox = document.getElementById(skill);
          if (checkbox) {
            checkbox.addEventListener('change', () => updateSkillModifier(skill, ability));
          }
        });
      });
    }

    function updateSkills(abilityId) {
      const skills = {
        str: ['athletics'],
        dex: ['acrobatics', 'sleight', 'stealth'],
        int: ['investigation', 'history', 'arcana', 'nature', 'religion'],
        wis: ['perception', 'survival', 'medicine', 'insight', 'animal'],
        cha: ['performance', 'intimidation', 'deception', 'persuasion']
      };

      if (skills[abilityId]) {
        skills[abilityId].forEach(skill => {
          updateSkillModifier(skill, abilityId);
        });
      }
    }

    function updateSkillModifier(skill, ability) {
      const abilityScore = parseInt(document.getElementById(`${ability}Score`).value) || 10;
      const abilityMod = Math.floor((abilityScore - 10) / 2);
      const isProficient = document.getElementById(skill).checked;
      const proficiencyBonus = 2; // Можно сделать динамическим
      const totalMod = abilityMod + (isProficient ? proficiencyBonus : 0);
      
      const modElement = document.getElementById(`${skill}Mod`);
      if (modElement) {
        modElement.textContent = totalMod >= 0 ? `+${totalMod}` : totalMod.toString();
      }
    }

    function initDeathSaves() {
      const rollButton = document.getElementById('rollDeathSave');
      if (rollButton) {
        rollButton.addEventListener('click', rollDeathSave);
      }

      // Обработчики для кружков
      document.querySelectorAll('.death-save-circle').forEach(circle => {
        circle.addEventListener('click', function() {
          this.classList.toggle('filled');
        });
      });
    }

    function rollDeathSave() {
      const roll = Math.floor(Math.random() * 20) + 1;
      alert(`Бросок спасброска от смерти: ${roll}`);
      
      if (roll === 1) {
        addDeathFailure();
        addDeathFailure();
      } else if (roll < 10) {
        addDeathFailure();
      } else if (roll === 20) {
        alert('Критический успех! Персонаж восстанавливает 1 хит!');
        resetDeathSaves();
        document.getElementById('currentHP').value = 1;
      } else {
        addDeathSuccess();
      }
      
      checkDeathSaves();
    }

    function addDeathSuccess() {
      const circles = document.querySelectorAll('#successCircles .death-save-circle');
      for (let circle of circles) {
        if (!circle.classList.contains('filled')) {
          circle.classList.add('filled');
          break;
        }
      }
    }

    function addDeathFailure() {
      const circles = document.querySelectorAll('#failureCircles .death-save-circle');
      for (let circle of circles) {
        if (!circle.classList.contains('filled')) {
          circle.classList.add('filled');
          break;
        }
      }
    }

    function resetDeathSaves() {
      document.querySelectorAll('.death-save-circle').forEach(circle => {
        circle.classList.remove('filled');
      });
    }

    function checkDeathSaves() {
      const successCount = document.querySelectorAll('#successCircles .death-save-circle.filled').length;
      const failureCount = document.querySelectorAll('#failureCircles .death-save-circle.filled').length;
      
      if (successCount >= 3) {
        alert('Три успешных спасброска! Персонаж стабилизирован.');
        resetDeathSaves();
      } else if (failureCount >= 3) {
        alert('Три провальных спасброска! Персонаж умирает.');
        resetDeathSaves();
      }
    }

    function initWeapons() {
      const addButton = document.getElementById('addWeapon');
      if (addButton) {
        addButton.addEventListener('click', addWeaponRow);
      }
    }

    function addWeaponRow() {
      const tbody = document.getElementById('weaponsTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" class="form-control" placeholder="Название оружия"></td>
        <td><input type="text" class="form-control" placeholder="Бонус атаки"></td>
        <td><input type="text" class="form-control" placeholder="Урон и тип"></td>
        <td><input type="text" class="form-control" placeholder="Заметки"></td>
      `;
      tbody.appendChild(newRow);
    }

    function initPortrait() {
      const placeholder = document.getElementById('portraitPlaceholder');
      const upload = document.getElementById('portraitUpload');
      
      if (placeholder && upload) {
        placeholder.addEventListener('click', () => upload.click());
        upload.addEventListener('change', handlePortraitUpload);
      }
    }

    function handlePortraitUpload(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('portraitPreview');
          const placeholder = document.getElementById('portraitPlaceholder');
          
          preview.src = e.target.result;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }

    function initCalculations() {
      // Обновляем инициативу (модификатор ловкости)
      const dexScore = parseInt(document.getElementById('dexScore').value) || 10;
      const dexMod = Math.floor((dexScore - 10) / 2);
      document.getElementById('initiativeValue').textContent = dexMod >= 0 ? `+${dexMod}` : dexMod.toString();
      
      // Обновляем пассивное восприятие
      updatePassivePerception();
      
      // Обновляем класс защиты с учетом щита
      updateArmorClass();
    }

    function updatePassivePerception() {
      const wisScore = parseInt(document.getElementById('wisScore').value) || 10;
      const wisMod = Math.floor((wisScore - 10) / 2);
      const perceptionProficient = document.getElementById('perception').checked;
      const proficiencyBonus = 2;
      const passivePerception = 10 + wisMod + (perceptionProficient ? proficiencyBonus : 0);
      document.getElementById('passivePerceptionValue').textContent = passivePerception;
    }

    function updateArmorClass() {
      const baseAC = parseInt(document.getElementById('armorClass').value) || 10;
      const shieldActive = document.getElementById('shieldToggle').checked;
      const shieldBonus = shieldActive ? parseInt(document.getElementById('shieldBonus').value) || 0 : 0;
      document.getElementById('armorClass').value = baseAC + shieldBonus;
    }

    function initEventListeners() {
      // Обработчики для обновления расчетов
      document.getElementById('dexScore').addEventListener('input', () => {
        const dexScore = parseInt(document.getElementById('dexScore').value) || 10;
        const dexMod = Math.floor((dexScore - 10) / 2);
        document.getElementById('initiativeValue').textContent = dexMod >= 0 ? `+${dexMod}` : dexMod.toString();
      });

      document.getElementById('wisScore').addEventListener('input', updatePassivePerception);
      document.getElementById('perception').addEventListener('change', updatePassivePerception);
      
      document.getElementById('shieldToggle').addEventListener('change', updateArmorClass);
      document.getElementById('shieldBonus').addEventListener('input', updateArmorClass);

      // Кнопки управления
      document.getElementById('saveCharBtn').addEventListener('click', saveCharacter);
      document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
      document.getElementById('newCharBtn').addEventListener('click', createNewCharacter);
    }

    function saveCharacter() {
      const characterData = getCharacterData();
      localStorage.setItem('currentCharacter', JSON.stringify(characterData));
      alert('Персонаж сохранен!');
    }

    function exportToJson() {
      const characterData = getCharacterData();
      const jsonString = JSON.stringify(characterData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${characterData.name || 'character'}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function createNewCharacter() {
      if (confirm('Создать нового персонажа? Текущие данные будут потеряны.')) {
        document.getElementById('characterForm').reset();
        resetDeathSaves();
        document.getElementById('portraitPreview').style.display = 'none';
        document.getElementById('portraitPlaceholder').style.display = 'block';
        
        // Сброс характеристик к значениям по умолчанию
        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        abilities.forEach(ability => {
          document.getElementById(`${ability}Score`).value = 10;
          updateAbilityModifier(ability);
        });
        
        initCalculations();
      }
    }

    function getCharacterData() {
      // Собираем все данные персонажа
      return {
        name: document.getElementById('charName').value,
        class: document.getElementById('charClass').value,
        race: document.getElementById('charRace').value,
        level: parseInt(document.getElementById('charLevel').value) || 1,
        // ... и так далее для всех полей
      };
    }

    // Инициализация при загрузке
    initCharacterSheet();
  </script>
</body>
</html>
