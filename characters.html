<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div style="font-weight: 700;">K&D</div>
    </header>

    <div class="page-header">
      <h1>Хранилище персонажей</h1>
      <p>Создавайте и управляйте своими героями</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
    </div>

    <!-- Двухпанельный макет -->
    <div class="characters-layout">
      <div class="characters-list" id="charactersList">
        <!-- Список персонажей -->
      </div>
      <div class="character-detail-panel" id="characterDetailPanel">
        <div id="detailContent" class="detail-content hidden">
          <div class="detail-header">
            <div class="char-avatar" id="detailAvatar">?</div>
            <h2 id="detailName">—</h2>
            <div id="detailClassLevel" class="char-class-level">—</div>
          </div>

          <div class="detail-section">
            <h3>Основная информация</h3>
            <div class="detail-grid">
              <div><strong>Раса:</strong> <span id="detailRace">—</span></div>
              <div><strong>Мир:</strong> <span id="detailWorld">—</span></div>
              <div><strong>HP:</strong> <span id="detailHP">—</span></div>
              <div><strong>Уровень:</strong> <span id="detailLevel">—</span></div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Характеристики</h3>
            <div class="detail-grid abilities-grid">
              <div><strong>СИЛ:</strong> <span id="detailSTR">—</span></div>
              <div><strong>ЛОВ:</strong> <span id="detailDEX">—</span></div>
              <div><strong>ТЕЛ:</strong> <span id="detailCON">—</span></div>
              <div><strong>ИНТ:</strong> <span id="detailINT">—</span></div>
              <div><strong>МУД:</strong> <span id="detailWIS">—</span></div>
              <div><strong>ХАР:</strong> <span id="detailCHA">—</span></div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Описание</h3>
            <p id="detailBackstory" class="backstory-text">—</p>
          </div>

          <div class="char-actions">
            <button class="char-btn edit-btn">Редактировать</button>
            <button class="char-btn delete-btn" id="deleteCurrentChar">Удалить</button>
          </div>
        </div>

        <div id="emptyDetail" class="empty-detail">
          <p>Выберите персонажа слева, чтобы посмотреть его лист.</p>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <!-- Модальное окно создания персонажа -->
  <div id="charModal" class="modal hidden">
    <div class="modal-content">
      <h2>Создать персонажа</h2>
      <form id="charForm">
        <div class="form-group">
          <label>Имя</label>
          <input type="text" name="name" class="form-control" required minlength="1" placeholder="Напр., Элиандра">
        </div>
        <div class="form-group">
          <label>Раса</label>
          <input type="text" name="race" class="form-control" value="Человек" required placeholder="Эльф, Дварф...">
        </div>
        <div class="form-group">
          <label>Класс</label>
          <input type="text" name="class" class="form-control" value="Воин" required placeholder="Волшебник, Плут...">
        </div>
        <div class="form-group">
          <label>Уровень</label>
          <input type="number" name="level" class="form-control" min="1" max="20" value="1" required>
        </div>
        <div class="form-group">
          <label>Очки жизни (HP)</label>
          <input type="number" name="hp" class="form-control" min="1" value="10" required>
        </div>
        <div class="form-group">
          <label>Мир (опционально)</label>
          <input type="text" name="world" class="form-control" placeholder="Фаэрун, Казана...">
        </div>

        <h3>Характеристики</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Сила (STR)</label>
            <input type="number" name="str" class="form-control" min="1" max="30" value="10">
          </div>
          <div class="form-group">
            <label>Ловкость (DEX)</label>
            <input type="number" name="dex" class="form-control" min="1" max="30" value="10">
          </div>
          <div class="form-group">
            <label>Телосложение (CON)</label>
            <input type="number" name="con" class="form-control" min="1" max="30" value="10">
          </div>
          <div class="form-group">
            <label>Интеллект (INT)</label>
            <input type="number" name="int" class="form-control" min="1" max="30" value="10">
          </div>
          <div class="form-group">
            <label>Мудрость (WIS)</label>
            <input type="number" name="wis" class="form-control" min="1" max="30" value="10">
          </div>
          <div class="form-group">
            <label>Харизма (CHA)</label>
            <input type="number" name="cha" class="form-control" min="1" max="30" value="10">
          </div>
        </div>

        <div id="charMessage" class="message"></div>

        <div class="modal-buttons">
          <button type="submit" class="submit-btn">Создать персонажа</button>
          <button type="button" id="cancelCharBtn" class="btn btn-secondary">Отмена</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // DOM элементы
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const menuToggle = document.getElementById('menuToggle');
    const newCharBtn = document.getElementById('newCharBtn');
    const charactersList = document.getElementById('charactersList');
    const charModal = document.getElementById('charModal');
    const charForm = document.getElementById('charForm');
    const cancelCharBtn = document.getElementById('cancelCharBtn');
    const charMessage = document.getElementById('charMessage');
    const detailContent = document.getElementById('detailContent');
    const emptyDetail = document.getElementById('emptyDetail');
    const deleteCurrentChar = document.getElementById('deleteCurrentChar');

    let selectedCharacter = null;

    // Toggle sidebar
    if (menuToggle && sidebar && mainContent) {
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('sidebar-hidden');
      });
    }

    // Close sidebar on mobile
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 576 && sidebar && !sidebar.classList.contains('hidden') && 
          !sidebar.contains(e.target) && e.target !== menuToggle) {
        sidebar.classList.add('hidden');
        mainContent?.classList.add('sidebar-hidden');
      }
    });

    // Auth check
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('kdUser'));
      if (!user) {
        alert('Требуется регистрация для доступа к персонажам.');
        window.location.href = 'register.html';
        return false;
      }
      return true;
    }

    // Init characters storage
    function initCharacters() {
      if (!localStorage.getItem('kdCharacters')) {
        localStorage.setItem('kdCharacters', JSON.stringify([]));
      }
    }

    // Get user's characters
    function getUserCharacters() {
      const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      const user = JSON.parse(localStorage.getItem('kdUser'));
      return allChars.filter(char => char.owner === user.username);
    }

    // Save character
    function saveCharacterToStorage(char) {
      const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      allChars.push(char);
      localStorage.setItem('kdCharacters', JSON.stringify(allChars));
    }

    // Delete character
    function deleteCharacter(id) {
      let allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      allChars = allChars.filter(char => char.id !== id);
      localStorage.setItem('kdCharacters', JSON.stringify(allChars));
      renderCharacters();
      if (selectedCharacter && selectedCharacter.id === id) {
        clearDetailPanel();
      }
    }

    // Clear detail panel
    function clearDetailPanel() {
      selectedCharacter = null;
      emptyDetail.classList.remove('hidden');
      detailContent.classList.add('hidden');
    }

    // Render characters list
    function renderCharacters() {
      const chars = getUserCharacters();
      if (chars.length === 0) {
        charactersList.innerHTML = `
          <div class="empty-state">
            <p>У вас пока нет персонажей.</p>
            <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.8;">
              Нажмите «+ Новый персонаж», чтобы создать первого героя!
            </p>
          </div>
        `;
        return;
      }

      const displayChars = chars.slice(0, 20);
      charactersList.innerHTML = displayChars.map(char => `
        <div class="char-card" data-id="${char.id}">
          <div class="char-avatar">${char.name.charAt(0)}</div>
          <div class="char-name">${char.name}</div>
          <div class="char-class-level">${char.class}, ${char.level} ур.</div>
        </div>
      `).join('');

      document.querySelectorAll('.char-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = parseInt(card.dataset.id);
          selectedCharacter = getUserCharacters().find(c => c.id === id);
          showCharacterDetail(selectedCharacter);
        });
      });
    }

    // Show character detail
    function showCharacterDetail(char) {
      if (!char) return;
      document.getElementById('detailAvatar').textContent = char.name.charAt(0);
      document.getElementById('detailName').textContent = char.name;
      document.getElementById('detailClassLevel').textContent = `${char.class}, ${char.level} ур.`;
      document.getElementById('detailRace').textContent = char.race;
      document.getElementById('detailWorld').textContent = char.world || '—';
      document.getElementById('detailHP').textContent = char.hp;
      document.getElementById('detailLevel').textContent = char.level;
      document.getElementById('detailSTR').textContent = char.abilities.str;
      document.getElementById('detailDEX').textContent = char.abilities.dex;
      document.getElementById('detailCON').textContent = char.abilities.con;
      document.getElementById('detailINT').textContent = char.abilities.int;
      document.getElementById('detailWIS').textContent = char.abilities.wis;
      document.getElementById('detailCHA').textContent = char.abilities.cha;
      document.getElementById('detailBackstory').textContent = char.backstory || 'Без описания...';
      deleteCurrentChar.dataset.id = char.id;

      emptyDetail.classList.add('hidden');
      detailContent.classList.remove('hidden');
    }

    // Modal handlers
    if (newCharBtn) {
      newCharBtn.addEventListener('click', () => {
        if (!checkAuth()) return;
        if (charMessage) {
          charMessage.className = 'message';
          charMessage.textContent = '';
        }
        if (charForm) {
          charForm.reset();
          charForm.querySelector('[name="race"]').value = 'Человек';
          charForm.querySelector('[name="class"]').value = 'Воин';
          charForm.querySelector('[name="level"]').value = '1';
          charForm.querySelector('[name="hp"]').value = '10';
          ['str','dex','con','int','wis','cha'].forEach(stat => {
            charForm.querySelector(`[name="${stat}"]`).value = '10';
          });
        }
        charModal.classList.remove('hidden');
      });
    }

    if (cancelCharBtn && charModal) {
      cancelCharBtn.addEventListener('click', () => {
        charModal.classList.add('hidden');
      });

      charModal.addEventListener('click', (e) => {
        if (e.target === charModal) {
          charModal.classList.add('hidden');
        }
      });
    }

    if (charForm) {
      charForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = JSON.parse(localStorage.getItem('kdUser'));
        const formData = new FormData(charForm);

        const character = {
          id: Date.now(),
          owner: user.username,
          name: formData.get('name'),
          race: formData.get('race'),
          class: formData.get('class'),
          level: parseInt(formData.get('level')),
          hp: parseInt(formData.get('hp')),
          world: formData.get('world') || null,
          abilities: {
            str: parseInt(formData.get('str')) || 10,
            dex: parseInt(formData.get('dex')) || 10,
            con: parseInt(formData.get('con')) || 10,
            int: parseInt(formData.get('int')) || 10,
            wis: parseInt(formData.get('wis')) || 10,
            cha: parseInt(formData.get('cha')) || 10
          },
          backstory: '',
          createdAt: new Date().toISOString()
        };

        saveCharacterToStorage(character);
        if (charMessage) {
          charMessage.textContent = '✅ Персонаж успешно создан!';
          charMessage.className = 'message success';
        }

        setTimeout(() => {
          charModal.classList.add('hidden');
          renderCharacters();
          selectedCharacter = character;
          showCharacterDetail(character);
        }, 800);
      });
    }

    if (deleteCurrentChar) {
      deleteCurrentChar.addEventListener('click', () => {
        if (!selectedCharacter) return;
        if (confirm('Удалить персонажа? Это действие нельзя отменить.')) {
          deleteCharacter(selectedCharacter.id);
        }
      });
    }

    // Initialize
    if (checkAuth()) {
      initCharacters();
      renderCharacters();
    }
  <script>
  // === НАСТРОЙКИ ===
  const REQUIRE_AUTH = true; // ← измените на false, чтобы отключить проверку входа

  // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
  function log(...args) {
    console.log('[K&D]', ...args);
  }

  function checkAuth() {
    if (!REQUIRE_AUTH) return true;
    try {
      const user = JSON.parse(localStorage.getItem('kdUser'));
      if (user && user.username) {
        log('Пользователь авторизован:', user.username);
        return true;
      }
    } catch (e) {
      log('Ошибка при чтении kdUser из localStorage');
    }
    alert('Требуется регистрация для доступа к персонажам.');
    window.location.href = 'register.html';
    return false;
  }

  function initStorage() {
    if (!localStorage.getItem('kdCharacters')) {
      localStorage.setItem('kdCharacters', '[]');
      log('Создано пустое хранилище персонажей');
    }
  }

  function getUserCharacters() {
    try {
      const all = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      const user = JSON.parse(localStorage.getItem('kdUser') || '{}');
      return all.filter(c => c.owner === user.username);
    } catch (e) {
      log('Ошибка при загрузке персонажей:', e);
      return [];
    }
  }

  function saveCharacter(char) {
    try {
      const all = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      all.push(char);
      localStorage.setItem('kdCharacters', JSON.stringify(all));
      log('Персонаж сохранён:', char.name);
    } catch (e) {
      log('Ошибка сохранения персонажа:', e);
      alert('Не удалось сохранить персонажа. Проверьте консоль (F12).');
    }
  }

  function deleteCharacter(id) {
    try {
      let all = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
      all = all.filter(c => c.id !== id);
      localStorage.setItem('kdCharacters', JSON.stringify(all));
      renderCharacters();
      clearDetailPanel();
      log('Персонаж удалён:', id);
    } catch (e) {
      log('Ошибка удаления персонажа:', e);
    }
  }

  // === DOM ЭЛЕМЕНТЫ ===
  const newCharBtn = document.getElementById('newCharBtn');
  const charModal = document.getElementById('charModal');
  const charForm = document.getElementById('charForm');
  const cancelCharBtn = document.getElementById('cancelCharBtn');
  const charMessage = document.getElementById('charMessage');
  const charactersList = document.getElementById('charactersList');
  const detailContent = document.getElementById('detailContent');
  const emptyDetail = document.getElementById('emptyDetail');
  const deleteCurrentChar = document.getElementById('deleteCurrentChar');

  let selectedCharacter = null;

  // === МОДАЛЬНОЕ ОКНО ===
  function openModal() {
    log('Открытие модального окна');
    if (charMessage) charMessage.className = 'message';
    if (charForm) charForm.reset();
    if (charForm) {
      const defaults = { race: 'Человек', class: 'Воин', level: '1', hp: '10' };
      for (const [name, value] of Object.entries(defaults)) {
        const el = charForm.querySelector(`[name="${name}"]`);
        if (el) el.value = value;
      }
      ['str','dex','con','int','wis','cha'].forEach(stat => {
        const el = charForm.querySelector(`[name="${stat}"]`);
        if (el) el.value = '10';
      });
    }
    if (charModal) charModal.classList.remove('hidden');
  }

  function closeModal() {
    if (charModal) charModal.classList.add('hidden');
  }

  // === ОТОБРАЖЕНИЕ ===
  function renderCharacters() {
    const chars = getUserCharacters();
    if (!charactersList) return;

    if (chars.length === 0) {
      charactersList.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1;text-align:center;padding:2rem;">
          <p>У вас пока нет персонажей.</p>
          <p style="margin-top:1rem;font-size:0.95rem;opacity:0.8;">
            Нажмите «+ Новый персонаж», чтобы создать первого героя!
          </p>
        </div>
      `;
      return;
    }

    const display = chars.slice(0, 20);
    charactersList.innerHTML = display.map(c => `
      <div class="char-card" data-id="${c.id}" style="cursor:pointer;">
        <div class="char-avatar">${c.name.charAt(0)}</div>
        <div class="char-name">${c.name}</div>
        <div class="char-class-level">${c.class}, ${c.level} ур.</div>
      </div>
    `).join('');

    document.querySelectorAll('.char-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = Number(card.dataset.id);
        selectedCharacter = chars.find(c => c.id === id);
        showDetail(selectedCharacter);
      });
    });
  }

  function showDetail(char) {
    if (!char) return;
    log('Показ деталей персонажа:', char.name);

    const fields = {
      detailAvatar: char.name.charAt(0),
      detailName: char.name,
      detailClassLevel: `${char.class}, ${char.level} ур.`,
      detailRace: char.race,
      detailWorld: char.world || '—',
      detailHP: String(char.hp),
      detailLevel: String(char.level),
      detailSTR: String(char.abilities.str),
      detailDEX: String(char.abilities.dex),
      detailCON: String(char.abilities.con),
      detailINT: String(char.abilities.int),
      detailWIS: String(char.abilities.wis),
      detailCHA: String(char.abilities.cha),
      detailBackstory: char.backstory || 'Без описания...'
    };

    for (const [id, text] of Object.entries(fields)) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    if (deleteCurrentChar) deleteCurrentChar.dataset.id = char.id;

    if (emptyDetail) emptyDetail.classList.add('hidden');
    if (detailContent) detailContent.classList.remove('hidden');
  }

  function clearDetailPanel() {
    selectedCharacter = null;
    if (emptyDetail) emptyDetail.classList.remove('hidden');
    if (detailContent) detailContent.classList.add('hidden');
  }

  // === ОБРАБОТЧИКИ ===
  if (newCharBtn) {
    newCharBtn.addEventListener('click', () => {
      log('Нажата кнопка "Новый персонаж"');
      if (REQUIRE_AUTH && !checkAuth()) return;
      openModal();
    });
  }

  if (cancelCharBtn) {
    cancelCharBtn.addEventListener('click', closeModal);
  }

  if (charModal) {
    charModal.addEventListener('click', (e) => {
      if (e.target === charModal) closeModal();
    });
  }

  if (charForm) {
    charForm.addEventListener('submit', (e) => {
      e.preventDefault();
      log('Отправка формы создания персонажа');

      const user = JSON.parse(localStorage.getItem('kdUser') || '{"username":"guest"}');
      const fd = new FormData(charForm);

      const char = {
        id: Date.now(),
        owner: user.username,
        name: fd.get('name') || 'Безымянный',
        race: fd.get('race') || 'Человек',
        class: fd.get('class') || 'Воин',
        level: parseInt(fd.get('level')) || 1,
        hp: parseInt(fd.get('hp')) || 10,
        world: fd.get('world') || null,
        abilities: {
          str: parseInt(fd.get('str')) || 10,
          dex: parseInt(fd.get('dex')) || 10,
          con: parseInt(fd.get('con')) || 10,
          int: parseInt(fd.get('int')) || 10,
          wis: parseInt(fd.get('wis')) || 10,
          cha: parseInt(fd.get('cha')) || 10
        },
        backstory: '',
        createdAt: new Date().toISOString()
      };

      saveCharacter(char);

      if (charMessage) {
        charMessage.textContent = '✅ Персонаж успешно создан!';
        charMessage.className = 'message success';
      }

      setTimeout(() => {
        closeModal();
        renderCharacters();
        showDetail(char);
      }, 800);
    });
  }

  if (deleteCurrentChar) {
    deleteCurrentChar.addEventListener('click', () => {
      if (!selectedCharacter) return;
      if (confirm('Удалить персонажа? Это нельзя отменить.')) {
        deleteCharacter(selectedCharacter.id);
      }
    });
  }

  // === ИНИЦИАЛИЗАЦИЯ ===
  log('Инициализация страницы персонажей');
  if (!REQUIRE_AUTH || checkAuth()) {
    initStorage();
    renderCharacters();
    clearDetailPanel();
  }
</script>
<script src="main.js"></script>
</body>
</html>




