<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Все предыдущие стили остаются без изменений */
    .character-editor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 2000;
      overflow-y: auto;
      padding: 1rem;
    }

    .character-sheet {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 1rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      margin: 0 auto;
      width: 100%;
      max-width: 1800px;
    }

    /* ... остальные стили ... */

  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="tokenator.html">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Хранилище персонажей</h1>
      <p>Создавайте и управляйте своими героями</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
    </div>

    <!-- Сетка существующих персонажей -->
    <div class="characters-grid" id="charactersGrid">
      <!-- Персонажи будут отображаться здесь -->
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <!-- Редактор персонажа -->
  <div class="character-editor" id="characterEditor">
    <div style="max-width: 1800px; margin: 0 auto;">
      <div class="editor-header">
        <h2 id="editorTitle">Создание персонажа</h2>
        <button class="btn btn-secondary" id="closeEditor">✕ Закрыть</button>
      </div>

      <div class="controls" style="background: transparent; padding: 0 0 1rem 0;">
        <button class="btn btn-primary" id="saveCharBtn">Сохранить персонажа</button>
        <button class="btn export-btn" id="exportJsonBtn">Экспорт в JSON</button>
      </div>

      <!-- Упрощенная форма для тестирования -->
      <div style="background: var(--card-bg); padding: 2rem; border-radius: 8px;">
        <div class="form-group">
          <label for="charName">Имя персонажа *</label>
          <input type="text" id="charName" class="form-control" required placeholder="Арагорн">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label for="charRace">Раса *</label>
            <input type="text" id="charRace" class="form-control" required placeholder="Человек">
          </div>
          <div class="form-group">
            <label for="charClass">Класс *</label>
            <input type="text" id="charClass" class="form-control" required placeholder="Воин">
          </div>
        </div>

        <div class="editor-actions">
          <button type="button" class="btn export-btn" id="exportJsonEditor">Экспорт в JSON</button>
          <button type="button" class="btn btn-primary" id="saveCharEditor">Сохранить персонажа</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Упрощенный рабочий код
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing characters page...');
      
      // Основные элементы
      const newCharBtn = document.getElementById('newCharBtn');
      const characterEditor = document.getElementById('characterEditor');
      const closeEditor = document.getElementById('closeEditor');
      const charactersGrid = document.getElementById('charactersGrid');
      const saveCharBtn = document.getElementById('saveCharBtn');
      const saveCharEditor = document.getElementById('saveCharEditor');
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const exportJsonEditor = document.getElementById('exportJsonEditor');
      const authButton = document.getElementById('authButton');
      const accountInfo = document.getElementById('accountInfo');
      const accountName = document.getElementById('accountName');
      const accountRole = document.getElementById('accountRole');

      // Проверяем, что элементы существуют
      if (!newCharBtn) {
        console.error('Кнопка "Новый персонаж" не найдена!');
        return;
      }

      console.log('All DOM elements found');

      // Проверка авторизации
      function checkAuth() {
        try {
          const user = JSON.parse(localStorage.getItem('kdUser'));
          if (user) {
            if (accountName) accountName.textContent = user.username;
            if (accountRole) accountRole.textContent = user.role === 'player' ? 'Игрок' : 'Мастер';
            if (accountInfo) accountInfo.classList.add('active');
            if (authButton) {
              authButton.textContent = 'Выйти';
              authButton.onclick = function() {
                localStorage.removeItem('kdUser');
                window.location.reload();
              };
            }
            return true;
          } else {
            if (accountInfo) accountInfo.classList.remove('active');
            if (authButton) {
              authButton.textContent = 'Войти / Регистрация';
              authButton.onclick = function() {
                window.location.href = 'register.html';
              };
            }
            return false;
          }
        } catch (error) {
          console.error('Auth error:', error);
          return false;
        }
      }

      // Показать редактор
      function showCharacterEditor() {
        console.log('Opening character editor...');
        if (characterEditor) {
          characterEditor.style.display = 'block';
          // Сброс формы
          document.getElementById('charName').value = '';
          document.getElementById('charRace').value = '';
          document.getElementById('charClass').value = '';
        }
      }

      // Закрыть редактор
      function closeCharacterEditor() {
        if (characterEditor) {
          characterEditor.style.display = 'none';
        }
      }

      // Сохранить персонажа
      function saveCharacter() {
        const charName = document.getElementById('charName').value.trim();
        const charRace = document.getElementById('charRace').value.trim();
        const charClass = document.getElementById('charClass').value.trim();
        
        if (!charName || !charRace || !charClass) {
          alert('Пожалуйста, заполните все обязательные поля!');
          return;
        }

        const characterData = {
          name: charName,
          race: charRace,
          class: charClass,
          level: 1,
          currentHP: 10,
          maxHP: 10,
          armorClass: 10,
          id: Date.now()
        };

        // Сохраняем в localStorage
        let characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
        const user = JSON.parse(localStorage.getItem('kdUser'));
        
        if (user) {
          characterData.owner = user.username;
          characters.push(characterData);
          localStorage.setItem('kdCharacters', JSON.stringify(characters));
          
          alert(`Персонаж "${charName}" успешно создан!`);
          closeCharacterEditor();
          renderCharactersGrid();
        } else {
          alert('Ошибка: пользователь не авторизован');
        }
      }

      // Экспорт в JSON
      function exportToJson() {
        const charName = document.getElementById('charName').value.trim() || 'character';
        const characterData = {
          name: charName,
          race: document.getElementById('charRace').value,
          class: document.getElementById('charClass').value,
          level: 1
        };

        const jsonString = JSON.stringify(characterData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${charName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Отображение сетки персонажей
      function renderCharactersGrid() {
        try {
          const characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
          const user = JSON.parse(localStorage.getItem('kdUser'));
          
          if (!user) {
            charactersGrid.innerHTML = `
              <div class="empty-state">
                <p>Для просмотра персонажей необходимо войти в систему.</p>
              </div>
            `;
            return;
          }

          const userCharacters = characters.filter(char => char.owner === user.username);

          if (userCharacters.length === 0) {
            charactersGrid.innerHTML = `
              <div class="empty-state">
                <p>У вас пока нет персонажей.</p>
                <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.8;">
                  Нажмите «+ Новый персонаж», чтобы создать первого героя!
                </p>
              </div>
            `;
            return;
          }

          charactersGrid.innerHTML = userCharacters.map(char => `
            <div class="char-card">
              <div class="char-avatar">${char.name?.charAt(0) || '?'}</div>
              <div class="char-name">${char.name || 'Безымянный'}</div>
              <div class="char-class-level">${char.class || '—'}, ${char.level || 1} ур.</div>
              <div class="char-details">
                Раса: ${char.race || '—'}<br>
                HP: ${char.currentHP || 0}/${char.maxHP || 0}
              </div>
              <div class="char-actions">
                <button class="char-btn edit-btn" data-id="${char.id}">Редактировать</button>
                <button class="char-btn delete-btn" data-id="${char.id}">Удалить</button>
              </div>
            </div>
          `).join('');

          // Добавляем обработчики для кнопок
          document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const charId = parseInt(this.getAttribute('data-id'));
              alert('Редактирование персонажа с ID: ' + charId);
            });
          });

          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const charId = parseInt(this.getAttribute('data-id'));
              if (confirm('Удалить этого персонажа?')) {
                let characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
                characters = characters.filter(char => char.id !== charId);
                localStorage.setItem('kdCharacters', JSON.stringify(characters));
                renderCharactersGrid();
              }
            });
          });

        } catch (error) {
          console.error('Error rendering characters:', error);
          charactersGrid.innerHTML = `
            <div class="empty-state">
              <p>Ошибка при загрузке персонажей.</p>
            </div>
          `;
        }
      }

      // Обработчики событий
      newCharBtn.addEventListener('click', function() {
        console.log('New character button clicked');
        if (!checkAuth()) {
          alert('Для создания персонажа необходимо войти в систему.');
          return;
        }
        showCharacterEditor();
      });

      closeEditor.addEventListener('click', closeCharacterEditor);

      // Обработчики для кнопок сохранения
      if (saveCharBtn) {
        saveCharBtn.addEventListener('click', saveCharacter);
      }
      if (saveCharEditor) {
        saveCharEditor.addEventListener('click', saveCharacter);
      }

      // Обработчики для кнопок экспорта
      if (exportJsonBtn) {
        exportJsonBtn.addEventListener('click', exportToJson);
      }
      if (exportJsonEditor) {
        exportJsonEditor.addEventListener('click', exportToJson);
      }

      // Закрытие редактора по клику вне области
      characterEditor.addEventListener('click', function(e) {
        if (e.target === characterEditor) {
          closeCharacterEditor();
        }
      });

      // Инициализация
      function init() {
        console.log('Initializing characters page...');
        checkAuth();
        renderCharactersGrid();
        console.log('Characters page initialized successfully');
      }

      // Запуск
      init();
    });
  </script>

</body>
</html>
