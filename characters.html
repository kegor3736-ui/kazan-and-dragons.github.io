<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Стили для редактора персонажей */
    .character-editor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 2000;
      overflow-y: auto;
      padding: 2rem;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--primary);
    }

    .editor-content {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      border: 1px solid var(--primary-light);
    }

    /* Добавьте остальные стили из предыдущего ответа */
    /* ... */
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="tokenator.html">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Хранилище персонажей</h1>
      <p>Создавайте и управляйте своими героями</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
      <button class="btn btn-primary" id="saveCharBtn" style="display: none;">Сохранить персонажа</button>
      <button class="btn export-btn" id="exportJsonBtn" style="display: none;">Экспорт в JSON</button>
    </div>

    <div class="characters-grid" id="charactersGrid">
      <!-- Персонажи будут отображаться здесь -->
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <!-- Редактор персонажа -->
  <div class="character-editor" id="characterEditor">
    <div class="editor-content">
      <div class="editor-header">
        <h2 id="editorTitle">Создание персонажа</h2>
        <button class="btn btn-secondary" id="closeEditor">✕ Закрыть</button>
      </div>
      
      <!-- Упрощенная форма для тестирования -->
      <form id="characterForm">
        <div class="form-group">
          <label for="charName">Имя персонажа *</label>
          <input type="text" id="charName" class="form-control" required placeholder="Арагорн">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="charRace">Раса *</label>
            <input type="text" id="charRace" class="form-control" required placeholder="Человек">
          </div>
          <div class="form-group">
            <label for="charClass">Класс *</label>
            <input type="text" id="charClass" class="form-control" required placeholder="Воин">
          </div>
          <div class="form-group">
            <label for="charLevel">Уровень *</label>
            <input type="number" id="charLevel" class="form-control" required min="1" max="20" value="1">
          </div>
        </div>

        <div class="editor-actions">
          <button type="button" class="btn export-btn" id="exportJsonEditor">Экспорт в JSON</button>
          <button type="submit" class="btn btn-primary">Сохранить персонажа</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Ждем полной загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing characters page...');
      
      // Основные DOM элементы
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const menuToggle = document.getElementById('menuToggle');
      const newCharBtn = document.getElementById('newCharBtn');
      const saveCharBtn = document.getElementById('saveCharBtn');
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const charactersGrid = document.getElementById('charactersGrid');
      const characterEditor = document.getElementById('characterEditor');
      const characterForm = document.getElementById('characterForm');
      const closeEditor = document.getElementById('closeEditor');
      const exportJsonEditor = document.getElementById('exportJsonEditor');
      const accountInfo = document.getElementById('accountInfo');
      const accountName = document.getElementById('accountName');
      const accountRole = document.getElementById('accountRole');
      const authButton = document.getElementById('authButton');

      // Проверяем, что все элементы найдены
      if (!newCharBtn) {
        console.error('Кнопка "Новый персонаж" не найдена!');
        return;
      }

      if (!characterEditor) {
        console.error('Редактор персонажей не найден!');
        return;
      }

      console.log('All DOM elements found successfully');

      let currentCharacterId = null;
      let editingCharacter = null;

      // =============== ОБЩИЕ ФУНКЦИИ ===============

      // Toggle sidebar
      if (menuToggle && sidebar && mainContent) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          mainContent.classList.toggle('sidebar-hidden');
        });

        // Close sidebar on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 576 && !sidebar.classList.contains('hidden') && 
              !sidebar.contains(e.target) && e.target !== menuToggle) {
            sidebar.classList.add('hidden');
            mainContent.classList.add('sidebar-hidden');
          }
        });
      }

      // Система аутентификации
      function checkAuth() {
        try {
          const user = JSON.parse(localStorage.getItem('kdUser'));
          if (!user) {
            alert('Требуется регистрация для доступа к персонажам.');
            window.location.href = 'register.html';
            return false;
          }
          return true;
        } catch (error) {
          console.error('Auth check error:', error);
          return false;
        }
      }

      function updateAuthUI() {
        try {
          const user = JSON.parse(localStorage.getItem('kdUser'));
          if (user && accountName && accountRole && authButton && accountInfo) {
            accountName.textContent = user.username;
            accountRole.textContent = user.role === 'player' ? 'Игрок' : 'Мастер';
            accountInfo.classList.add('active');
            authButton.textContent = 'Выйти';
            authButton.onclick = () => {
              localStorage.removeItem('kdUser');
              updateAuthUI();
              window.location.reload();
            };
          } else if (authButton) {
            accountInfo.classList.remove('active');
            authButton.textContent = 'Войти / Регистрация';
            authButton.onclick = () => window.location.href = 'register.html';
          }
        } catch (error) {
          console.error('Auth UI update error:', error);
        }
      }

      // =============== СИСТЕМА ПЕРСОНАЖЕЙ ===============

      // Инициализация хранилища персонажей
      function initCharacters() {
        if (!localStorage.getItem('kdCharacters')) {
          localStorage.setItem('kdCharacters', JSON.stringify([]));
        }
      }

      // Получить персонажей пользователя
      function getUserCharacters() {
        try {
          const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
          const user = JSON.parse(localStorage.getItem('kdUser'));
          return allChars.filter(char => char.owner === user.username);
        } catch (error) {
          console.error('Error getting user characters:', error);
          return [];
        }
      }

      // Сохранить персонажа
      function saveCharacter(charData) {
        try {
          const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
          const user = JSON.parse(localStorage.getItem('kdUser'));
          
          if (currentCharacterId) {
            // Редактирование существующего персонажа
            const index = allChars.findIndex(char => char.id === currentCharacterId);
            if (index !== -1) {
              allChars[index] = { 
                ...charData, 
                id: currentCharacterId, 
                owner: user.username,
                updatedAt: new Date().toISOString()
              };
            }
          } else {
            // Создание нового персонажа
            charData.id = Date.now();
            charData.owner = user.username;
            charData.createdAt = new Date().toISOString();
            charData.updatedAt = new Date().toISOString();
            allChars.push(charData);
          }
          
          localStorage.setItem('kdCharacters', JSON.stringify(allChars));
          return charData.id;
        } catch (error) {
          console.error('Error saving character:', error);
          return null;
        }
      }

      // Удалить персонажа
      function deleteCharacter(id) {
        try {
          let allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
          allChars = allChars.filter(char => char.id !== id);
          localStorage.setItem('kdCharacters', JSON.stringify(allChars));
          renderCharacters();
        } catch (error) {
          console.error('Error deleting character:', error);
        }
      }

      // Отобразить сетку персонажей
      function renderCharacters() {
        try {
          const chars = getUserCharacters();
          if (!charactersGrid) {
            console.error('Characters grid container not found');
            return;
          }

          if (chars.length === 0) {
            charactersGrid.innerHTML = `
              <div class="empty-state">
                <p>У вас пока нет персонажей.</p>
                <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.8;">
                  Нажмите «+ Новый персонаж», чтобы создать первого героя!
                </p>
              </div>
            `;
            return;
          }

          charactersGrid.innerHTML = chars.map(char => `
            <div class="char-card">
              <div class="char-avatar">${char.name?.charAt(0) || '?'}</div>
              <div class="char-name">${char.name || 'Безымянный'}</div>
              <div class="char-class-level">${char.class || '—'}, ${char.level || 1} ур.</div>
              <div class="char-details">
                Раса: ${char.race || '—'}<br>
                HP: ${char.currentHP || 0}/${char.maxHP || 0}
              </div>
              <div class="char-actions">
                <button class="char-btn edit-btn" data-id="${char.id}">Редактировать</button>
                <button class="char-btn delete-btn" data-id="${char.id}">Удалить</button>
              </div>
            </div>
          `).join('');

          // Добавить обработчики событий
          document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => editCharacter(parseInt(btn.dataset.id)));
          });

          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              if (confirm('Удалить персонажа? Это действие нельзя отменить.')) {
                deleteCharacter(parseInt(btn.dataset.id));
              }
            });
          });
        } catch (error) {
          console.error('Error rendering characters:', error);
        }
      }

      // =============== РЕДАКТОР ПЕРСОНАЖА ===============

      // Открыть редактор персонажа
      function openCharacterEditor(character = null) {
        console.log('Opening character editor...');
        currentCharacterId = character ? character.id : null;
        editingCharacter = character;
        
        if (document.getElementById('editorTitle')) {
          document.getElementById('editorTitle').textContent = character ? 'Редактирование персонажа' : 'Создание персонажа';
        }
        
        // Заполняем форму данными, если редактируем
        if (character) {
          document.getElementById('charName').value = character.name || '';
          document.getElementById('charRace').value = character.race || '';
          document.getElementById('charClass').value = character.class || '';
          document.getElementById('charLevel').value = character.level || 1;
        } else {
          // Сброс формы для нового персонажа
          characterForm.reset();
          document.getElementById('charLevel').value = 1;
        }
        
        characterEditor.style.display = 'block';
        
        // Показываем кнопки управления в основном интерфейсе
        if (saveCharBtn) saveCharBtn.style.display = 'inline-block';
        if (exportJsonBtn) exportJsonBtn.style.display = 'inline-block';
      }

      // Редактировать персонажа
      function editCharacter(id) {
        try {
          const allChars = JSON.parse(localStorage.getItem('kdCharacters') || '[]');
          const character = allChars.find(char => char.id === id);
          if (character) {
            openCharacterEditor(character);
          }
        } catch (error) {
          console.error('Error editing character:', error);
        }
      }

      // Закрыть редактор
      function closeCharacterEditor() {
        characterEditor.style.display = 'none';
        currentCharacterId = null;
        editingCharacter = null;
        
        // Скрываем кнопки управления
        if (saveCharBtn) saveCharBtn.style.display = 'none';
        if (exportJsonBtn) exportJsonBtn.style.display = 'none';
        
        renderCharacters();
      }

      // Получить данные формы
      function getFormData() {
        return {
          name: document.getElementById('charName').value,
          race: document.getElementById('charRace').value,
          class: document.getElementById('charClass').value,
          level: parseInt(document.getElementById('charLevel').value) || 1,
          currentHP: 10,
          maxHP: 10,
          armorClass: 10
        };
      }

      // Экспорт в JSON
      function exportToJson() {
        try {
          const formData = getFormData();
          const jsonString = JSON.stringify(formData, null, 2);
          
          // Создаем и скачиваем файл
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `${formData.name || 'character'}_${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          alert(`Персонаж "${formData.name}" экспортирован в JSON файл!`);
        } catch (error) {
          console.error('Error exporting to JSON:', error);
          alert('Ошибка при экспорте в JSON');
        }
      }

      // =============== ОБРАБОТЧИКИ СОБЫТИЙ ===============

      // Кнопка "Новый персонаж"
      newCharBtn.addEventListener('click', () => {
        console.log('New character button clicked');
        if (!checkAuth()) return;
        openCharacterEditor();
      });

      // Кнопка "Сохранить персонажа" в основном интерфейсе
      if (saveCharBtn) {
        saveCharBtn.addEventListener('click', () => {
          console.log('Save character button clicked');
          if (!checkAuth()) return;
          
          const charName = document.getElementById('charName').value.trim();
          if (!charName) {
            alert('Пожалуйста, введите имя персонажа');
            return;
          }
          
          const charData = getFormData();
          saveCharacter(charData);
          alert(`Персонаж "${charName}" успешно сохранен!`);
          closeCharacterEditor();
        });
      }

      // Кнопка "Экспорт в JSON" в основном интерфейсе
      if (exportJsonBtn) {
        exportJsonBtn.addEventListener('click', exportToJson);
      }

      // Кнопка "Экспорт в JSON" в редакторе
      if (exportJsonEditor) {
        exportJsonEditor.addEventListener('click', exportToJson);
      }

      // Кнопка закрытия редактора
      if (closeEditor) {
        closeEditor.addEventListener('click', closeCharacterEditor);
      }

      // Обработчик формы
      if (characterForm) {
        characterForm.addEventListener('submit', (e) => {
          e.preventDefault();
          console.log('Form submitted');
          
          const charName = document.getElementById('charName').value.trim();
          if (!charName) {
            alert('Пожалуйста, введите имя персонажа');
            return;
          }
          
          const charData = getFormData();
          saveCharacter(charData);
          alert(`Персонаж "${charName}" успешно ${currentCharacterId ? 'обновлен' : 'создан'}!`);
          closeCharacterEditor();
        });
      }

      // Закрытие редактора по клику вне области
      characterEditor.addEventListener('click', (e) => {
        if (e.target === characterEditor) {
          closeCharacterEditor();
        }
      });

      // =============== ИНИЦИАЛИЗАЦИЯ ===============

      function init() {
        console.log('Initializing characters page...');
        updateAuthUI();
        
        if (checkAuth()) {
          initCharacters();
          renderCharacters();
        }
        
        console.log('Characters page initialized successfully');
      }

      // Запуск приложения
      init();
    });
  </script>

</body>
</html>


