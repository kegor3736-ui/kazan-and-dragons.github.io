<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Персонажи — Kazan & Dragons (Исправленный)</title>
  <style>
    :root{
      --bg:#07060b;
      --card-bg:linear-gradient(180deg, rgba(20,16,40,0.9), rgba(10,8,29,0.9));
      --primary:#6f42c1;
      --primary-light:#9b66e6;
      --accent:#e9d8ff;
      --text:#e7e7f3;
      --muted:rgba(231,231,243,0.65);
    }

    html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,#05040a,#0b0814);font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;color:var(--text);-webkit-font-smoothing:antialiased;}
    .container{max-width:1600px;margin:0 auto;padding:18px 22px;box-sizing:border-box;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    header h1{margin:0;font-size:20px;color:var(--accent);}
    .controls{display:flex;gap:10px;}
    .btn{background:var(--primary);border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}
    .new-char-btn{background:linear-gradient(90deg,var(--primary),var(--primary-light));box-shadow:0 6px 20px rgba(107,46,170,0.18);}

    /* Characters grid */
    .characters-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;}
    .char-card{width:230px;background:rgba(16,12,34,0.6);border:1px solid rgba(111,66,193,0.12);border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column;gap:8px;}
    .char-avatar{width:100%;height:120px;border-radius:8px;background:linear-gradient(180deg, rgba(26,20,45,0.6), rgba(10,8,29,0.6));display:flex;align-items:center;justify-content:center;font-size:42px;color:var(--accent);overflow:hidden;}
    .char-avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .char-name{font-weight:700;font-size:18px;}
    .char-class-level{font-size:13px;color:var(--muted);}
    .char-details{font-size:13px;color:var(--muted);min-height:36px;}
    .char-actions{display:flex;gap:8px;margin-top:auto;}
    .char-actions .btn{flex:1;padding:8px 6px;font-size:13px;border-radius:6px;}

    /* Editor overlay */
    .character-editor{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:4000;overflow:auto;padding:28px;}
    .editor-inner{background:var(--card-bg);border-radius:10px;padding:18px;box-sizing:border-box;max-width:1400px;margin:0 auto;}
    .editor-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;}
    .editor-actions{display:flex;gap:10px;align-items:center;}

    /* Character sheet full width */
    .character-sheet{display:grid;grid-template-columns:260px 1fr 320px;gap:12px;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(12,8,28,0.7), rgba(8,6,20,0.7));}
    @media (max-width:1100px){.character-sheet{grid-template-columns:1fr;}}
    .character-header{grid-column:1/-1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;padding:10px;border-radius:8px;background:rgba(10,8,29,0.6);align-items:center;}
    .hp-section{grid-column:1/-1;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;padding:10px;border-radius:8px;background:rgba(10,8,29,0.6);}

    .ability-column{display:flex;flex-direction:column;gap:12px;}
    .center-column{display:flex;flex-direction:column;gap:12px;}
    .right-column{display:flex;flex-direction:column;gap:12px;}

    .ability-block{background:rgba(26,20,45,0.85);border:1px solid rgba(111,66,193,0.08);padding:10px;border-radius:8px;}
    .ability-header{font-weight:700;color:var(--accent);text-align:center;margin-bottom:6px;}
    .ability-score{width:100%;font-size:20px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);text-align:center;}
    .ability-modifier{display:block;text-align:center;margin-top:6px;padding:6px;border-radius:6px;background:rgba(111,66,193,0.12);font-weight:700;color:var(--accent);}

    .saving-throw,.skill{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;}
    .proficiency-bonus{display:block;text-align:center;padding:10px;border-radius:8px;background:rgba(111,66,193,0.08);font-weight:700;color:var(--accent);}

    .weapons-table{width:100%;border-collapse:collapse;margin-top:6px;}
    .weapons-table th,.weapons-table td{padding:6px;border:1px solid rgba(255,255,255,0.03);font-size:13px;}
    .weapons-table th{background:rgba(111,66,193,0.06);color:var(--accent);}

    .portrait-section{text-align:center;}
    .portrait-placeholder{width:140px;height:180px;border-radius:8px;border:2px dashed rgba(111,66,193,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0 auto;background:rgba(10,8,29,0.6);color:var(--muted);}
    .portrait-preview{max-width:140px;max-height:180px;border-radius:8px;display:block;margin:0 auto;}

    .section-title{font-weight:700;color:var(--accent);margin-bottom:8px;border-bottom:1px solid rgba(111,66,193,0.06);padding-bottom:6px;}
    .text-area{width:100%;min-height:80px;background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:6px;color:var(--text);resize:vertical;}
    .form-control{width:100%;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text);}

    .spellbook-section{grid-column:1/-1;}

    /* Conditions tags */
    .conditions-list{display:flex;flex-wrap:wrap;gap:8px;}
    .cond-chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent;color:var(--muted);user-select:none;}
    .cond-chip.active{background:linear-gradient(90deg,var(--primary),var(--primary-light));color:#fff;border-color:transparent;box-shadow:0 6px 20px rgba(107,46,170,0.12);}

    .editor-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;}
    .small-muted{font-size:13px;color:var(--muted);}

    /* utilities */
    .flex{display:flex;gap:8px;align-items:center;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
    input[type="file"]{display:none;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Хранилище персонажей — Kazan & Dragons</h1>
      <div class="controls">
        <button id="newCharBtn" class="btn new-char-btn">+ Новый персонаж</button>
        <button id="debugShowStorage" class="btn secondary">(debug) Очистить все</button>
      </div>
    </header>

    <div id="mainContent">
      <div class="characters-grid" id="charactersGrid">
        <!-- карточки персонажей -->
      </div>
    </div>
  </div>

  <!-- Редактор -->
  <div class="character-editor" id="characterEditor" aria-hidden="true">
    <div class="editor-inner">
      <div class="editor-header">
        <div><h2 id="editorTitle">Создание персонажа</h2><div class="small-muted" id="editorSubtitle">—</div></div>
        <div class="editor-actions">
          <button id="closeEditor" class="btn secondary">Закрыть</button>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px;">
        <div style="display:flex;gap:8px;">
          <button id="saveCharBtn" class="btn">Сохранить персонажа</button>
          <button id="exportJsonBtn" class="btn secondary">Экспорт в JSON</button>
        </div>
        <div class="small-muted">Редактор: локально в браузере, данные хранятся в localStorage</div>
      </div>

      <div class="character-sheet" id="sheetRoot">
        <!-- header -->
        <div class="character-header">
          <div>
            <label>Имя персонажа</label>
            <input id="charName" class="form-control" placeholder="Арагорн">
          </div>
          <div>
            <label>Предыстория</label>
            <input id="charBackground" class="form-control" placeholder="Странник">
          </div>
          <div>
            <label>Класс</label>
            <input id="charClass" class="form-control" placeholder="Воин">
          </div>
          <div>
            <label>Раса</label>
            <input id="charRace" class="form-control" placeholder="Человек">
          </div>
          <div>
            <label>Подкласс</label>
            <input id="charSubclass" class="form-control" placeholder="Паладин">
          </div>
          <div>
            <label>Уровень</label>
            <input id="charLevel" class="form-control" type="number" value="1" min="1" max="20">
          </div>
          <div>
            <label>Опыт</label>
            <input id="charExp" class="form-control" type="number" value="0">
          </div>
          <div>
            <label>Класс защиты (база)</label>
            <input id="armorClass" class="form-control" type="number" value="10">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="margin-bottom:0;">Щит</label>
            <input id="shieldToggle" type="checkbox">
            <input id="shieldBonus" class="form-control" type="number" value="2" min="0" max="5" style="width:80px;">
          </div>
        </div>

        <!-- HP section -->
        <div class="hp-section">
          <div>
            <label>Текущие хиты</label>
            <input id="currentHP" class="form-control" type="number" value="10" min="0">
          </div>
          <div>
            <label>Временные хиты</label>
            <input id="tempHP" class="form-control" type="number" value="0" min="0">
          </div>
          <div>
            <label>Максимум хитов</label>
            <input id="maxHP" class="form-control" type="number" value="10" min="1">
          </div>
          <div>
            <label>Кости хитов</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <select id="hitDiceType" class="form-control" style="width:110px;">
                <option value="d6">d6</option>
                <option value="d8">d8</option>
                <option value="d10" selected>d10</option>
                <option value="d12">d12</option>
              </select>
              <input id="hitDiceCount" class="form-control" type="number" value="1" min="0" style="width:70px;">
            </div>
          </div>
          <div>
            <label>Спасброски от смерти</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <div id="successCircles" style="display:flex;gap:6px;"></div>
              <div id="failureCircles" style="display:flex;gap:6px;"></div>
            </div>
            <button id="rollDeathSave" class="btn" style="margin-top:8px;width:100%;">Бросок спасброска</button>
          </div>
        </div>

        <!-- LEFT: abilities -->
        <div class="ability-column">
          <div class="proficiency-bonus ability-block">Бонус владения: <span id="proficiencyBonus">+2</span></div>

          <div class="ability-block">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <div class="ability-header">СИЛА</div>
                <input id="strScore" class="ability-score" type="number" value="10" min="1" max="30">
                <div class="ability-modifier" id="strMod">+0</div>
                <div class="saving-throw"><label><input id="strSave" type="checkbox"> Спасбросок</label><span id="strSaveMod">+0</span></div>
                <div class="skill"><label><input id="athletics" type="checkbox"> Атлетика</label><span id="athleticsMod">+0</span></div>
              </div>
              <div>
                <div class="ability-header">ЛОВКОСТЬ</div>
                <input id="dexScore" class="ability-score" type="number" value="10" min="1" max="30">
                <div class="ability-modifier" id="dexMod">+0</div>
                <div class="saving-throw"><label><input id="dexSave" type="checkbox"> Спасбросок</label><span id="dexSaveMod">+0</span></div>
                <div class="skill"><label><input id="acrobatics" type="checkbox"> Акробатика</label><span id="acrobaticsMod">+0</span></div>
                <div class="skill"><label><input id="sleight" type="checkbox"> Ловкость рук</label><span id="sleightMod">+0</span></div>
                <div class="skill"><label><input id="stealth" type="checkbox"> Скрытность</label><span id="stealthMod">+0</span></div>
              </div>
            </div>
          </div>

          <div class="ability-block">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <div class="ability-header">ТЕЛОСЛОЖЕНИЕ</div>
                <input id="conScore" class="ability-score" type="number" value="10">
                <div class="ability-modifier" id="conMod">+0</div>
                <div class="saving-throw"><label><input id="conSave" type="checkbox"> Спасбросок</label><span id="conSaveMod">+0</span></div>
              </div>
              <div>
                <div class="ability-header">ИНТЕЛЛЕКТ</div>
                <input id="intScore" class="ability-score" type="number" value="10">
                <div class="ability-modifier" id="intMod">+0</div>
                <div class="saving-throw"><label><input id="intSave" type="checkbox"> Спасбросок</label><span id="intSaveMod">+0</span></div>
                <div class="skill"><label><input id="investigation" type="checkbox"> Анализ</label><span id="investigationMod">+0</span></div>
                <div class="skill"><label><input id="history" type="checkbox"> История</label><span id="historyMod">+0</span></div>
                <div class="skill"><label><input id="arcana" type="checkbox"> Магия</label><span id="arcanaMod">+0</span></div>
              </div>
            </div>
          </div>

          <div class="ability-block">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <div class="ability-header">МУДРОСТЬ</div>
                <input id="wisScore" class="ability-score" type="number" value="10">
                <div class="ability-modifier" id="wisMod">+0</div>
                <div class="saving-throw"><label><input id="wisSave" type="checkbox"> Спасбросок</label><span id="wisSaveMod">+0</span></div>
                <div class="skill"><label><input id="perception" type="checkbox"> Внимательность</label><span id="perceptionMod">+0</span></div>
              </div>
              <div>
                <div class="ability-header">ХАРИЗМА</div>
                <input id="chaScore" class="ability-score" type="number" value="10">
                <div class="ability-modifier" id="chaMod">+0</div>
                <div class="saving-throw"><label><input id="chaSave" type="checkbox"> Спасбросок</label><span id="chaSaveMod">+0</span></div>
                <div class="skill"><label><input id="performance" type="checkbox"> Выступление</label><span id="performanceMod">+0</span></div>
              </div>
            </div>
          </div>

          <div class="ability-block">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div class="ability-header">ИНИЦИАТИВА</div>
                <div id="initiativeValue" style="font-weight:700;font-size:16px;margin-top:6px;">+0</div>
              </div>
              <div>
                <div class="ability-header">СКОРОСТЬ</div>
                <input id="speedValue" class="form-control" type="number" value="30" style="width:110px;text-align:center;">
              </div>
            </div>
            <div style="margin-top:8px;">
              <div class="ability-header">ПАССИВНОЕ ВОСПРИЯТИЕ</div>
              <div id="passivePerceptionValue" style="font-weight:700;margin-top:6px;">10</div>
            </div>
          </div>
        </div>

        <!-- CENTER -->
        <div class="center-column">
          <div class="ability-block">
            <div class="section-title">СОСТОЯНИЯ</div>
            <div class="conditions-list" id="conditionsList">
              <div class="cond-chip" data-val="blinded">Ослеплен</div>
              <div class="cond-chip" data-val="charmed">Очарован</div>
              <div class="cond-chip" data-val="deafened">Оглох</div>
              <div class="cond-chip" data-val="frightened">Испуган</div>
              <div class="cond-chip" data-val="grappled">Схвачен</div>
              <div class="cond-chip" data-val="incapacitated">Недееспособен</div>
              <div class="cond-chip" data-val="invisible">Невидим</div>
              <div class="cond-chip" data-val="paralyzed">Парализован</div>
              <div class="cond-chip" data-val="petrified">Окаменевший</div>
              <div class="cond-chip" data-val="poisoned">Отравлен</div>
              <div class="cond-chip" data-val="prone">Лежит</div>
              <div class="cond-chip" data-val="restrained">Скован</div>
              <div class="cond-chip" data-val="stunned">Ошеломлен</div>
              <div class="cond-chip" data-val="unconscious">Без сознания</div>
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">ОРУЖИЕ И ЗАГОВОРЫ</div>
            <table class="weapons-table" id="weaponsTable">
              <thead>
                <tr><th>Название</th><th>Бонус</th><th>Урон</th><th>Заметки</th></tr>
              </thead>
              <tbody id="weaponsTableBody"></tbody>
            </table>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="addWeapon" class="btn secondary">+ Добавить</button>
              <button id="clearWeapons" class="btn secondary">Очистить</button>
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">СПОСОБНОСТИ КЛАССА</div>
            <textarea id="classAbilities" class="text-area" placeholder="Способности класса..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">СПОСОБНОСТИ РАСЫ</div>
            <textarea id="raceAbilities" class="text-area" placeholder="Способности расы..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">ЗАМЕТКИ</div>
            <textarea id="notes" class="text-area" placeholder="Заметки..."></textarea>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="right-column">
          <div class="ability-block">
            <div class="section-title">ВЛАДЕНИЯ И ИНСТРУМЕНТЫ</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              <label class="checkbox"><input id="lightArmor" type="checkbox"> Лёгкие доспехи</label>
              <label class="checkbox"><input id="mediumArmor" type="checkbox"> Средние доспехи</label>
              <label class="checkbox"><input id="heavyArmor" type="checkbox"> Тяжёлые доспехи</label>
            </div>
            <div style="margin-top:10px;">
              <label>Инструменты и языки</label>
              <textarea id="toolProficiencies" class="text-area" placeholder="Инструменты и языки..."></textarea>
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">ПОРТРЕТ</div>
            <div class="portrait-section">
              <div id="portraitPlaceholder" class="portrait-placeholder">Нажмите для загрузки</div>
              <img id="portraitPreview" class="portrait-preview" alt="Портрет">
              <input id="portraitUpload" type="file" accept="image/*">
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button id="removePortrait" class="btn secondary">Удалить портрет</button>
              </div>
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">ПРЕДЫСТОРИЯ / ЛИЧНОСТЬ</div>
            <textarea id="personality" class="text-area" placeholder="Личные качества и предыстория..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">СНАРЯЖЕНИЕ</div>
            <textarea id="equipment" class="text-area" placeholder="Снаряжение персонажа..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">МОНЕТЫ</div>
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
              <div><label>ММ</label><input id="cp" class="form-control" type="number" min="0" value="0"></div>
              <div><label>СМ</label><input id="sp" class="form-control" type="number" min="0" value="0"></div>
              <div><label>ЗМ</label><input id="gp" class="form-control" type="number" min="0" value="0"></div>
              <div><label>ЭМ</label><input id="ep" class="form-control" type="number" min="0" value="0"></div>
              <div><label>ПМ</label><input id="pp" class="form-control" type="number" min="0" value="0"></div>
            </div>
            <!-- калькулятор монет удалён -->
          </div>
        </div>

        <!-- Spellbook -->
        <div class="spellbook-section">
          <div class="ability-block">
            <div class="section-title">КНИГА ЗАКЛИНАНИЙ</div>
            <textarea id="spellbook" class="text-area" placeholder="Заклинания..."></textarea>
          </div>
        </div>

      </div>

      <div class="editor-footer">
        <div class="small-muted">Данные сохраняются в localStorage. Нажмите «Экспорт в JSON», чтобы скачать.</div>
        <div style="display:flex;gap:8px;">
          <button id="saveAndClose" class="btn">Сохранить и закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== Utils ========
    function $(id){return document.getElementById(id);}
    function qs(selector, ctx=document){return ctx.querySelector(selector);}
    function qsa(selector, ctx=document){return Array.from(ctx.querySelectorAll(selector));}
    function uid(){return Date.now().toString(36) + Math.random().toString(36).slice(2,8);}

    // ======== Storage keys ========
    const STORAGE_USER = 'kdUser';
    const STORAGE_CHAR = 'kdCharacters';

    // ======== Initial data & debug ========
    document.addEventListener('DOMContentLoaded', initApp);

    function initApp(){
      // Debug button: очистить всё
      $('debugShowStorage').addEventListener('click', ()=>{
        if(confirm('Очистить всех персонажей в localStorage?')){ localStorage.removeItem(STORAGE_CHAR); renderCharactersGrid(); }
      });

      // Init UI
      $('newCharBtn').addEventListener('click', onNewChar);
      $('closeEditor').addEventListener('click', closeEditor);
      $('saveCharBtn').addEventListener('click', onSaveCharacter);
      $('saveAndClose').addEventListener('click', ()=>{ onSaveCharacter(); closeEditor(); });
      $('exportJsonBtn').addEventListener('click', exportJson);

      // Portrait
      initPortraitControls();

      // Death saves circles
      initDeathSaves();

      // Conditions chips
      initConditions();

      // Weapons table controls
      $('addWeapon').addEventListener('click', addWeaponRow);
      $('clearWeapons').addEventListener('click', ()=>{$('weaponsTableBody').innerHTML='';});

      // Armor/shield updates
      $('shieldToggle').addEventListener('change', updateArmorClass);
      $('shieldBonus').addEventListener('input', updateArmorClass);

      // Ability inputs
      ['str','dex','con','int','wis','cha'].forEach(ab=>{
        const el = $(ab+'Score');
        if(el) el.addEventListener('input', ()=>{ updateAbilityModifier(ab); updateCalculations(); });
      });

      // Other calculations
      $('wisScore').addEventListener('input', updatePassivePerception);
      $('perception').addEventListener('change', updatePassivePerception);
      $('charExp').addEventListener('input', updateLevelFromExp);

      // Roll death save
      $('rollDeathSave').addEventListener('click', rollDeathSave);

      // load grid
      renderCharactersGrid();
    }

    // ======== Editor open/close/new ========
    let editingId = null; // null => new character
    function onNewChar(){
      // If we don't have kdUser, create default owner to avoid errors
      if(!localStorage.getItem(STORAGE_USER)){
        localStorage.setItem(STORAGE_USER, JSON.stringify({username:'player1', role:'player'}));
      }
      openEditorFor(null);
    }

    function openEditorFor(charId){
      editingId = charId;
      resetEditorForm();

      if(charId){
        // load existing
        const characters = JSON.parse(localStorage.getItem(STORAGE_CHAR) || '[]');
        const ch = characters.find(c=>c.id==charId);
        if(ch){
          fillFormFromChar(ch);
          $('editorTitle').textContent = 'Редактирование персонажа';
          $('editorSubtitle').textContent = `id: ${ch.id}`;
        } else {
          $('editorTitle').textContent = 'Создание персонажа';
          $('editorSubtitle').textContent = '';
        }
      } else {
        $('editorTitle').textContent = 'Создание персонажа';
        $('editorSubtitle').textContent = '';
      }

      $('characterEditor').style.display='block';
      $('characterEditor').setAttribute('aria-hidden','false');
    }

    function closeEditor(){
      $('characterEditor').style.display='none';
      $('characterEditor').setAttribute('aria-hidden','true');
      // ensure editingId cleared only if it's a new creation
      editingId = null;
    }

    function resetEditorForm(){
      // Reset all fields to default
      const fields = [
        'charName','charBackground','charClass','charRace','charSubclass','charLevel','charExp','armorClass',
        'currentHP','tempHP','maxHP','hitDiceType','hitDiceCount','strScore','dexScore','conScore',
        'intScore','wisScore','chaScore','initiativeValue','speedValue','passivePerceptionValue',
        'classAbilities','raceAbilities','features','notes','toolProficiencies','personality','equipment','spellbook',
        'cp','sp','gp','ep','pp'
      ];
      fields.forEach(id=>{
        const el = $(id);
        if(!el) return;
        if(el.tagName === 'INPUT' && el.type==='number') el.value = el.defaultValue || 0;
        else if(el.tagName === 'INPUT') el.value = '';
        else if(el.tagName === 'TEXTAREA') el.value = '';
        else el.value = el.defaultValue || '';
      });

      // abilities default to 10
      ['strScore','dexScore','conScore','intScore','wisScore','chaScore'].forEach(id=>$(id).value=10);

      // checkbox/proficiencies clear
      qsa('input[type=checkbox]').forEach(cb=>cb.checked=false);

      // weapons
      $('weaponsTableBody').innerHTML = '';

      // portrait preview & input clear
      $('portraitPreview').src = '';
      $('portraitPreview').style.display='none';
      $('portraitPlaceholder').style.display='flex';
      // reset file input
      const file = $('portraitUpload');
      try{
        file.value = '';
      }catch(e){}
      // clear death saves
      $('successCircles').innerHTML='';
      $('failureCircles').innerHTML='';
      createDeathSaveCircles();
      updateCalculations();
      // clear conditions
      qsa('.cond-chip').forEach(chip=>chip.classList.remove('active'));
    }

    // ======== Fill form from character (edit) ========
    function fillFormFromChar(ch){
      $('charName').value = ch.name || '';
      $('charBackground').value = ch.background || '';
      $('charClass').value = ch.class || '';
      $('charRace').value = ch.race || '';
      $('charSubclass').value = ch.subclass || '';
      $('charLevel').value = ch.level || 1;
      $('charExp').value = ch.exp || 0;
      $('armorClass').value = ch.armorClass || 10;
      $('currentHP').value = ch.currentHP || 0;
      $('tempHP').value = ch.tempHP || 0;
      $('maxHP').value = ch.maxHP || 0;

      // hit dice
      if(ch.hitDice){
        // stored like "1d10"
        const m = String(ch.hitDice).match(/(\d+)(d\d+)/);
        if(m){ $('hitDiceCount').value = m[1]; $('hitDiceType').value = m[2]; }
      }

      // abilities
      ['str','dex','con','int','wis','cha'].forEach(ab=>{
        if(ch[ab]) $(ab+'Score').value = ch[ab];
      });

      // skills/proficiencies - restore by ids
      if(ch.proficiencies){
        ch.proficiencies.forEach(id=>{
          const el = $(id);
          if(el && el.type==='checkbox') el.checked = true;
        });
      }

      // weapons
      if(ch.weapons && Array.isArray(ch.weapons)){
        $('weaponsTableBody').innerHTML = '';
        ch.weapons.forEach(w=>{
          addWeaponRow(w.name,w.bonus,w.damage,w.notes);
        });
      }

      // portrait: set preview but not file input
      if(ch.portrait){
        $('portraitPreview').src = ch.portrait;
        $('portraitPreview').style.display='block';
        $('portraitPlaceholder').style.display='none';
      } else {
        $('portraitPreview').src = '';
        $('portraitPreview').style.display='none';
        $('portraitPlaceholder').style.display='flex';
      }

      // other fields
      ['classAbilities','raceAbilities','notes','toolProficiencies','personality','equipment','spellbook','cp','sp','gp','ep','pp'].forEach(id=>{
        if(ch[id] !== undefined && $(id)) $(id).value = ch[id];
      });

      // conditions
      qsa('.cond-chip').forEach(chip=>{
        chip.classList.toggle('active', (ch.conditions||[]).includes(chip.dataset.val));
      });

      updateCalculations();
    }

    // ======== Save character ========
    function onSaveCharacter(){
      const user = JSON.parse(localStorage.getItem(STORAGE_USER) || JSON.stringify({username:'player1', role:'player'}));
      const characters = JSON.parse(localStorage.getItem(STORAGE_CHAR) || '[]');

      const charData = getCharacterDataFromForm();
      if(editingId){
        // update existing
        const idx = characters.findIndex(c=>c.id==editingId);
        if(idx>=0){
          charData.id = editingId;
          charData.owner = characters[idx].owner || user.username;
          characters[idx] = charData;
        } else {
          // not found - push as new
          charData.id = editingId;
          charData.owner = user.username;
          characters.push(charData);
        }
      } else {
        // new character
        charData.id = uid();
        charData.owner = user.username;
        characters.push(charData);
      }

      localStorage.setItem(STORAGE_CHAR, JSON.stringify(charDataFilterForStorage(characters)));
      alert(`Персонаж "${charData.name || 'Безымянный'}" сохранён.`);
      renderCharactersGrid();
      editingId = charData.id;
    }

    // remove extraneous circular references etc if any
    function charDataFilterForStorage(list){
      return list.map(c=>{
        // keep small sane object
        const copy = Object.assign({}, c);
        // ensure portrait is a base64 string or null
        if(!copy.portrait) delete copy.portrait;
        return copy;
      });
    }

    function getCharacterDataFromForm(){
      // collect conditions (chips)
      const conds = qsa('.cond-chip.active').map(chip=>chip.dataset.val);
      // collect proficiencies checkboxes by id
      const profs = qsa('input[type=checkbox]').filter(cb=>cb.checked).map(cb=>cb.id);

      // weapons:
      const weapons = Array.from($('weaponsTableBody').querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('input');
        return {
          name: tds[0]?.value || '',
          bonus: tds[1]?.value || '',
          damage: tds[2]?.value || '',
          notes: tds[3]?.value || ''
        };
      });

      // portrait: if preview visible, take its src
      const portraitEl = $('portraitPreview');
      const portraitData = (portraitEl && portraitEl.src && portraitEl.style.display!=='none') ? portraitEl.src : null;

      const char = {
        name: $('charName').value.trim(),
        background: $('charBackground').value.trim(),
        class: $('charClass').value.trim(),
        race: $('charRace').value.trim(),
        subclass: $('charSubclass').value.trim(),
        level: parseInt($('charLevel').value) || 1,
        exp: parseInt($('charExp').value) || 0,
        armorClass: parseInt($('armorClass').value) || 10,
        shieldActive: $('shieldToggle').checked,
        shieldBonus: parseInt($('shieldBonus').value) || 0,
        currentHP: parseInt($('currentHP').value) || 0,
        tempHP: parseInt($('tempHP').value) || 0,
        maxHP: parseInt($('maxHP').value) || 0,
        hitDice: ($('hitDiceCount').value||0) + ($('hitDiceType').value||'d6'),
        str: parseInt($('strScore').value) || 10,
        dex: parseInt($('dexScore').value) || 10,
        con: parseInt($('conScore').value) || 10,
        int: parseInt($('intScore').value) || 10,
        wis: parseInt($('wisScore').value) || 10,
        cha: parseInt($('chaScore').value) || 10,
        proficiencies: profs,
        conditions: conds,
        weapons: weapons,
        classAbilities: $('classAbilities').value,
        raceAbilities: $('raceAbilities').value,
        notes: $('notes').value,
        toolProficiencies: $('toolProficiencies').value,
        personality: $('personality').value,
        equipment: $('equipment').value,
        spellbook: $('spellbook').value,
        cp: parseInt($('cp').value)||0,
        sp: parseInt($('sp').value)||0,
        gp: parseInt($('gp').value)||0,
        ep: parseInt($('ep').value)||0,
        pp: parseInt($('pp').value)||0,
        portrait: portraitData
      };

      return char;
    }

    // ======== Render grid ========
    function renderCharactersGrid(){
      const characters = JSON.parse(localStorage.getItem(STORAGE_CHAR) || '[]');
      const user = JSON.parse(localStorage.getItem(STORAGE_USER) || JSON.stringify({username:'player1', role:'player'}));
      const userChars = characters.filter(c=>c.owner === user.username);
      const grid = $('charactersGrid');
      grid.innerHTML='';

      if(userChars.length===0){
        grid.innerHTML = `<div style="color:var(--muted);padding:18px;background:rgba(255,255,255,0.02);border-radius:8px;">У вас пока нет персонажей. Нажмите «+ Новый персонаж».</div>`;
        return;
      }

      userChars.forEach(ch=>{
        const card = document.createElement('div');
        card.className='char-card';
        const avatarDiv = document.createElement('div');
        avatarDiv.className='char-avatar';
        if(ch.portrait){
          const img = document.createElement('img');
          img.src = ch.portrait;
          img.alt = ch.name || 'portrait';
          avatarDiv.appendChild(img);
        } else {
          avatarDiv.textContent = (ch.name && ch.name[0]) ? ch.name[0].toUpperCase() : '?';
        }

        const nameEl = document.createElement('div'); nameEl.className='char-name'; nameEl.textContent = ch.name || 'Безымянный';
        const classEl = document.createElement('div'); classEl.className='char-class-level'; classEl.textContent = `${ch.class || '—'}, ${ch.level||1} ур.`;
        const detailsEl = document.createElement('div'); detailsEl.className='char-details'; detailsEl.innerHTML = `Раса: ${ch.race||'—'}<br>HP: ${ch.currentHP||0}/${ch.maxHP||0}`;

        const actions = document.createElement('div'); actions.className='char-actions';
        const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Редактировать';
        const delBtn = document.createElement('button'); delBtn.className='btn secondary'; delBtn.textContent='Удалить';

        editBtn.addEventListener('click', ()=>{ openEditorFor(ch.id); });
        delBtn.addEventListener('click', ()=>{ if(confirm('Удалить этого персонажа?')){ deleteCharacter(ch.id); } });

        actions.appendChild(editBtn); actions.appendChild(delBtn);

        card.appendChild(avatarDiv);
        card.appendChild(nameEl);
        card.appendChild(classEl);
        card.appendChild(detailsEl);
        card.appendChild(actions);

        grid.appendChild(card);
      });
    }

    function deleteCharacter(charId){
      let characters = JSON.parse(localStorage.getItem(STORAGE_CHAR) || '[]');
      characters = characters.filter(c=>c.id != charId);
      localStorage.setItem(STORAGE_CHAR, JSON.stringify(charDataFilterForStorage(characters)));
      renderCharactersGrid();
    }

    // ======== Portrait controls ========
    function initPortraitControls(){
      const placeholder = $('portraitPlaceholder');
      const upload = $('portraitUpload');
      const preview = $('portraitPreview');
      const removeBtn = $('removePortrait');

      placeholder.addEventListener('click', ()=>upload.click());
      upload.addEventListener('change', handlePortraitUpload);
      removeBtn.addEventListener('click', ()=>{
        preview.src=''; preview.style.display='none'; placeholder.style.display='flex';
        try{ upload.value=''; }catch(e){}
      });
    }

    function handlePortraitUpload(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const src = ev.target.result;
        $('portraitPreview').src = src;
        $('portraitPreview').style.display='block';
        $('portraitPlaceholder').style.display='none';
      };
      reader.readAsDataURL(file);
    }

    // ======== Weapons ========
    function addWeaponRow(name='',bonus='',damage='',notes=''){
      const tbody = $('weaponsTableBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control" placeholder="Название" value="${escapeHtml(name)}"></td>
        <td><input class="form-control" placeholder="+0" value="${escapeHtml(bonus)}"></td>
        <td><input class="form-control" placeholder="1d8" value="${escapeHtml(damage)}"></td>
        <td><input class="form-control" placeholder="Заметки" value="${escapeHtml(notes)}"></td>
      `;
      tbody.appendChild(tr);
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

    // ======== Conditions chips ========
    function initConditions(){
      qsa('.cond-chip').forEach(chip=>{
        chip.addEventListener('click', ()=>{
          chip.classList.toggle('active');
        });
      });
    }

    // ======== Death saves UI ========
    function initDeathSaves(){
      createDeathSaveCircles();
      qsa('.death-save-circle').forEach(c=>c.addEventListener('click', ()=>c.classList.toggle('filled')));
    }
    function createDeathSaveCircles(){
      const succ = $('successCircles'); const fail = $('failureCircles');
      succ.innerHTML = ''; fail.innerHTML = '';
      for(let i=0;i<3;i++){ const d=document.createElement('div'); d.className='death-save-circle'; d.style.width='18px'; d.style.height='18px'; d.style.borderRadius='50%'; d.style.border='2px solid var(--primary)'; d.style.cursor='pointer'; d.addEventListener('click', ()=>d.classList.toggle('filled')); succ.appendChild(d); }
      for(let i=0;i<3;i++){ const d=document.createElement('div'); d.className='death-save-circle'; d.style.width='18px'; d.style.height='18px'; d.style.borderRadius='50%'; d.style.border='2px solid var(--primary)'; d.style.cursor='pointer'; d.addEventListener('click', ()=>d.classList.toggle('filled')); fail.appendChild(d); }
    }

    function rollDeathSave(){
      const roll = Math.floor(Math.random()*20)+1;
      alert('Бросок спасброска: ' + roll);
      if(roll === 1){ addDeathFailure(); addDeathFailure(); }
      else if(roll === 20){ alert('Критический успех! Восстанавливает 1 HP.'); resetDeathSaves(); const cur=parseInt($('currentHP').value)||0; $('currentHP').value=cur+1; }
      else if(roll < 10) addDeathFailure();
      else addDeathSuccess();
      checkDeathSaves();
    }
    function addDeathSuccess(){ const circles = $('successCircles').querySelectorAll('.death-save-circle'); for(let c of circles){ if(!c.classList.contains('filled')){ c.classList.add('filled'); break; } } }
    function addDeathFailure(){ const circles = $('failureCircles').querySelectorAll('.death-save-circle'); for(let c of circles){ if(!c.classList.contains('filled')){ c.classList.add('filled'); break; } } }
    function resetDeathSaves(){ qsa('.death-save-circle').forEach(c=>c.classList.remove('filled')); }
    function checkDeathSaves(){ const succ = $('successCircles').querySelectorAll('.death-save-circle.filled').length; const fail = $('failureCircles').querySelectorAll('.death-save-circle.filled').length; if(succ>=3){ alert('Персонаж стабилизирован (3 успеха).'); resetDeathSaves(); } if(fail>=3){ alert('Персонаж умирает (3 провала).'); resetDeathSaves(); } }

    // ======== Calculations ========
    function updateAbilityModifier(abilityId){
      const score = parseInt($(abilityId+'Score').value) || 10;
      const mod = Math.floor((score - 10)/2);
      const modEl = $(abilityId+'Mod');
      if(modEl) modEl.textContent = (mod>=0?'+':'') + mod;
      // update skill mods that depend on ability (quick approximation: we recompute visible skill labels)
      // For simplicity we leave specific skill numbers minimal; user still sees ability mod.
    }

    function updateCalculations(){
      // initiative = dex mod
      const dex = parseInt($('dexScore').value) || 10;
      const dexMod = Math.floor((dex-10)/2);
      $('initiativeValue').textContent = (dexMod>=0?'+':'')+dexMod;

      updatePassivePerception();
      updateProficiencyBonus();
      updateArmorClass();
    }

    function updateArmorClass(){
      const baseAC = parseInt($('armorClass').value) || 10;
      const shieldActive = $('shieldToggle').checked;
      const shieldBonus = shieldActive ? (parseInt($('shieldBonus').value)||0) : 0;
      // Note: we will not overwrite base input; instead show computed result in subtitle
      const computed = baseAC + shieldBonus;
      $('editorSubtitle').textContent = `Класс защиты: ${computed}`;
    }

    function updatePassivePerception(){
      const wis = parseInt($('wisScore').value) || 10;
      const wisMod = Math.floor((wis-10)/2);
      const perceptionProficient = $('perception').checked;
      const prof = parseInt($('proficiencyBonus').textContent.replace('+',''))||2;
      const passive = 10 + wisMod + (perceptionProficient ? prof : 0);
      $('passivePerceptionValue').textContent = passive;
    }

    function updateProficiencyBonus(){
      const lvl = parseInt($('charLevel').value)||1;
      let bonus=2;
      if(lvl>=5) bonus=3;
      if(lvl>=9) bonus=4;
      if(lvl>=13) bonus=5;
      if(lvl>=17) bonus=6;
      $('proficiencyBonus').textContent = '+'+bonus;
    }

    function updateLevelFromExp(){
      const expTable = {1:0,2:300,3:900,4:2700,5:6500,6:14000,7:23000,8:34000,9:48000,10:64000,11:85000,12:100000,13:120000,14:140000,15:165000,16:195000,17:225000,18:265000,19:305000,20:355000};
      const exp = parseInt($('charExp').value) || 0;
      let level = 1;
      for(let i=20;i>=1;i--){ if(exp>=expTable[i]){ level=i; break; } }
      $('charLevel').value = level;
      updateProficiencyBonus();
    }

    // ======== Export JSON ========
    function exportJson(){
      const data = getCharacterDataFromForm();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (data.name || 'character') + '.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ======== On load, if editing by click handled in render grid (edit -> openEditorFor) ========
    // but we need to allow editCharacter to actually work already implemented above.

    // ======== Initial render helper ========
    // Ensure localStorage structure exists
    if(!localStorage.getItem(STORAGE_USER)) localStorage.setItem(STORAGE_USER', JSON.stringify({username:'player1', role:'player'}));
    // Render initial grid
    // Note: after saving, grid is re-rendered in onSaveCharacter
  </script>
</body>
</html>



