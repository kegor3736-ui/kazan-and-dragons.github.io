<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Персонажи — Kazan & Dragons</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .character-editor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 2000;
      overflow-y: auto;
      padding: 1rem;
    }

    .character-sheet {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 1rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      margin: 0 auto;
      max-width: 1600px;
      width: 100%;
    }

    .character-header {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1rem;
      padding: 1rem;
      background: rgba(10, 8, 29, 0.8);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .hp-section {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1rem;
      padding: 1rem;
      background: rgba(10, 8, 29, 0.6);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .ability-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .center-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .right-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .ability-block {
      background: rgba(26, 20, 45, 0.8);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 1rem;
    }

    .ability-header {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--primary);
      padding-bottom: 0.5rem;
      text-align: center;
    }

    .ability-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .ability-card {
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .ability-score {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
      background: rgba(10, 8, 29, 0.7);
      border: 2px solid var(--primary-light);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text);
      text-align: center;
      width: 100%;
    }

    .ability-modifier {
      background: var(--primary);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .saving-throw, .skill {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(138, 43, 226, 0.2);
      font-size: 0.9rem;
    }

    .proficiency-bonus {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(138, 43, 226, 0.2);
      border-radius: 8px;
    }

    .death-saves {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .death-save-group {
      text-align: center;
    }

    .death-save-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: var(--accent);
    }

    .death-save-circles {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    .death-save-circle {
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .death-save-circle.filled {
      background: var(--accent);
    }

    .weapons-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    .weapons-table th,
    .weapons-table td {
      border: 1px solid var(--primary);
      padding: 0.5rem;
      text-align: left;
    }

    .weapons-table th {
      background: rgba(138, 43, 226, 0.3);
      color: var(--accent);
      font-weight: bold;
    }

    .coins-section {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .coin-group {
      text-align: center;
    }

    .coin-group label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      color: var(--accent);
      font-weight: bold;
    }

    .portrait-section {
      text-align: center;
      margin: 1rem 0;
    }

    .portrait-placeholder {
      width: 150px;
      height: 200px;
      background: rgba(26, 20, 45, 0.6);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.3s ease;
    }

    .portrait-placeholder:hover {
      border-color: var(--accent);
      background: rgba(138, 43, 226, 0.2);
    }

    .portrait-preview {
      max-width: 150px;
      max-height: 200px;
      border-radius: 8px;
      display: none;
      border: 2px solid var(--primary);
    }

    .section-title {
      color: var(--accent);
      border-bottom: 1px solid var(--primary);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .text-area {
      width: 100%;
      min-height: 100px;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--text);
      padding: 0.5rem;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-group {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.25rem 1rem 0.25rem 0;
      font-size: 0.9rem;
    }

    .checkbox-group label {
      cursor: pointer;
    }

    .proficiencies-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .initiative-speed {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-group {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      background: rgba(10, 8, 29, 0.7);
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .shield-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .shield-bonus {
      width: 60px;
      text-align: center;
    }

    .hit-dice-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .spellbook-section {
      grid-column: 1 / -1;
      margin-top: 1rem;
    }

    .spell-levels {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .spell-level {
      padding: 0.5rem 1rem;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
    }

    .spell-level.active {
      background: var(--primary);
      color: white;
    }

    .spell-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .spell-slot {
      text-align: center;
    }

    .spell-list {
      margin-top: 1rem;
    }

    .spell-item {
      background: rgba(10, 8, 29, 0.6);
      border: 1px solid var(--primary);
      border-radius: 4px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    .spell-item:hover {
      background: rgba(138, 43, 226, 0.2);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--accent);
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 0.5rem;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--primary);
    }

    .editor-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--primary);
    }

    .conditions-select {
      width: 100%;
      height: 120px;
      background: rgba(10, 8, 29, 0.7);
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--text);
      padding: 0.5rem;
    }

    .char-card .char-avatar-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      border: 2px solid var(--primary);
    }

    @media (max-width: 1600px) {
      .character-header {
        grid-template-columns: repeat(4, 1fr);
      }
      .hp-section {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .character-sheet {
        grid-template-columns: 1fr;
      }
      .character-header {
        grid-template-columns: repeat(3, 1fr);
      }
      .hp-section {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .character-header {
        grid-template-columns: repeat(2, 1fr);
      }
      .hp-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-sidebar">
      <div class="logo-icon"></div>
      <span>KAZAN & DRAGONS</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Главная</a></li>
      <li><a href="parties.html">Набор в партии</a></li>
      <li><a href="rules.html">Правила D&D</a></li>
      <li><a href="#" class="active">Персонажи</a></li>
      <li><a href="tabletop.html">Игровое поле</a></li>
      <li><a href="tokenator.html">Токенатор</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <header>
      <button class="menu-toggle" id="menuToggle">☰</button>
      <div class="account-widget">
        <div class="account-info" id="accountInfo">
          <div class="account-name" id="accountName">—</div>
          <div class="account-role" id="accountRole">—</div>
        </div>
        <button class="auth-btn" id="authButton">Войти / Регистрация</button>
      </div>
    </header>

    <div class="page-header">
      <h1>Хранилище персонажей</h1>
      <p>Создавайте и управляйте своими героями</p>
    </div>

    <div class="controls">
      <button class="new-char-btn" id="newCharBtn">+ Новый персонаж</button>
    </div>

    <!-- Сетка существующих персонажей -->
    <div class="characters-grid" id="charactersGrid">
      <!-- Персонажи будут отображаться здесь -->
    </div>

    <footer>
      <p>© 2025 Kazan & Dragons (K&D)</p>
    </footer>
  </div>

  <!-- Редактор персонажа (скрыт по умолчанию) -->
  <div class="character-editor" id="characterEditor">
    <div style="max-width: 1600px; margin: 0 auto; width: 100%;">
      <div class="editor-header">
        <h2 id="editorTitle">Создание персонажа</h2>
        <button class="btn btn-secondary" id="closeEditor">✕ Закрыть</button>
      </div>

      <!-- Кнопки управления в редакторе -->
      <div class="controls" style="background: transparent; padding: 0 0 1rem 0;">
        <button class="btn btn-primary" id="saveCharBtn">Сохранить персонажа</button>
        <button class="btn export-btn" id="exportJsonBtn">Экспорт в JSON</button>
      </div>

      <div class="character-sheet">
        <!-- ВЕРХНЯЯ ЧАСТЬ - ОСНОВНАЯ ИНФОРМАЦИЯ -->
        <div class="character-header">
          <div class="form-group">
            <label>Имя персонажа</label>
            <input type="text" id="charName" class="form-control" placeholder="Арагорн">
          </div>
          <div class="form-group">
            <label>Предыстория</label>
            <input type="text" id="charBackground" class="form-control" placeholder="Странник">
          </div>
          <div class="form-group">
            <label>Класс</label>
            <input type="text" id="charClass" class="form-control" placeholder="Воин">
          </div>
          <div class="form-group">
            <label>Раса</label>
            <input type="text" id="charRace" class="form-control" placeholder="Человек">
          </div>
          <div class="form-group">
            <label>Подкласс</label>
            <input type="text" id="charSubclass" class="form-control" placeholder="Паладин">
          </div>
          <div class="form-group">
            <label>Уровень</label>
            <input type="number" id="charLevel" class="form-control" value="1" min="1" max="20" readonly>
          </div>
          <div class="form-group">
            <label>Опыт</label>
            <input type="number" id="charExp" class="form-control" value="0">
          </div>
          <div class="form-group">
            <label>Класс защиты</label>
            <input type="number" id="armorClass" class="form-control" value="10">
          </div>
          <div class="form-group shield-toggle">
            <label>
              <input type="checkbox" id="shieldToggle"> Щит
            </label>
            <input type="number" id="shieldBonus" class="form-control" value="2" min="0" max="5" style="width: 60px;">
          </div>
        </div>

        <!-- БЛОК ХИТОВ -->
        <div class="hp-section">
          <div class="form-group">
            <label>Текущие хиты</label>
            <input type="number" id="currentHP" class="form-control" value="10" min="0">
          </div>
          <div class="form-group">
            <label>Временные хиты</label>
            <input type="number" id="tempHP" class="form-control" value="0" min="0">
          </div>
          <div class="form-group">
            <label>Максимум хитов</label>
            <input type="number" id="maxHP" class="form-control" value="10" min="1">
          </div>
          <div class="form-group">
            <label>Кости хитов:</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <select id="hitDiceType" class="form-control">
                <option value="d6">d6</option>
                <option value="d8">d8</option>
                <option value="d10" selected>d10</option>
                <option value="d12">d12</option>
              </select>
              <input type="number" id="hitDiceCount" class="form-control" value="1" min="0" style="width: 60px;">
            </div>
          </div>
          <div class="form-group">
            <label>Спасброски от смерти</label>
            <div class="death-saves">
              <div class="death-save-group">
                <label>Успехи</label>
                <div class="death-save-circles" id="successCircles">
                  <div class="death-save-circle" data-index="0"></div>
                  <div class="death-save-circle" data-index="1"></div>
                  <div class="death-save-circle" data-index="2"></div>
                </div>
              </div>
              <div class="death-save-group">
                <label>Провалы</label>
                <div class="death-save-circles" id="failureCircles">
                  <div class="death-save-circle" data-index="0"></div>
                  <div class="death-save-circle" data-index="1"></div>
                  <div class="death-save-circle" data-index="2"></div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-secondary" id="rollDeathSave" style="margin-top: 0.5rem; width: 100%;">
              Бросок спасброска
            </button>
          </div>
        </div>

        <!-- ЛЕВАЯ КОЛОНКА - ХАРАКТЕРИСТИКИ -->
        <div class="ability-column">
          <div class="proficiency-bonus">
            Бонус владения: <span id="proficiencyBonus">+2</span>
          </div>

          <!-- Первая строка характеристик -->
          <div class="ability-row">
            <!-- Сила -->
            <div class="ability-card">
              <div class="ability-header">СИЛА</div>
              <input type="number" id="strScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="strMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="strSave"> Спасбросок</label>
                <span id="strSaveMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="athletics"> Атлетика</label>
                <span id="athleticsMod">+0</span>
              </div>
            </div>

            <!-- Ловкость -->
            <div class="ability-card">
              <div class="ability-header">ЛОВКОСТЬ</div>
              <input type="number" id="dexScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="dexMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="dexSave"> Спасбросок</label>
                <span id="dexSaveMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="acrobatics"> Акробатика</label>
                <span id="acrobaticsMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="sleight"> Ловкость рук</label>
                <span id="sleightMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="stealth"> Скрытность</label>
                <span id="stealthMod">+0</span>
              </div>
            </div>
          </div>

          <!-- Вторая строка характеристик -->
          <div class="ability-row">
            <!-- Телосложение -->
            <div class="ability-card">
              <div class="ability-header">ТЕЛОСЛОЖЕНИЕ</div>
              <input type="number" id="conScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="conMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="conSave"> Спасбросок</label>
                <span id="conSaveMod">+0</span>
              </div>
            </div>

            <!-- Интеллект -->
            <div class="ability-card">
              <div class="ability-header">ИНТЕЛЛЕКТ</div>
              <input type="number" id="intScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="intMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="intSave"> Спасбросок</label>
                <span id="intSaveMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="investigation"> Анализ</label>
                <span id="investigationMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="history"> История</label>
                <span id="historyMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="arcana"> Магия</label>
                <span id="arcanaMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="nature"> Природа</label>
                <span id="natureMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="religion"> Религия</label>
                <span id="religionMod">+0</span>
              </div>
            </div>
          </div>

          <!-- Третья строка характеристик -->
          <div class="ability-row">
            <!-- Мудрость -->
            <div class="ability-card">
              <div class="ability-header">МУДРОСТЬ</div>
              <input type="number" id="wisScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="wisMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="wisSave"> Спасбросок</label>
                <span id="wisSaveMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="perception"> Внимательность</label>
                <span id="perceptionMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="survival"> Выживание</label>
                <span id="survivalMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="medicine"> Медицина</label>
                <span id="medicineMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="insight"> Проницательность</label>
                <span id="insightMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="animal"> Уход за животными</label>
                <span id="animalMod">+0</span>
              </div>
            </div>

            <!-- Харизма -->
            <div class="ability-card">
              <div class="ability-header">ХАРИЗМА</div>
              <input type="number" id="chaScore" class="ability-score" value="10" min="1" max="30">
              <div class="ability-modifier" id="chaMod">+0</div>
              <div class="saving-throw">
                <label><input type="checkbox" id="chaSave"> Спасбросок</label>
                <span id="chaSaveMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="performance"> Выступление</label>
                <span id="performanceMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="intimidation"> Запугивание</label>
                <span id="intimidationMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="deception"> Обман</label>
                <span id="deceptionMod">+0</span>
              </div>
              <div class="skill">
                <label><input type="checkbox" id="persuasion"> Убеждение</label>
                <span id="persuasionMod">+0</span>
              </div>
            </div>
          </div>

          <!-- Инициатива и скорость -->
          <div class="ability-block">
            <div class="initiative-speed">
              <div class="stat-group">
                <div class="ability-header">ИНИЦИАТИВА</div>
                <div class="stat-value" id="initiativeValue">+0</div>
              </div>
              <div class="stat-group">
                <div class="ability-header">СКОРОСТЬ</div>
                <div class="stat-value">
                  <input type="number" id="speedValue" class="form-control" value="30" style="text-align: center;">
                </div>
              </div>
            </div>
            <div class="stat-group" style="margin-top: 1rem;">
              <div class="ability-header">ПАССИВНОЕ ВОСПРИЯТИЕ</div>
              <div class="stat-value" id="passivePerceptionValue">10</div>
            </div>
          </div>
        </div>

        <!-- ЦЕНТРАЛЬНАЯ КОЛОНКА -->
        <div class="center-column">
          <div class="ability-block">
            <div class="section-title">СОСТОЯНИЯ</div>
            <select id="conditions" class="conditions-select" multiple>
              <option value="blinded">Ослеплен</option>
              <option value="charmed">Очарован</option>
              <option value="deafened">Оглох</option>
              <option value="frightened">Испуган</option>
              <option value="grappled">Схвачен</option>
              <option value="incapacitated">Недееспособен</option>
              <option value="invisible">Невидим</option>
              <option value="paralyzed">Парализован</option>
              <option value="petrified">Окаменевший</option>
              <option value="poisoned">Отравлен</option>
              <option value="prone">Лежит</option>
              <option value="restrained">Скован</option>
              <option value="stunned">Ошеломлен</option>
              <option value="unconscious">Без сознания</option>
            </select>
          </div>

          <div class="ability-block">
            <div class="section-title">ОРУЖИЕ И БОЕВЫЕ ЗАГОВОРЫ</div>
            <table class="weapons-table">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Бонус / Сложность</th>
                  <th>Урон / Вид</th>
                  <th>Заметки</th>
                </tr>
              </thead>
              <tbody id="weaponsTableBody">
                <tr>
                  <td><input type="text" class="form-control" placeholder="Длинный меч"></td>
                  <td><input type="text" class="form-control" placeholder="+5"></td>
                  <td><input type="text" class="form-control" placeholder="1d8 рубящий"></td>
                  <td><input type="text" class="form-control" placeholder=""></td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="btn btn-secondary" id="addWeapon" style="margin-top: 0.5rem; width: 100%;">
              + Добавить оружие
            </button>
          </div>

          <div class="ability-block">
            <div class="section-title">СПОСОБНОСТИ КЛАССА</div>
            <textarea id="classAbilities" class="text-area" placeholder="Способности класса..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">СПОСОБНОСТИ РАСЫ</div>
            <textarea id="raceAbilities" class="text-area" placeholder="Способности расы..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">ЧЕРТЫ</div>
            <textarea id="features" class="text-area" placeholder="Черты персонажа..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">ЗАМЕТКИ</div>
            <textarea id="notes" class="text-area" placeholder="Заметки..."></textarea>
          </div>
        </div>

        <!-- ПРАВАЯ КОЛОНКА -->
        <div class="right-column">
          <div class="ability-block">
            <div class="section-title">ВЛАДЕНИЕ СНАРЯЖЕНИЕМ</div>
            <div class="proficiencies-row">
              <div class="checkbox-group">
                <input type="checkbox" id="lightArmor">
                <label for="lightArmor">Лёгкие доспехи</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="mediumArmor">
                <label for="mediumArmor">Средние доспехи</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="heavyArmor">
                <label for="heavyArmor">Тяжёлые доспехи</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="shieldProficiency">
                <label for="shieldProficiency">Щиты</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="simpleWeapons">
                <label for="simpleWeapons">Простое оружие</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="martialWeapons">
                <label for="martialWeapons">Воинское оружие</label>
              </div>
            </div>
            
            <div style="margin-top: 1rem;">
              <div class="section-title">ИНСТРУМЕНТЫ И ЯЗЫКИ</div>
              <textarea id="toolProficiencies" class="text-area" placeholder="Инструменты и языки..."></textarea>
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">ПОРТРЕТ</div>
            <div class="portrait-section">
              <div class="portrait-placeholder" id="portraitPlaceholder">
                Нажмите для загрузки изображения
              </div>
              <img id="portraitPreview" class="portrait-preview" alt="Портрет персонажа">
              <input type="file" id="portraitUpload" accept="image/*" style="display: none;">
            </div>
          </div>

          <div class="ability-block">
            <div class="section-title">ЦЕЛИ И ЗАДАЧИ</div>
            <textarea id="goals" class="text-area" placeholder="Цели и задачи персонажа..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">ВНЕШНОСТЬ</div>
            <textarea id="appearance" class="text-area" placeholder="Описание внешности..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">ПРЕДЫСТОРИЯ</div>
            <textarea id="personality" class="text-area" placeholder="Личные качества и предыстория..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">СНАРЯЖЕНИЕ</div>
            <textarea id="equipment" class="text-area" placeholder="Снаряжение персонажа..."></textarea>
          </div>

          <div class="ability-block">
            <div class="section-title">МОНЕТЫ</div>
            <div class="coins-section">
              <div class="coin-group">
                <label>ММ</label>
                <input type="number" id="cp" class="form-control" value="0" min="0">
              </div>
              <div class="coin-group">
                <label>СМ</label>
                <input type="number" id="sp" class="form-control" value="0" min="0">
              </div>
              <div class="coin-group">
                <label>ЗМ</label>
                <input type="number" id="gp" class="form-control" value="0" min="0">
              </div>
              <div class="coin-group">
                <label>ЭМ</label>
                <input type="number" id="ep" class="form-control" value="0" min="0">
              </div>
              <div class="coin-group">
                <label>ПМ</label>
                <input type="number" id="pp" class="form-control" value="0" min="0">
              </div>
            </div>
          </div>
        </div>

        <!-- КНИГА ЗАКЛИНАНИЙ -->
        <div class="spellbook-section">
          <div class="ability-block">
            <div class="section-title">КНИГА ЗАКЛИНАНИЙ</div>
            
            <div class="spell-levels">
              <div class="spell-level active" data-level="0">Заговоры</div>
              <div class="spell-level" data-level="1">1 уровень</div>
              <div class="spell-level" data-level="2">2 уровень</div>
              <div class="spell-level" data-level="3">3 уровень</div>
              <div class="spell-level" data-level="4">4 уровень</div>
              <div class="spell-level" data-level="5">5 уровень</div>
              <div class="spell-level" data-level="6">6 уровень</div>
              <div class="spell-level" data-level="7">7 уровень</div>
              <div class="spell-level" data-level="8">8 уровень</div>
              <div class="spell-level" data-level="9">9 уровень</div>
            </div>

            <div class="spell-slots">
              <div class="spell-slot">
                <label>Ячейки заклинаний</label>
                <input type="number" class="form-control" value="0" min="0">
              </div>
              <div class="spell-slot">
                <label>Использовано</label>
                <input type="number" class="form-control" value="0" min="0">
              </div>
            </div>

            <div class="spell-list">
              <div class="spell-item">
                <strong>Огненный шар</strong> - 3 уровень, evocation
              </div>
              <div class="spell-item">
                <strong>Лечение ран</strong> - 1 уровень, evocation
              </div>
              <div class="spell-item">
                <strong>Волшебная стрела</strong> - 1 уровень, evocation
              </div>
            </div>

            <textarea id="spellbook" class="text-area" placeholder="Описание заклинаний..." style="min-height: 200px; margin-top: 1rem;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Базовый JavaScript для работы редактора
    document.addEventListener('DOMContentLoaded', function() {
      // Основные элементы
      const newCharBtn = document.getElementById('newCharBtn');
      const saveCharBtn = document.getElementById('saveCharBtn');
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const closeEditor = document.getElementById('closeEditor');
      const characterEditor = document.getElementById('characterEditor');
      const charactersGrid = document.getElementById('charactersGrid');
      const authButton = document.getElementById('authButton');
      const accountInfo = document.getElementById('accountInfo');
      const accountName = document.getElementById('accountName');
      const accountRole = document.getElementById('accountRole');

      let currentEditingCharacter = null;

      // Таблица опыта для уровней
      const expTable = {
        1: 0,
        2: 300,
        3: 900,
        4: 2700,
        5: 6500,
        6: 14000,
        7: 23000,
        8: 34000,
        9: 48000,
        10: 64000,
        11: 85000,
        12: 100000,
        13: 120000,
        14: 140000,
        15: 165000,
        16: 195000,
        17: 225000,
        18: 265000,
        19: 305000,
        20: 355000
      };

      // Проверка авторизации
      function checkAuth() {
        const user = JSON.parse(localStorage.getItem('kdUser'));
        if (user) {
          accountName.textContent = user.username;
          accountRole.textContent = user.role === 'player' ? 'Игрок' : 'Мастер';
          accountInfo.classList.add('active');
          authButton.textContent = 'Выйти';
          authButton.onclick = function() {
            localStorage.removeItem('kdUser');
            window.location.reload();
          };
          return true;
        } else {
          accountInfo.classList.remove('active');
          authButton.textContent = 'Войти / Регистрация';
          authButton.onclick = function() {
            window.location.href = 'register.html';
          };
          return false;
        }
      }

      // Показать редактор при нажатии "Новый персонаж"
      newCharBtn.addEventListener('click', function() {
        if (!checkAuth()) {
          alert('Для создания персонажа необходимо войти в систему.');
          return;
        }
        currentEditingCharacter = null;
        resetCharacterForm();
        document.getElementById('editorTitle').textContent = 'Создание персонажа';
        characterEditor.style.display = 'block';
        initCharacterSheet();
      });

      // Закрыть редактор
      closeEditor.addEventListener('click', function() {
        characterEditor.style.display = 'none';
        currentEditingCharacter = null;
      });

      // Сброс формы персонажа
      function resetCharacterForm() {
        // Сброс основных полей
        document.getElementById('charName').value = '';
        document.getElementById('charBackground').value = '';
        document.getElementById('charClass').value = '';
        document.getElementById('charRace').value = '';
        document.getElementById('charSubclass').value = '';
        document.getElementById('charLevel').value = '1';
        document.getElementById('charExp').value = '0';
        document.getElementById('armorClass').value = '10';
        document.getElementById('shieldToggle').checked = false;
        document.getElementById('shieldBonus').value = '2';
        document.getElementById('currentHP').value = '10';
        document.getElementById('tempHP').value = '0';
        document.getElementById('maxHP').value = '10';
        document.getElementById('hitDiceType').value = 'd10';
        document.getElementById('hitDiceCount').value = '1';
        document.getElementById('speedValue').value = '30';

        // Сброс характеристик
        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        abilities.forEach(ability => {
          document.getElementById(`${ability}Score`).value = '10';
          updateAbilityModifier(ability);
        });

        // Сброс навыков и спасбросков
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = false;
        });

        // Сброс состояний
        document.getElementById('conditions').selectedIndex = -1;

        // Сброс текстовых полей
        document.querySelectorAll('textarea').forEach(textarea => {
          textarea.value = '';
        });

        // Сброс спасбросков от смерти
        resetDeathSaves();

        // Сброс портрета
        document.getElementById('portraitPreview').style.display = 'none';
        document.getElementById('portraitPlaceholder').style.display = 'block';
        document.getElementById('portraitPreview').src = '';

        // Сброс оружия
        const tbody = document.getElementById('weaponsTableBody');
        tbody.innerHTML = `
          <tr>
            <td><input type="text" class="form-control" placeholder="Длинный меч"></td>
            <td><input type="text" class="form-control" placeholder="+5"></td>
            <td><input type="text" class="form-control" placeholder="1d8 рубящий"></td>
            <td><input type="text" class="form-control" placeholder=""></td>
          </tr>
        `;

        // Сброс монет
        document.getElementById('cp').value = '0';
        document.getElementById('sp').value = '0';
        document.getElementById('gp').value = '0';
        document.getElementById('ep').value = '0';
        document.getElementById('pp').value = '0';
      }

      // Инициализация листа персонажа
      function initCharacterSheet() {
        initAbilityScores();
        initSkills();
        initDeathSaves();
        initWeapons();
        initPortrait();
        initCalculations();
        initEventListeners();
        initSpellbook();
      }

      // Инициализация характеристик
      function initAbilityScores() {
        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        abilities.forEach(ability => {
          const scoreInput = document.getElementById(`${ability}Score`);
          if (scoreInput) {
            scoreInput.addEventListener('input', () => updateAbilityModifier(ability));
          }
        });
      }

      // Обновление модификаторов характеристик
      function updateAbilityModifier(abilityId) {
        const score = parseInt(document.getElementById(`${abilityId}Score`).value) || 10;
        const modifier = Math.floor((score - 10) / 2);
        const modElement = document.getElementById(`${abilityId}Mod`);
        
        if (modElement) {
          modElement.textContent = modifier >= 0 ? `+${modifier}` : modifier.toString();
        }
        
        updateSkills(abilityId);
        updateCalculations();
      }

      // Инициализация навыков
      function initSkills() {
        const skills = {
          str: ['athletics'],
          dex: ['acrobatics', 'sleight', 'stealth'],
          int: ['investigation', 'history', 'arcana', 'nature', 'religion'],
          wis: ['perception', 'survival', 'medicine', 'insight', 'animal'],
          cha: ['performance', 'intimidation', 'deception', 'persuasion']
        };

        Object.entries(skills).forEach(([ability, skillList]) => {
          skillList.forEach(skill => {
            const checkbox = document.getElementById(skill);
            if (checkbox) {
              checkbox.addEventListener('change', () => updateSkillModifier(skill, ability));
            }
          });
        });
      }

      function updateSkills(abilityId) {
        const skills = {
          str: ['athletics'],
          dex: ['acrobatics', 'sleight', 'stealth'],
          int: ['investigation', 'history', 'arcana', 'nature', 'religion'],
          wis: ['perception', 'survival', 'medicine', 'insight', 'animal'],
          cha: ['performance', 'intimidation', 'deception', 'persuasion']
        };

        if (skills[abilityId]) {
          skills[abilityId].forEach(skill => {
            updateSkillModifier(skill, abilityId);
          });
        }
      }

      function updateSkillModifier(skill, ability) {
        const abilityScore = parseInt(document.getElementById(`${ability}Score`).value) || 10;
        const abilityMod = Math.floor((abilityScore - 10) / 2);
        const isProficient = document.getElementById(skill).checked;
        const proficiencyBonus = parseInt(document.getElementById('proficiencyBonus').textContent.replace('+', '')) || 2;
        const totalMod = abilityMod + (isProficient ? proficiencyBonus : 0);
        
        const modElement = document.getElementById(`${skill}Mod`);
        if (modElement) {
          modElement.textContent = totalMod >= 0 ? `+${totalMod}` : totalMod.toString();
        }
      }

      // Инициализация спасбросков от смерти
      function initDeathSaves() {
        const rollButton = document.getElementById('rollDeathSave');
        if (rollButton) {
          rollButton.addEventListener('click', rollDeathSave);
        }

        // Обработчики для кружков
        document.querySelectorAll('.death-save-circle').forEach(circle => {
          circle.addEventListener('click', function() {
            this.classList.toggle('filled');
          });
        });
      }

      // Бросок спасброска от смерти
      function rollDeathSave() {
        const roll = Math.floor(Math.random() * 20) + 1;
        alert(`Бросок спасброска от смерти: ${roll}`);
        
        if (roll === 1) {
          // Критический провал - два провала
          addDeathFailure();
          addDeathFailure();
        } else if (roll < 10) {
          addDeathFailure();
        } else if (roll === 20) {
          // Критический успех - восстанавливаем 1 хп и сбрасываем спасброски
          alert('Критический успех! Персонаж восстанавливает 1 хп!');
          resetDeathSaves();
          const currentHP = parseInt(document.getElementById('currentHP').value) || 0;
          document.getElementById('currentHP').value = currentHP + 1;
        } else {
          addDeathSuccess();
        }
        
        checkDeathSaves();
      }

      function addDeathSuccess() {
        const circles = document.querySelectorAll('#successCircles .death-save-circle');
        for (let circle of circles) {
          if (!circle.classList.contains('filled')) {
            circle.classList.add('filled');
            break;
          }
        }
      }

      function addDeathFailure() {
        const circles = document.querySelectorAll('#failureCircles .death-save-circle');
        for (let circle of circles) {
          if (!circle.classList.contains('filled')) {
            circle.classList.add('filled');
            break;
          }
        }
      }

      function resetDeathSaves() {
        document.querySelectorAll('.death-save-circle').forEach(circle => {
          circle.classList.remove('filled');
        });
      }

      function checkDeathSaves() {
        const successCount = document.querySelectorAll('#successCircles .death-save-circle.filled').length;
        const failureCount = document.querySelectorAll('#failureCircles .death-save-circle.filled').length;
        
        if (successCount >= 3) {
          alert('Три успешных спасброска! Персонаж стабилизирован.');
          resetDeathSaves();
        } else if (failureCount >= 3) {
          alert('Три провальных спасброска! Персонаж умирает.');
          resetDeathSaves();
        }
      }

      // Инициализация оружия
      function initWeapons() {
        const addButton = document.getElementById('addWeapon');
        if (addButton) {
          addButton.addEventListener('click', addWeaponRow);
        }
      }

      function addWeaponRow() {
        const tbody = document.getElementById('weaponsTableBody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td><input type="text" class="form-control" placeholder="Название оружия"></td>
          <td><input type="text" class="form-control" placeholder="Бонус атаки"></td>
          <td><input type="text" class="form-control" placeholder="Урон и тип"></td>
          <td><input type="text" class="form-control" placeholder="Заметки"></td>
        `;
        tbody.appendChild(newRow);
      }

      // Инициализация портрета
      function initPortrait() {
        const placeholder = document.getElementById('portraitPlaceholder');
        const upload = document.getElementById('portraitUpload');
        
        if (placeholder && upload) {
          placeholder.addEventListener('click', () => upload.click());
          upload.addEventListener('change', handlePortraitUpload);
        }
      }

      function handlePortraitUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('portraitPreview');
            const placeholder = document.getElementById('portraitPlaceholder');
            
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      }

      // Инициализация расчетов
      function initCalculations() {
        // Обновляем инициативу (модификатор ловкости)
        const dexScore = parseInt(document.getElementById('dexScore').value) || 10;
        const dexMod = Math.floor((dexScore - 10) / 2);
        document.getElementById('initiativeValue').textContent = dexMod >= 0 ? `+${dexMod}` : dexMod.toString();
        
        // Обновляем пассивное восприятие
        updatePassivePerception();
        
        // Обновляем класс защиты с учетом щита
        updateArmorClass();
        
        // Обновляем бонус владения на основе уровня
        updateProficiencyBonus();
      }

      function updatePassivePerception() {
        const wisScore = parseInt(document.getElementById('wisScore').value) || 10;
        const wisMod = Math.floor((wisScore - 10) / 2);
        const perceptionProficient = document.getElementById('perception').checked;
        const proficiencyBonus = parseInt(document.getElementById('proficiencyBonus').textContent.replace('+', '')) || 2;
        const passivePerception = 10 + wisMod + (perceptionProficient ? proficiencyBonus : 0);
        document.getElementById('passivePerceptionValue').textContent = passivePerception;
      }

      function updateArmorClass() {
        const baseAC = parseInt(document.getElementById('armorClass').value) || 10;
        const shieldActive = document.getElementById('shieldToggle').checked;
        const shieldBonus = shieldActive ? parseInt(document.getElementById('shieldBonus').value) || 0 : 0;
        document.getElementById('armorClass').value = baseAC + shieldBonus;
      }

      function updateProficiencyBonus() {
        const level = parseInt(document.getElementById('charLevel').value) || 1;
        let bonus = 2;
        if (level >= 5) bonus = 3;
        if (level >= 9) bonus = 4;
        if (level >= 13) bonus = 5;
        if (level >= 17) bonus = 6;
        document.getElementById('proficiencyBonus').textContent = `+${bonus}`;
      }

      // Автоматическое обновление уровня на основе опыта
      function updateLevelFromExp() {
        const exp = parseInt(document.getElementById('charExp').value) || 0;
        let level = 1;
        
        for (let i = 20; i >= 1; i--) {
          if (exp >= expTable[i]) {
            level = i;
            break;
          }
        }
        
        document.getElementById('charLevel').value = level;
        updateProficiencyBonus();
      }

      // Инициализация книги заклинаний
      function initSpellbook() {
        const spellLevels = document.querySelectorAll('.spell-level');
        spellLevels.forEach(level => {
          level.addEventListener('click', function() {
            spellLevels.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            // Здесь можно добавить логику загрузки заклинаний выбранного уровня
          });
        });
      }

      // Инициализация обработчиков событий
      function initEventListeners() {
        // Обработчики для обновления расчетов
        document.getElementById('dexScore').addEventListener('input', () => {
          const dexScore = parseInt(document.getElementById('dexScore').value) || 10;
          const dexMod = Math.floor((dexScore - 10) / 2);
          document.getElementById('initiativeValue').textContent = dexMod >= 0 ? `+${dexMod}` : dexMod.toString();
        });

        document.getElementById('wisScore').addEventListener('input', updatePassivePerception);
        document.getElementById('perception').addEventListener('change', updatePassivePerception);
        
        document.getElementById('shieldToggle').addEventListener('change', updateArmorClass);
        document.getElementById('shieldBonus').addEventListener('input', updateArmorClass);

        // Обработчик для опыта
        document.getElementById('charExp').addEventListener('input', updateLevelFromExp);

        // Валидация хитов
        document.getElementById('currentHP').addEventListener('change', function() {
          let current = parseInt(this.value) || 0;
          const max = parseInt(document.getElementById('maxHP').value) || 0;
          if (current < 0) this.value = 0;
          if (current > max) this.value = max;
        });

        // Кнопки управления
        document.getElementById('saveCharBtn').addEventListener('click', saveCharacter);
        document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
      }

      // Сохранение персонажа
      function saveCharacter() {
        const characterData = getCharacterData();
        
        // Получаем текущий список персонажей
        let characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
        const user = JSON.parse(localStorage.getItem('kdUser'));
        
        // Добавляем владельца
        characterData.owner = user.username;
        
        if (currentEditingCharacter) {
          // Редактирование существующего персонажа
          const index = characters.findIndex(char => char.id === currentEditingCharacter);
          if (index !== -1) {
            characters[index] = { ...characters[index], ...characterData };
          }
        } else {
          // Создание нового персонажа
          characterData.id = Date.now();
          characters.push(characterData);
        }
        
        localStorage.setItem('kdCharacters', JSON.stringify(characters));
        
        alert(`Персонаж "${characterData.name}" успешно ${currentEditingCharacter ? 'обновлен' : 'создан'}!`);
        characterEditor.style.display = 'none';
        renderCharactersGrid();
      }

      // Экспорт в JSON
      function exportToJson() {
        const characterData = getCharacterData();
        const jsonString = JSON.stringify(characterData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${characterData.name || 'character'}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Получение данных персонажа
      function getCharacterData() {
        // Собираем выбранные состояния
        const conditions = Array.from(document.getElementById('conditions').selectedOptions)
          .map(option => option.value);

        return {
          name: document.getElementById('charName').value,
          background: document.getElementById('charBackground').value,
          class: document.getElementById('charClass').value,
          race: document.getElementById('charRace').value,
          subclass: document.getElementById('charSubclass').value,
          level: parseInt(document.getElementById('charLevel').value) || 1,
          exp: parseInt(document.getElementById('charExp').value) || 0,
          armorClass: parseInt(document.getElementById('armorClass').value) || 10,
          currentHP: parseInt(document.getElementById('currentHP').value) || 0,
          tempHP: parseInt(document.getElementById('tempHP').value) || 0,
          maxHP: parseInt(document.getElementById('maxHP').value) || 0,
          hitDice: document.getElementById('hitDiceCount').value + document.getElementById('hitDiceType').value,
          portrait: document.getElementById('portraitPreview').src || '',
          conditions: conditions,
          // ... остальные поля
        };
      }

      // Загрузка данных персонажа в форму для редактирования
      function loadCharacterData(character) {
        document.getElementById('charName').value = character.name || '';
        document.getElementById('charBackground').value = character.background || '';
        document.getElementById('charClass').value = character.class || '';
        document.getElementById('charRace').value = character.race || '';
        document.getElementById('charSubclass').value = character.subclass || '';
        document.getElementById('charLevel').value = character.level || 1;
        document.getElementById('charExp').value = character.exp || 0;
        document.getElementById('armorClass').value = character.armorClass || 10;
        document.getElementById('currentHP').value = character.currentHP || 10;
        document.getElementById('tempHP').value = character.tempHP || 0;
        document.getElementById('maxHP').value = character.maxHP || 10;
        
        // Загрузка портрета
        if (character.portrait) {
          document.getElementById('portraitPreview').src = character.portrait;
          document.getElementById('portraitPreview').style.display = 'block';
          document.getElementById('portraitPlaceholder').style.display = 'none';
        }

        // Загрузка состояний
        if (character.conditions) {
          const conditionsSelect = document.getElementById('conditions');
          character.conditions.forEach(condition => {
            for (let i = 0; i < conditionsSelect.options.length; i++) {
              if (conditionsSelect.options[i].value === condition) {
                conditionsSelect.options[i].selected = true;
                break;
              }
            }
          });
        }

        // Обновляем расчеты
        initCalculations();
      }

      // Отображение сетки персонажей
      function renderCharactersGrid() {
        const characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
        const user = JSON.parse(localStorage.getItem('kdUser'));
        const userCharacters = characters.filter(char => char.owner === user.username);

        if (userCharacters.length === 0) {
          charactersGrid.innerHTML = `
            <div class="empty-state">
              <p>У вас пока нет персонажей.</p>
              <p style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.8;">
                Нажмите «+ Новый персонаж», чтобы создать первого героя!
              </p>
            </div>
          `;
          return;
        }

        charactersGrid.innerHTML = userCharacters.map(char => `
          <div class="char-card">
            ${char.portrait ? 
              `<img src="${char.portrait}" class="char-avatar-img" alt="${char.name}">` : 
              `<div class="char-avatar">${char.name?.charAt(0) || '?'}</div>`
            }
            <div class="char-name">${char.name || 'Безымянный'}</div>
            <div class="char-class-level">${char.class || '—'}, ${char.level || 1} ур.</div>
            <div class="char-details">
              Раса: ${char.race || '—'}<br>
              HP: ${char.currentHP || 0}/${char.maxHP || 0}
            </div>
            <div class="char-actions">
              <button class="char-btn edit-btn" data-id="${char.id}">Редактировать</button>
              <button class="char-btn delete-btn" data-id="${char.id}">Удалить</button>
            </div>
          </div>
        `).join('');

        // Добавляем обработчики для кнопок редактирования и удаления
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const charId = parseInt(this.getAttribute('data-id'));
            editCharacter(charId);
          });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const charId = parseInt(this.getAttribute('data-id'));
            if (confirm('Удалить этого персонажа?')) {
              deleteCharacter(charId);
            }
          });
        });
      }

      function editCharacter(charId) {
        const characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
        const character = characters.find(char => char.id === charId);
        
        if (character) {
          currentEditingCharacter = charId;
          document.getElementById('editorTitle').textContent = 'Редактирование персонажа';
          loadCharacterData(character);
          characterEditor.style.display = 'block';
          initCharacterSheet();
        }
      }

      function deleteCharacter(charId) {
        let characters = JSON.parse(localStorage.getItem('kdCharacters')) || [];
        characters = characters.filter(char => char.id !== charId);
        localStorage.setItem('kdCharacters', JSON.stringify(characters));
        renderCharactersGrid();
      }

      // Инициализация при загрузке
      checkAuth();
      renderCharactersGrid();
    });
  </script>

</body>
</html>




