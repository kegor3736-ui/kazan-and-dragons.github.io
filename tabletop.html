<<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6a0dad" />
    <meta name="description" content="A more bear-able virtual tabletop" />

    <meta property="og:title" content="K&D Tabletop" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.knd-tabletop.app" />
    <meta property="og:image" content="https://images.owlbear.rodeo/shared/backgrounds/10.jpg?class=social" />

    <meta name="twitter:title" content="K&D Tabletop" />
    <meta
      name="twitter:description"
      content="Join your party in The Mauve Root"
    />
    <meta name="twitter:image" content="https://images.owlbear.rodeo/shared/backgrounds/10.jpg?class=social" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />
    <title>K&D Tabletop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* =============== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =============== */
      :root {
        --primary: #6a0dad;
        --primary-light: #8a2be2;
        --primary-dark: #4b0082;
        --accent: #e0b0ff;
        --text: #f8f8ff;
        --bg: #0f0c1d;
        --card-bg: #1a142d;
        --sidebar-width: 280px;
        --success: #4ade80;
        --error: #f87171;
      }

      /* =============== СБРОС И БАЗА =============== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        line-height: 1.6;
        overflow-x: hidden;
      }

      /* Глобальный фон сайта */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('https://i.pinimg.com/736x/c9/6b/af/c96baf75b018d3f5160c7738b5c9753e.jpg') no-repeat center center/cover;
        opacity: 0.08;
        z-index: -1;
        pointer-events: none;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      /* =============== БОКОВАЯ ПАНЕЛЬ =============== */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(160deg, var(--primary-dark), var(--card-bg));
        padding: 2rem 1.2rem;
        z-index: 1000;
        transform: translateX(0);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        box-shadow: 5px 0 25px rgba(0, 0, 0, 0.6);
        overflow-y: auto;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .logo-sidebar {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
        margin-bottom: 2rem;
        white-space: nowrap;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        background: url('https://placehold.co/50x50/8a2be2/ffffff?text=K%26D') no-repeat center;
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
      }

      .nav-links {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .nav-links a {
        color: var(--text);
        text-decoration: none;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover, .nav-links a.active {
        background: rgba(138, 43, 226, 0.2);
        color: var(--accent);
      }

      .tools {
        margin-top: auto;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .tool-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .tool-btn:hover, .tool-btn.active {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      /* =============== ОСНОВНОЙ КОНТЕНТ =============== */
      .main-content {
        margin-left: var(--sidebar-width);
        transition: margin-left 0.5s ease;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .main-content.sidebar-hidden {
        margin-left: 0;
      }

      .content-wrapper {
        flex: 1;
      }

      /* =============== ШАПКА =============== */
      .tabletop-header {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .menu-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 1.6rem;
        cursor: pointer;
        transition: transform 0.4s ease;
      }

      .menu-toggle:hover {
        transform: rotate(90deg);
        color: var(--accent);
      }

      .map-selector {
        display: flex;
        gap: 0.6rem;
      }

      .map-option {
        padding: 0.4rem 0.8rem;
        background: rgba(10, 8, 29, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .map-option.active {
        background: var(--primary);
        border-color: var(--primary-light);
      }

      /* =============== ИГРОВОЕ ПОЛЕ =============== */
      .game-board {
        flex: 1;
        position: relative;
        background: #151025;
        overflow: hidden;
        cursor: crosshair;
      }

      .board-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.85;
        transition: opacity 0.3s ease;
      }

      /* Сетка */
      .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(rgba(224, 176, 255, 0.2) 1px, transparent 1px),
          linear-gradient(90deg, rgba(224, 176, 255, 0.2) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
        z-index: 5;
      }

      .token {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        transform: translate(-50%, -50%);
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        transition: all 0.2s ease;
        z-index: 10;
      }

      .token:hover {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.7);
      }

      .token.selected {
        border: 2px solid var(--accent);
        box-shadow: 0 0 15px var(--accent);
      }

      .token-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      /* =============== ВЫБОР ТОКЕНОВ =============== */
      .token-selector {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .token-selector-title {
        font-size: 0.9rem;
        color: var(--accent);
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .token-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 150px;
        overflow-y: auto;
        padding: 0.5rem;
        background: rgba(10, 8, 29, 0.5);
        border-radius: 6px;
      }

      .token-item {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        overflow: hidden;
      }

      .token-item:hover {
        transform: scale(1.1);
        border-color: var(--accent);
      }

      .token-item.selected {
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
      }

      .token-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* =============== ЧАТ =============== */
      .chat-panel {
        position: absolute;
        bottom: 1.5rem;
        right: 1.5rem;
        width: 320px;
        height: 280px;
        background: rgba(10, 8, 29, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        z-index: 100;
      }

      .chat-header {
        padding: 0.6rem 1rem;
        background: rgba(26, 20, 45, 0.8);
        border-bottom: 1px solid rgba(138, 43, 226, 0.3);
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-toggle {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 1rem;
      }

      .chat-messages {
        flex: 1;
        padding: 0.8rem;
        overflow-y: auto;
        font-size: 0.85rem;
      }

      .message {
        margin-bottom: 0.6rem;
        line-height: 1.4;
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
      }

      .message:hover {
        background: rgba(138, 43, 226, 0.1);
      }

      .message strong {
        color: var(--accent);
      }

      .chat-input {
        display: flex;
        padding: 0.5rem;
        background: rgba(26, 20, 45, 0.8);
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .chat-input input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        background: rgba(5, 3, 15, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 4px;
        color: var(--text);
        font-size: 0.85rem;
      }

      .chat-input button {
        margin-left: 0.5rem;
        padding: 0.4rem 0.8rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .chat-input button:hover {
        background: var(--primary);
      }

      /* =============== КНОПКИ =============== */
      .btn, .submit-btn, .post-btn, .new-char-btn, .apply-btn, .chat-btn, .filter-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        text-align: center;
      }

      .btn {
        padding: 0.9rem 1.8rem;
        border-radius: 50px;
        font-weight: 700;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(138, 43, 226, 0.5);
      }

      .btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .btn:hover::after {
        transform: translateX(100%);
      }

      .btn-primary, .submit-btn, .post-btn, .new-char-btn, .apply-btn {
        background: var(--primary-light);
        color: white;
      }

      .btn-primary:hover, .submit-btn:hover, .post-btn:hover, .new-char-btn:hover, .apply-btn:hover {
        background: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
      }

      .btn-secondary, .chat-btn {
        background: transparent;
        color: var(--accent);
        border: 2px solid var(--accent);
      }

      .btn-secondary:hover, .chat-btn:hover {
        background: rgba(224, 176, 255, 0.1);
        transform: translateY(-3px);
      }

      /* =============== УВЕДОМЛЕНИЯ =============== */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transform: translateX(150%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      /* =============== МОДАЛЬНЫЕ ОКНА =============== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: linear-gradient(145deg, var(--card-bg), #221a3a);
        border-radius: 20px;
        padding: 2.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(138, 43, 226, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.3rem;
        color: var(--accent);
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text);
        font-size: 1.5rem;
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 1.4rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--accent);
        font-weight: 600;
      }

      .form-control {
        width: 100%;
        padding: 0.85rem 1.1rem;
        background: rgba(10, 8, 29, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 10px;
        color: var(--text);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
      }

      .file-input {
        display: none;
      }

      .file-label {
        display: block;
        padding: 1rem;
        background: rgba(10, 8, 29, 0.7);
        border: 2px dashed rgba(138, 43, 226, 0.4);
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .file-label:hover {
        border-color: var(--primary);
        background: rgba(138, 43, 226, 0.1);
      }

      .preview-container {
        margin-top: 1rem;
        text-align: center;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 0.5rem;
      }

      /* =============== ДОПОЛНИТЕЛЬНЫЕ СТИЛИ =============== */
      .tool-btn i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
      }

      .zoom-controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(10, 8, 29, 0.8);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        padding: 8px;
        display: flex;
        gap: 5px;
        z-index: 50;
      }

      .zoom-btn {
        width: 30px;
        height: 30px;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .zoom-btn:hover {
        background: var(--primary);
      }

      .map-manager {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .map-manager-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .map-manager-btn:hover {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      .token-manager {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .token-manager-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .token-manager-btn:hover {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      /* =============== АДАПТИВНОСТЬ =============== */
      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (max-width: 576px) {
        :root { --sidebar-width: 100%; }
        .sidebar { width: 100%; height: 100vh; }
        .main-content.sidebar-hidden { position: relative; }
        .chat-panel { display: none; }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-sidebar">
        <div class="logo-icon"></div>
        <span>K&D Tabletop</span>
      </div>
      <ul class="nav-links">
        <li><a href="#" class="active">Game Table</a></li>
        <li><a href="#">Characters</a></li>
        <li><a href="#">Parties</a></li>
        <li><a href="#">Rules</a></li>
        <li><a href="#">Settings</a></li>
      </ul>

      <div class="tools">
        <button class="tool-btn active" data-tool="token"><i class="fas fa-user"></i> Place Token</button>
        <button class="tool-btn" data-tool="eraser"><i class="fas fa-eraser"></i> Eraser</button>
        <button class="tool-btn" data-tool="select"><i class="fas fa-mouse-pointer"></i> Select</button>
        <button class="tool-btn" id="clearBoard"><i class="fas fa-trash"></i> Clear Board</button>
      </div>

      <!-- Выбор токенов -->
      <div class="token-selector">
        <div class="token-selector-title">Select Token:</div>
        <div class="token-list" id="tokenList">
          <!-- Токены будут добавляться динамически -->
        </div>
      </div>

      <div class="map-manager">
        <button class="map-manager-btn" id="loadMapBtn"><i class="fas fa-upload"></i> Load Map</button>
        <button class="map-manager-btn" id="editMapBtn"><i class="fas fa-edit"></i> Edit Map</button>
      </div>

      <div class="token-manager">
        <button class="token-manager-btn" id="loadTokenBtn"><i class="fas fa-upload"></i> Load Token</button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="tabletop-header">
        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-bars"></i>
        </button>
        <div id="currentMapName">Game Table</div>
        <div class="map-selector" id="mapSelector">
          <!-- Map options will be dynamically added here -->
        </div>
      </header>

      <div class="game-board" id="gameBoard">
        <img src="https://images.owlbear.rodeo/shared/backgrounds/10.jpg" class="board-image" id="boardImage">
        <div class="grid-overlay"></div>
        <!-- Tokens will be added here -->
        
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoomIn"><i class="fas fa-search-plus"></i></button>
          <button class="zoom-btn" id="zoomOut"><i class="fas fa-search-minus"></i></button>
          <button class="zoom-btn" id="resetZoom"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>

      <div class="chat-panel">
        <div class="chat-header">
          <span>Party Chat</span>
          <button class="chat-toggle" id="toggleChat"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="message"><strong>System:</strong> Game table loaded. Use tools on the left to add tokens.</div>
          <div class="message"><strong>DM:</strong> Welcome to our adventure!</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100">
          <button id="sendChat" class="btn-primary"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal" id="mapModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="mapModalTitle">Load Map</h3>
          <button class="modal-close" id="closeMapModal">&times;</button>
        </div>
        <form id="mapForm">
          <div class="form-group">
            <label for="mapName">Map Name</label>
            <input type="text" id="mapName" class="form-control" placeholder="Enter map name">
          </div>
          <div class="form-group">
            <label for="mapFile">Map File</label>
            <input type="file" id="mapFile" class="file-input" accept="image/*">
            <label for="mapFile" class="file-label" id="mapFileLabel">
              <i class="fas fa-cloud-upload-alt"></i><br>
              Click to upload image
            </label>
            <div class="preview-container" id="mapPreviewContainer" style="display: none;">
              <div>Preview:</div>
              <img id="mapPreview" class="preview-image">
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelMapBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveMapBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="tokenModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="tokenModalTitle">Load Token</h3>
          <button class="modal-close" id="closeTokenModal">&times;</button>
        </div>
        <form id="tokenForm">
          <div class="form-group">
            <label for="tokenName">Token Name</label>
            <input type="text" id="tokenName" class="form-control" placeholder="Enter token name">
          </div>
          <div class="form-group">
            <label for="tokenFile">Token File</label>
            <input type="file" id="tokenFile" class="file-input" accept="image/*">
            <label for="tokenFile" class="file-label" id="tokenFileLabel">
              <i class="fas fa-cloud-upload-alt"></i><br>
              Click to upload image
            </label>
            <div class="preview-container" id="tokenPreviewContainer" style="display: none;">
              <div>Preview:</div>
              <img id="tokenPreview" class="preview-image">
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelTokenBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveTokenBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="notification" id="notification">Message</div>

    <script>
      // DOM elements
      const gameBoard = document.getElementById('gameBoard');
      const boardImage = document.getElementById('boardImage');
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      const sendChatBtn = document.getElementById('sendChat');
      const toolBtns = document.querySelectorAll('.tool-btn[data-tool]');
      const clearBoardBtn = document.getElementById('clearBoard');
      const toggleChatBtn = document.getElementById('toggleChat');
      const notification = document.getElementById('notification');
      const zoomInBtn = document.getElementById('zoomIn');
      const zoomOutBtn = document.getElementById('zoomOut');
      const resetZoomBtn = document.getElementById('resetZoom');
      const mapSelector = document.getElementById('mapSelector');
      const currentMapName = document.getElementById('currentMapName');
      const tokenList = document.getElementById('tokenList');
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');
      
      // Modal elements
      const mapModal = document.getElementById('mapModal');
      const tokenModal = document.getElementById('tokenModal');
      const loadMapBtn = document.getElementById('loadMapBtn');
      const editMapBtn = document.getElementById('editMapBtn');
      const loadTokenBtn = document.getElementById('loadTokenBtn');
      const closeMapModal = document.getElementById('closeMapModal');
      const closeTokenModal = document.getElementById('closeTokenModal');
      const cancelMapBtn = document.getElementById('cancelMapBtn');
      const cancelTokenBtn = document.getElementById('cancelTokenBtn');
      const mapForm = document.getElementById('mapForm');
      const tokenForm = document.getElementById('tokenForm');
      const mapFile = document.getElementById('mapFile');
      const tokenFile = document.getElementById('tokenFile');
      const mapPreview = document.getElementById('mapPreview');
      const tokenPreview = document.getElementById('tokenPreview');
      const mapPreviewContainer = document.getElementById('mapPreviewContainer');
      const tokenPreviewContainer = document.getElementById('tokenPreviewContainer');
      const mapName = document.getElementById('mapName');
      const tokenName = document.getElementById('tokenName');
      const mapModalTitle = document.getElementById('mapModalTitle');

      // State
      let currentTool = 'token';
      let selectedToken = null;
      let isDragging = false;
      let zoomLevel = 1;
      let editingMapId = null;
      let selectedTokenId = null;

      // Data storage
      let maps = JSON.parse(localStorage.getItem('obMaps')) || [
        { id: 'mauve-root', name: 'The Mauve Root', url: 'https://images.owlbear.rodeo/shared/backgrounds/10.jpg' },
        { id: 'forest', name: 'Enchanted Forest', url: 'https://images.owlbear.rodeo/shared/backgrounds/2.jpg' },
        { id: 'dungeon', name: 'Ancient Dungeon', url: 'https://images.owlbear.rodeo/shared/backgrounds/5.jpg' }
      ];
      
      let tokens = JSON.parse(localStorage.getItem('obTokens')) || [];
      let currentMapId = 'mauve-root';

      // Initialize
      function init() {
        renderMapSelector();
        renderTokenList();
        updateCurrentMap();
        showNotification('Game table ready to use');
      }

      // Toggle sidebar
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('sidebar-hidden');
      });

      // Render map selector
      function renderMapSelector() {
        mapSelector.innerHTML = '';
        maps.forEach(map => {
          const option = document.createElement('div');
          option.className = `map-option ${map.id === currentMapId ? 'active' : ''}`;
          option.dataset.map = map.id;
          option.textContent = map.name;
          option.addEventListener('click', () => {
            selectMap(map.id);
          });
          mapSelector.appendChild(option);
        });
      }

      // Render token list
      function renderTokenList() {
        tokenList.innerHTML = '';
        
        if (tokens.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.textContent = 'No tokens';
          emptyMsg.style.color = '#888';
          emptyMsg.style.textAlign = 'center';
          emptyMsg.style.width = '100%';
          emptyMsg.style.padding = '10px';
          tokenList.appendChild(emptyMsg);
          return;
        }
        
        tokens.forEach(token => {
          const tokenItem = document.createElement('div');
          tokenItem.className = `token-item ${token.id === selectedTokenId ? 'selected' : ''}`;
          tokenItem.dataset.tokenId = token.id;
          
          const tokenImg = document.createElement('img');
          tokenImg.src = token.url;
          tokenImg.alt = token.name;
          
          tokenItem.appendChild(tokenImg);
          tokenItem.addEventListener('click', () => {
            selectToken(token.id);
          });
          
          tokenList.appendChild(tokenItem);
        });
      }

      // Select token
      function selectToken(tokenId) {
        selectedTokenId = tokenId;
        renderTokenList();
        showNotification(`Selected token: ${tokens.find(t => t.id === tokenId)?.name}`);
      }

      // Select map
      function selectMap(mapId) {
        currentMapId = mapId;
        const map = maps.find(m => m.id === mapId);
        if (map) {
          boardImage.src = map.url;
          currentMapName.textContent = map.name;
          renderMapSelector();
          showNotification(`Map changed: ${map.name}`);
        }
      }

      // Update current map display
      function updateCurrentMap() {
        const map = maps.find(m => m.id === currentMapId);
        if (map) {
          currentMapName.textContent = map.name;
        }
      }

      // Select tool
      toolBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          toolBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTool = btn.dataset.tool;
          
          // Reset cursor
          gameBoard.style.cursor = 'crosshair';
          if (currentTool === 'select') gameBoard.style.cursor = 'default';
          if (currentTool === 'eraser') gameBoard.style.cursor = 'not-allowed';
          
          showNotification(`Tool: ${btn.textContent.trim()}`);
        });
      });

      // Clear board
      clearBoardBtn.addEventListener('click', () => {
        if (confirm('Clear the entire board?')) {
          document.querySelectorAll('.token').forEach(t => t.remove());
          showNotification('Board cleared');
        }
      });

      // Toggle chat
      toggleChatBtn.addEventListener('click', () => {
        const chatPanel = document.querySelector('.chat-panel');
        const isHidden = chatPanel.style.height === '40px';
        
        if (isHidden) {
          chatPanel.style.height = '280px';
          toggleChatBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        } else {
          chatPanel.style.height = '40px';
          toggleChatBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
      });

      // Zoom controls
      zoomInBtn.addEventListener('click', () => {
        if (zoomLevel < 2) {
          zoomLevel += 0.1;
          updateZoom();
        }
      });

      zoomOutBtn.addEventListener('click', () => {
        if (zoomLevel > 0.5) {
          zoomLevel -= 0.1;
          updateZoom();
        }
      });

      resetZoomBtn.addEventListener('click', () => {
        zoomLevel = 1;
        updateZoom();
      });

      function updateZoom() {
        boardImage.style.transform = `scale(${zoomLevel})`;
        showNotification(`Zoom: ${Math.round(zoomLevel * 100)}%`);
      }

      // Add token on click
      gameBoard.addEventListener('click', (e) => {
        if (currentTool === 'token') {
          if (!selectedTokenId) {
            showNotification('First select a token from the list');
            return;
          }
          
          const rect = gameBoard.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Выравнивание по сетке (50px клетка)
          const gridSize = 50;
          const gridX = Math.round(x / gridSize) * gridSize;
          const gridY = Math.round(y / gridSize) * gridSize;

          const token = document.createElement('div');
          token.className = 'token';
          
          const tokenData = tokens.find(t => t.id === selectedTokenId);
          if (tokenData) {
            const tokenImg = document.createElement('img');
            tokenImg.src = tokenData.url;
            tokenImg.className = 'token-image';
            token.appendChild(tokenImg);
            token.dataset.tokenId = tokenData.id;
          }
          
          token.style.left = `${gridX}px`;
          token.style.top = `${gridY}px`;
          token.draggable = true;
          
          // Add drag functionality
          token.addEventListener('mousedown', startDrag);
          
          gameBoard.appendChild(token);
          showNotification(`Token placed on board`);
        }
      });

      // Token dragging functionality
      function startDrag(e) {
        if (currentTool !== 'select') return;
        
        const token = e.target.closest('.token');
        selectedToken = token;
        isDragging = true;
        
        token.classList.add('selected');
        
        const shiftX = e.clientX - token.getBoundingClientRect().left;
        const shiftY = e.clientY - token.getBoundingClientRect().top;
        
        function moveAt(pageX, pageY) {
          const rect = gameBoard.getBoundingClientRect();
          const x = pageX - rect.left - shiftX;
          const y = pageY - rect.top - shiftY;
          
          // Выравнивание по сетке при перетаскивании
          const gridSize = 50;
          const gridX = Math.round(x / gridSize) * gridSize;
          const gridY = Math.round(y / gridSize) * gridSize;
          
          // Boundary checks
          if (gridX >= 0 && gridX <= rect.width && gridY >= 0 && gridY <= rect.height) {
            token.style.left = `${gridX}px`;
            token.style.top = `${gridY}px`;
          }
        }
        
        function onMouseMove(e) {
          if (!isDragging) return;
          moveAt(e.clientX, e.clientY);
        }
        
        document.addEventListener('mousemove', onMouseMove);
        
        token.onmouseup = function() {
          document.removeEventListener('mousemove', onMouseMove);
          isDragging = false;
          token.onmouseup = null;
        };
      }

      // Eraser (remove token on click)
      gameBoard.addEventListener('click', (e) => {
        if (currentTool !== 'eraser') return;
        
        const token = e.target.closest('.token');
        if (token) {
          token.remove();
          showNotification('Token removed');
        }
      });

      // Select token on field
      gameBoard.addEventListener('click', (e) => {
        if (currentTool !== 'select') return;
        
        const token = e.target.closest('.token');
        if (token) {
          // Deselect previous token
          if (selectedToken) {
            selectedToken.classList.remove('selected');
          }
          
          // Select new token
          selectedToken = token;
          token.classList.add('selected');
          showNotification('Token selected');
        } else {
          // Clicked outside token - deselect
          if (selectedToken) {
            selectedToken.classList.remove('selected');
            selectedToken = null;
          }
        }
      });

      // Chat functionality
      sendChatBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        // In a real app, this would come from user authentication
        const username = "Player"; 
        
        const message = document.createElement('div');
        message.className = 'message';
        message.innerHTML = `<strong>${username}:</strong> ${text}`;
        
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        chatInput.value = '';
      }

      // Notification system
      function showNotification(text) {
        notification.textContent = text;
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Map modal functionality
      loadMapBtn.addEventListener('click', () => {
        mapModalTitle.textContent = 'Load Map';
        mapForm.reset();
        mapPreviewContainer.style.display = 'none';
        editingMapId = null;
        mapModal.classList.add('active');
      });

      editMapBtn.addEventListener('click', () => {
        mapModalTitle.textContent = 'Edit Map';
        mapForm.reset();
        mapPreviewContainer.style.display = 'none';
        
        // In a real app, you would have a way to select which map to edit
        // For now, we'll edit the current map
        const currentMap = maps.find(m => m.id === currentMapId);
        if (currentMap) {
          mapName.value = currentMap.name;
          editingMapId = currentMap.id;
          mapModal.classList.add('active');
        } else {
          showNotification('No map selected for editing');
        }
      });

      closeMapModal.addEventListener('click', () => {
        mapModal.classList.remove('active');
      });

      cancelMapBtn.addEventListener('click', () => {
        mapModal.classList.remove('active');
      });

      // Token modal functionality
      loadTokenBtn.addEventListener('click', () => {
        tokenForm.reset();
        tokenPreviewContainer.style.display = 'none';
        tokenModal.classList.add('active');
      });

      closeTokenModal.addEventListener('click', () => {
        tokenModal.classList.remove('active');
      });

      cancelTokenBtn.addEventListener('click', () => {
        tokenModal.classList.remove('active');
      });

      // File preview functionality
      mapFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            mapPreview.src = e.target.result;
            mapPreviewContainer.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      tokenFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            tokenPreview.src = e.target.result;
            tokenPreviewContainer.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      // Save map
      mapForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = mapName.value.trim();
        const file = mapFile.files[0];
        
        if (!name) {
          showNotification('Enter map name');
          return;
        }
        
        if (editingMapId) {
          // Edit existing map
          const mapIndex = maps.findIndex(m => m.id === editingMapId);
          if (mapIndex !== -1) {
            maps[mapIndex].name = name;
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                maps[mapIndex].url = e.target.result;
                saveMaps();
                mapModal.classList.remove('active');
                renderMapSelector();
                updateCurrentMap();
                showNotification('Map updated');
              };
              reader.readAsDataURL(file);
            } else {
              saveMaps();
              mapModal.classList.remove('active');
              renderMapSelector();
              updateCurrentMap();
              showNotification('Map updated');
            }
          }
        } else {
          // Add new map
          if (!file) {
            showNotification('Select map file');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const newMap = {
              id: 'map-' + Date.now(),
              name: name,
              url: e.target.result
            };
            
            maps.push(newMap);
            saveMaps();
            mapModal.classList.remove('active');
            renderMapSelector();
            showNotification('Map added');
          };
          reader.readAsDataURL(file);
        }
      });

      // Save token
      tokenForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = tokenName.value.trim();
        const file = tokenFile.files[0];
        
        if (!name) {
          showNotification('Enter token name');
          return;
        }
        
        if (!file) {
          showNotification('Select token file');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const newToken = {
            id: 'token-' + Date.now(),
            name: name,
            url: e.target.result
          };
          
          tokens.push(newToken);
          saveTokens();
          tokenModal.classList.remove('active');
          renderTokenList();
          // Автоматически выбираем новый токен
          selectToken(newToken.id);
          showNotification('Token added');
        };
        reader.readAsDataURL(file);
      });

      // Save data to localStorage
      function saveMaps() {
        localStorage.setItem('obMaps', JSON.stringify(maps));
      }

      function saveTokens() {
        localStorage.setItem('obTokens', JSON.stringify(tokens));
      }

      // Initialize the application
      init();
    </script>
  </body>
</html>
