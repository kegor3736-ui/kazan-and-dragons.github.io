<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6a0dad" />
    <meta name="description" content="A more bear-able virtual tabletop" />

    <meta property="og:title" content="K&D Tabletop" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.knd-tabletop.app" />
    <meta property="og:image" content="https://images.owlbear.rodeo/shared/backgrounds/10.jpg?class=social" />

    <meta name="twitter:title" content="K&D Tabletop" />
    <meta
      name="twitter:description"
      content="Join your party in The Mauve Root"
    />
    <meta name="twitter:image" content="https://images.owlbear.rodeo/shared/backgrounds/10.jpg?class=social" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />
    <title>K&D Tabletop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* =============== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =============== */
      :root {
        --primary: #6a0dad;
        --primary-light: #8a2be2;
        --primary-dark: #4b0082;
        --accent: #e0b0ff;
        --text: #f8f8ff;
        --bg: #0f0c1d;
        --card-bg: #1a142d;
        --sidebar-width: 280px;
        --success: #4ade80;
        --error: #f87171;
      }

      /* =============== СБРОС И БАЗА =============== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        line-height: 1.6;
        overflow-x: hidden;
      }

      /* Глобальный фон сайта */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('https://i.pinimg.com/736x/c9/6b/af/c96baf75b018d3f5160c7738b5c9753e.jpg') no-repeat center center/cover;
        opacity: 0.08;
        z-index: -1;
        pointer-events: none;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      /* =============== БОКОВАЯ ПАНЕЛЬ =============== */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(160deg, var(--primary-dark), var(--card-bg));
        padding: 2rem 1.2rem;
        z-index: 1000;
        transform: translateX(0);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        box-shadow: 5px 0 25px rgba(0, 0, 0, 0.6);
        overflow-y: auto;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .logo-sidebar {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
        margin-bottom: 2rem;
        white-space: nowrap;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        background: url('https://placehold.co/50x50/8a2be2/ffffff?text=K%26D') no-repeat center;
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
      }

      .nav-links {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .nav-links a {
        color: var(--text);
        text-decoration: none;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover, .nav-links a.active {
        background: rgba(138, 43, 226, 0.2);
        color: var(--accent);
      }

      .tools {
        margin-top: auto;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .tool-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .tool-btn:hover, .tool-btn.active {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      /* =============== ОСНОВНОЙ КОНТЕНТ =============== */
      .main-content {
        margin-left: var(--sidebar-width);
        transition: margin-left 0.5s ease;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .main-content.sidebar-hidden {
        margin-left: 0;
      }

      .content-wrapper {
        flex: 1;
      }

      /* =============== ШАПКА =============== */
      .tabletop-header {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .menu-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 1.6rem;
        cursor: pointer;
        transition: transform 0.4s ease;
      }

      .menu-toggle:hover {
        transform: rotate(90deg);
        color: var(--accent);
      }

      .map-selector {
        display: flex;
        gap: 0.6rem;
      }

      .map-option {
        padding: 0.4rem 0.8rem;
        background: rgba(10, 8, 29, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        position: relative;
      }

      .map-option.active {
        background: var(--primary);
        border-color: var(--primary-light);
      }

      .map-option:hover .delete-map-btn {
        opacity: 1;
      }

      .delete-map-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 16px;
        height: 16px;
        background: var(--error);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 10px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-map-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      /* =============== ИГРОВОЕ ПОЛЕ =============== */
      .game-board {
        flex: 1;
        position: relative;
        background: #151025;
        overflow: hidden;
        cursor: grab;
      }

      .game-board.dragging {
        cursor: grabbing;
      }

      .board-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform-origin: 0 0;
        transition: transform 0.1s ease;
      }

      .board-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.85;
        transition: opacity 0.3s ease;
        user-select: none;
        -webkit-user-drag: none;
      }

      /* Сетка */
      .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(rgba(224, 176, 255, 0.2) 1px, transparent 1px),
          linear-gradient(90deg, rgba(224, 176, 255, 0.2) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
        z-index: 5;
      }

      .token {
        position: absolute;
        border-radius: 50%;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        transform: translate(-50%, -50%);
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        transition: all 0.2s ease;
        z-index: 10;
        user-select: none;
      }

      .token:hover {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.7);
      }

      .token.selected {
        border: 2px solid var(--accent);
        box-shadow: 0 0 15px var(--accent);
      }

      .token.dragging {
        z-index: 100;
        cursor: grabbing;
      }

      .token-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      /* =============== ВЫБОР ТОКЕНОВ =============== */
      .token-selector {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .token-selector-title {
        font-size: 0.9rem;
        color: var(--accent);
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .token-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 150px;
        overflow-y: auto;
        padding: 0.5rem;
        background: rgba(10, 8, 29, 0.5);
        border-radius: 6px;
      }

      .token-item {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: grab;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        overflow: hidden;
      }

      .token-item:hover {
        transform: scale(1.1);
        border-color: var(--accent);
      }

      .token-item.selected {
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
      }

      .token-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* =============== ЧАТ =============== */
      .chat-panel {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        width: 320px;
        height: 280px;
        background: rgba(10, 8, 29, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        z-index: 100;
      }

      .chat-header {
        padding: 0.6rem 1rem;
        background: rgba(26, 20, 45, 0.8);
        border-bottom: 1px solid rgba(138, 43, 226, 0.3);
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-toggle {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 1rem;
      }

      .chat-messages {
        flex: 1;
        padding: 0.8rem;
        overflow-y: auto;
        font-size: 0.85rem;
      }

      .message {
        margin-bottom: 0.6rem;
        line-height: 1.4;
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
      }

      .message:hover {
        background: rgba(138, 43, 226, 0.1);
      }

      .message strong {
        color: var(--accent);
      }

      .chat-input {
        display: flex;
        padding: 0.5rem;
        background: rgba(26, 20, 45, 0.8);
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .chat-input input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        background: rgba(5, 3, 15, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 4px;
        color: var(--text);
        font-size: 0.85rem;
      }

      .chat-input button {
        margin-left: 0.5rem;
        padding: 0.4rem 0.8rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .chat-input button:hover {
        background: var(--primary);
      }

      /* =============== КНОПКИ =============== */
      .btn, .submit-btn, .post-btn, .new-char-btn, .apply-btn, .chat-btn, .filter-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        text-align: center;
      }

      .btn {
        padding: 0.9rem 1.8rem;
        border-radius: 50px;
        font-weight: 700;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(138, 43, 226, 0.5);
      }

      .btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .btn:hover::after {
        transform: translateX(100%);
      }

      .btn-primary, .submit-btn, .post-btn, .new-char-btn, .apply-btn {
        background: var(--primary-light);
        color: white;
      }

      .btn-primary:hover, .submit-btn:hover, .post-btn:hover, .new-char-btn:hover, .apply-btn:hover {
        background: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
      }

      .btn-secondary, .chat-btn {
        background: transparent;
        color: var(--accent);
        border: 2px solid var(--accent);
      }

      .btn-secondary:hover, .chat-btn:hover {
        background: rgba(224, 176, 255, 0.1);
        transform: translateY(-3px);
      }

      /* =============== УВЕДОМЛЕНИЯ =============== */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transform: translateX(150%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      /* =============== МОДАЛЬНЫЕ ОКНА =============== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: linear-gradient(145deg, var(--card-bg), #221a3a);
        border-radius: 20px;
        padding: 2.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(138, 43, 226, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.3rem;
        color: var(--accent);
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text);
        font-size: 1.5rem;
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 1.4rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--accent);
        font-weight: 600;
      }

      .form-control {
        width: 100%;
        padding: 0.85rem 1.1rem;
        background: rgba(10, 8, 29, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 10px;
        color: var(--text);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
      }

      .file-input {
        display: none;
      }

      .file-label {
        display: block;
        padding: 1rem;
        background: rgba(10, 8, 29, 0.7);
        border: 2px dashed rgba(138, 43, 226, 0.4);
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .file-label:hover {
        border-color: var(--primary);
        background: rgba(138, 43, 226, 0.1);
      }

      .preview-container {
        margin-top: 1rem;
        text-align: center;
      }

      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 0.5rem;
      }

      /* =============== ПАНЕЛЬ УПРАВЛЕНИЯ КАРТОЙ =============== */
      .map-controls-panel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(10, 8, 29, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 10px;
        padding: 15px;
        z-index: 50;
        min-width: 250px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .map-controls-panel.hidden {
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group:last-child {
        margin-bottom: 0;
      }

      .control-label {
        display: block;
        margin-bottom: 5px;
        font-size: 12px;
        color: var(--accent);
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: var(--primary-light);
        border-radius: 50%;
        cursor: pointer;
      }

      .slider-value {
        width: 40px;
        text-align: center;
        font-size: 12px;
        color: var(--accent);
      }

      .position-sliders {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }

      .position-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .control-btn {
        padding: 8px 12px;
        background: var(--primary-light);
        border: none;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
      }

      .control-btn:hover {
        background: var(--primary);
      }

      .control-btn.reset {
        background: #f44336;
      }

      .control-btn.reset:hover {
        background: #da190b;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .toggle-controls-btn {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: rgba(10, 8, 29, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 50%;
        color: var(--accent);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 51;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .toggle-controls-btn:hover {
        background: var(--primary-light);
        color: white;
      }

      /* =============== ПАНЕЛЬ ЗУМА В ВЕРХНЕМ УГЛУ =============== */
      .zoom-controls-top {
        position: absolute;
        top: 80px;
        right: 20px;
        background: rgba(10, 8, 29, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 10px;
        padding: 10px;
        z-index: 50;
        display: flex;
        gap: 8px;
        backdrop-filter: blur(10px);
      }

      .zoom-btn {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .zoom-btn:hover {
        background: var(--primary-light);
        transform: scale(1.05);
      }

      .zoom-btn:active {
        transform: scale(0.95);
      }

      .zoom-display {
        min-width: 60px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        font-family: 'Courier New', monospace;
      }

      /* =============== СТАТУС КАРТЫ В БОКОВОЙ ПАНЕЛИ =============== */
      .map-status {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .status-label {
        color: var(--accent);
        font-weight: 600;
      }

      .status-value {
        color: var(--text);
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        min-width: 60px;
        text-align: center;
      }

      /* =============== ДОПОЛНИТЕЛЬНЫЕ СТИЛИ =============== */
      .tool-btn i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
      }

      .map-manager {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .map-manager-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .map-manager-btn:hover {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      .token-manager {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(138, 43, 226, 0.3);
      }

      .token-manager-btn {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 0.6rem;
        background: rgba(26, 20, 45, 0.8);
        color: var(--text);
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s ease;
      }

      .token-manager-btn:hover {
        background: var(--primary);
        border-color: var(--primary-light);
        color: white;
      }

      .token-size-controls {
        margin-top: 0.5rem;
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      .token-size-btn {
        width: 25px;
        height: 25px;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
      }

      .token-size-btn:hover {
        background: var(--primary);
      }

      /* =============== АДАПТИВНОСТЬ =============== */
      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .map-controls-panel {
          left: 10px;
          bottom: 10px;
          min-width: auto;
        }
        
        .zoom-controls-top {
          top: 70px;
          right: 10px;
        }

        .toggle-controls-btn {
          left: 10px;
          bottom: 10px;
        }
      }

      @media (max-width: 576px) {
        :root { --sidebar-width: 100%; }
        .sidebar { width: 100%; height: 100vh; }
        .main-content.sidebar-hidden { position: relative; }
        .chat-panel { display: none; }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-sidebar">
        <div class="logo-icon"></div>
        <span>K&D Tabletop</span>
      </div>
      <ul class="nav-links">
        <li><a href="#" class="active">Game Table</a></li>
        <li><a href="#">Characters</a></li>
        <li><a href="#">Parties</a></li>
        <li><a href="#">Rules</a></li>
        <li><a href="#">Settings</a></li>
      </ul>

      <!-- Статус карты -->
      <div class="map-status">
        <div class="status-item">
          <span class="status-label">Zoom:</span>
          <span class="status-value" id="sidebarZoomValue">100%</span>
        </div>
        <div class="status-item">
          <span class="status-label">Position X:</span>
          <span class="status-value" id="sidebarPosXValue">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Position Y:</span>
          <span class="status-value" id="sidebarPosYValue">0</span>
        </div>
      </div>

      <div class="tools">
        <button class="tool-btn" data-tool="select"><i class="fas fa-mouse-pointer"></i> Select</button>
        <button class="tool-btn" data-tool="eraser"><i class="fas fa-eraser"></i> Eraser</button>
        <button class="tool-btn" id="clearBoard"><i class="fas fa-trash"></i> Clear Board</button>
      </div>

      <!-- Выбор токенов -->
      <div class="token-selector">
        <div class="token-selector-title">Drag tokens to board:</div>
        <div class="token-list" id="tokenList">
          <!-- Токены будут добавляться динамически -->
        </div>
      </div>

      <div class="map-manager">
        <button class="map-manager-btn" id="loadMapBtn"><i class="fas fa-upload"></i> Load Map</button>
        <button class="map-manager-btn" id="deleteCurrentMapBtn"><i class="fas fa-trash"></i> Delete Current Map</button>
      </div>

      <div class="token-manager">
        <button class="token-manager-btn" id="loadTokenBtn"><i class="fas fa-upload"></i> Load Token</button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="tabletop-header">
        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-bars"></i>
        </button>
        <div id="currentMapName">Game Table</div>
        <div class="map-selector" id="mapSelector">
          <!-- Map options will be dynamically added here -->
        </div>
      </header>

      <div class="game-board" id="gameBoard">
        <div class="board-container" id="boardContainer">
          <img src="https://images.owlbear.rodeo/shared/backgrounds/10.jpg" class="board-image" id="boardImage">
          <div class="grid-overlay"></div>
          <!-- Tokens will be added here -->
        </div>
        
        <!-- Панель управления картой -->
        <div class="map-controls-panel" id="mapControlsPanel">
          <div class="control-group">
            <label class="control-label">Zoom: <span id="zoomDisplay">100%</span></label>
            <div class="slider-container">
              <input type="range" min="10" max="300" value="100" class="slider" id="zoomSlider">
              <span class="slider-value" id="zoomPercent">100%</span>
            </div>
          </div>
          
          <div class="position-sliders">
            <div class="position-group">
              <label class="control-label">Position X</label>
              <div class="slider-container">
                <input type="range" min="-200" max="200" value="0" class="slider" id="posXSlider">
                <span class="slider-value" id="posXDisplay">0</span>
              </div>
            </div>
            
            <div class="position-group">
              <label class="control-label">Position Y</label>
              <div class="slider-container">
                <input type="range" min="-200" max="200" value="0" class="slider" id="posYSlider">
                <span class="slider-value" id="posYDisplay">0</span>
              </div>
            </div>
          </div>
          
          <div class="button-group">
            <button class="control-btn reset" id="resetBtn">Reset</button>
            <button class="control-btn" id="centerBtn">Center</button>
          </div>
        </div>
        
        <!-- Кнопка переключения панели управления -->
        <button class="toggle-controls-btn" id="toggleControlsBtn" title="Toggle Controls">
          <i class="fas fa-sliders-h"></i>
        </button>
        
        <!-- Панель зума в верхнем углу -->
        <div class="zoom-controls-top">
          <button class="zoom-btn" id="zoomOutBtnTop" title="Zoom Out">
            <i class="fas fa-search-minus"></i>
          </button>
          <div class="zoom-display" id="zoomDisplayTop">100%</div>
          <button class="zoom-btn" id="zoomInBtnTop" title="Zoom In">
            <i class="fas fa-search-plus"></i>
          </button>
          <button class="zoom-btn" id="zoomResetBtnTop" title="Reset Zoom">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>

      <!-- Чат -->
      <div class="chat-panel">
        <div class="chat-header">
          <span>Party Chat</span>
          <button class="chat-toggle" id="toggleChat"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="message"><strong>System:</strong> Game table loaded. Drag tokens from sidebar to board.</div>
          <div class="message"><strong>DM:</strong> Welcome to our adventure!</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100">
          <button id="sendChat" class="btn-primary"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal" id="mapModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="mapModalTitle">Load Map</h3>
          <button class="modal-close" id="closeMapModal">&times;</button>
        </div>
        <form id="mapForm">
          <div class="form-group">
            <label for="mapName">Map Name</label>
            <input type="text" id="mapName" class="form-control" placeholder="Enter map name">
          </div>
          <div class="form-group">
            <label for="mapFile">Map File</label>
            <input type="file" id="mapFile" class="file-input" accept="image/*">
            <label for="mapFile" class="file-label" id="mapFileLabel">
              <i class="fas fa-cloud-upload-alt"></i><br>
              Click to upload image
            </label>
            <div class="preview-container" id="mapPreviewContainer" style="display: none;">
              <div>Preview:</div>
              <img id="mapPreview" class="preview-image">
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelMapBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveMapBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="tokenModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="tokenModalTitle">Load Token</h3>
          <button class="modal-close" id="closeTokenModal">&times;</button>
        </div>
        <form id="tokenForm">
          <div class="form-group">
            <label for="tokenName">Token Name</label>
            <input type="text" id="tokenName" class="form-control" placeholder="Enter token name">
          </div>
          <div class="form-group">
            <label for="tokenFile">Token File</label>
            <input type="file" id="tokenFile" class="file-input" accept="image/*">
            <label for="tokenFile" class="file-label" id="tokenFileLabel">
              <i class="fas fa-cloud-upload-alt"></i><br>
              Click to upload image
            </label>
            <div class="preview-container" id="tokenPreviewContainer" style="display: none;">
              <div>Preview:</div>
              <img id="tokenPreview" class="preview-image">
            </div>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelTokenBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveTokenBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="notification" id="notification">Message</div>

    <script>
      // DOM elements
      const gameBoard = document.getElementById('gameBoard');
      const boardContainer = document.getElementById('boardContainer');
      const boardImage = document.getElementById('boardImage');
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      const sendChatBtn = document.getElementById('sendChat');
      const toolBtns = document.querySelectorAll('.tool-btn[data-tool]');
      const clearBoardBtn = document.getElementById('clearBoard');
      const toggleChatBtn = document.getElementById('toggleChat');
      const notification = document.getElementById('notification');
      const mapSelector = document.getElementById('mapSelector');
      const currentMapName = document.getElementById('currentMapName');
      const tokenList = document.getElementById('tokenList');
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.querySelector('.sidebar');
      const mainContent = document.querySelector('.main-content');
      const deleteCurrentMapBtn = document.getElementById('deleteCurrentMapBtn');
      
      // Элементы управления картой
      const mapControlsPanel = document.getElementById('mapControlsPanel');
      const toggleControlsBtn = document.getElementById('toggleControlsBtn');
      const zoomSlider = document.getElementById('zoomSlider');
      const zoomPercent = document.getElementById('zoomPercent');
      const zoomDisplay = document.getElementById('zoomDisplay');
      
      const posXSlider = document.getElementById('posXSlider');
      const posYSlider = document.getElementById('posYSlider');
      const posXDisplay = document.getElementById('posXDisplay');
      const posYDisplay = document.getElementById('posYDisplay');
      
      const resetBtn = document.getElementById('resetBtn');
      const centerBtn = document.getElementById('centerBtn');
      
      // Элементы зума в верхнем углу
      const zoomInBtnTop = document.getElementById('zoomInBtnTop');
      const zoomOutBtnTop = document.getElementById('zoomOutBtnTop');
      const zoomResetBtnTop = document.getElementById('zoomResetBtnTop');
      const zoomDisplayTop = document.getElementById('zoomDisplayTop');
      
      // Элементы статуса в боковой панели
      const sidebarZoomValue = document.getElementById('sidebarZoomValue');
      const sidebarPosXValue = document.getElementById('sidebarPosXValue');
      const sidebarPosYValue = document.getElementById('sidebarPosYValue');
      
      // Modal elements
      const mapModal = document.getElementById('mapModal');
      const tokenModal = document.getElementById('tokenModal');
      const loadMapBtn = document.getElementById('loadMapBtn');
      const loadTokenBtn = document.getElementById('loadTokenBtn');
      const closeMapModal = document.getElementById('closeMapModal');
      const closeTokenModal = document.getElementById('closeTokenModal');
      const cancelMapBtn = document.getElementById('cancelMapBtn');
      const cancelTokenBtn = document.getElementById('cancelTokenBtn');
      const mapForm = document.getElementById('mapForm');
      const tokenForm = document.getElementById('tokenForm');
      const mapFile = document.getElementById('mapFile');
      const tokenFile = document.getElementById('tokenFile');
      const mapPreview = document.getElementById('mapPreview');
      const tokenPreview = document.getElementById('tokenPreview');
      const mapPreviewContainer = document.getElementById('mapPreviewContainer');
      const tokenPreviewContainer = document.getElementById('tokenPreviewContainer');
      const mapName = document.getElementById('mapName');
      const tokenName = document.getElementById('tokenName');
      const mapModalTitle = document.getElementById('mapModalTitle');

      // State
      let currentTool = 'select';
      let selectedToken = null;
      let isDragging = false;
      let isPanning = false;
      let zoomLevel = 1.0;
      let boardX = 0;
      let boardY = 0;
      let editingMapId = null;
      let selectedTokenId = null;
      let controlsVisible = true;

      // Data storage
      let maps = JSON.parse(localStorage.getItem('obMaps')) || [
        { id: 'mauve-root', name: 'The Mauve Root', url: 'https://images.owlbear.rodeo/shared/backgrounds/10.jpg' },
        { id: 'forest', name: 'Enchanted Forest', url: 'https://images.owlbear.rodeo/shared/backgrounds/2.jpg' },
        { id: 'dungeon', name: 'Ancient Dungeon', url: 'https://images.owlbear.rodeo/shared/backgrounds/5.jpg' }
      ];
      
      let tokens = JSON.parse(localStorage.getItem('obTokens')) || [];
      let boardTokens = JSON.parse(localStorage.getItem('obBoardTokens')) || {};
      let currentMapId = 'mauve-root';

      // Initialize
      function init() {
        renderMapSelector();
        renderTokenList();
        updateCurrentMap();
        loadBoardTokens();
        updateBoardTransform();
        updateDisplay();
        setupEventListeners();
        showNotification('Game table ready to use');
        
        // Set initial tool
        toolBtns[0].classList.add('active');
      }

      // Toggle sidebar
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('sidebar-hidden');
      });

      // Настройка обработчиков событий для управления картой
      function setupEventListeners() {
        // Слайдер зума
        zoomSlider.addEventListener('input', (e) => {
          zoomLevel = parseInt(e.target.value) / 100;
          updateBoardTransform();
          updateDisplay();
        });

        // Слайдеры позиции
        posXSlider.addEventListener('input', (e) => {
          boardX = parseInt(e.target.value);
          updateBoardTransform();
          updateDisplay();
        });

        posYSlider.addEventListener('input', (e) => {
          boardY = parseInt(e.target.value);
          updateBoardTransform();
          updateDisplay();
        });

        // Кнопки управления
        resetBtn.addEventListener('click', resetMap);
        centerBtn.addEventListener('click', centerMap);

        // Кнопки зума в верхнем углу
        zoomInBtnTop.addEventListener('click', () => {
          zoomLevel = Math.min(zoomLevel + 0.1, 3.0);
          updateZoomFromLevel();
        });

        zoomOutBtnTop.addEventListener('click', () => {
          zoomLevel = Math.max(zoomLevel - 0.1, 0.1);
          updateZoomFromLevel();
        });

        zoomResetBtnTop.addEventListener('click', () => {
          zoomLevel = 1.0;
          updateZoomFromLevel();
        });

        // Переключение видимости панели управления
        toggleControlsBtn.addEventListener('click', toggleControls);

        // Перетаскивание карты мышью
        gameBoard.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', dragMap);
        document.addEventListener('mouseup', stopDrag);

        // Зум колесиком мыши
        gameBoard.addEventListener('wheel', handleWheel, { passive: false });

        // Касания для мобильных устройств
        gameBoard.addEventListener('touchstart', handleTouchStart, { passive: false });
        gameBoard.addEventListener('touchmove', handleTouchMove, { passive: false });
        gameBoard.addEventListener('touchend', stopDrag);

        // Удаление текущей карты
        deleteCurrentMapBtn.addEventListener('click', deleteCurrentMap);
      }

      // Переключение видимости панели управления
      function toggleControls() {
        controlsVisible = !controlsVisible;
        if (controlsVisible) {
          mapControlsPanel.classList.remove('hidden');
          toggleControlsBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
          toggleControlsBtn.title = 'Hide Controls';
        } else {
          mapControlsPanel.classList.add('hidden');
          toggleControlsBtn.innerHTML = '<i class="fas fa-eye"></i>';
          toggleControlsBtn.title = 'Show Controls';
        }
      }

      // Render map selector с кнопками удаления
      function renderMapSelector() {
        mapSelector.innerHTML = '';
        maps.forEach(map => {
          const option = document.createElement('div');
          option.className = `map-option ${map.id === currentMapId ? 'active' : ''}`;
          option.dataset.map = map.id;
          option.textContent = map.name;
          
          // Добавляем кнопку удаления для каждой карты (кроме стандартных)
          if (!['mauve-root', 'forest', 'dungeon'].includes(map.id)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-map-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = 'Delete this map';
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteMap(map.id);
            });
            option.appendChild(deleteBtn);
          }
          
          option.addEventListener('click', () => {
            selectMap(map.id);
          });
          mapSelector.appendChild(option);
        });
      }

      // Render token list
      function renderTokenList() {
        tokenList.innerHTML = '';
        
        if (tokens.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.textContent = 'No tokens';
          emptyMsg.style.color = '#888';
          emptyMsg.style.textAlign = 'center';
          emptyMsg.style.width = '100%';
          emptyMsg.style.padding = '10px';
          tokenList.appendChild(emptyMsg);
          return;
        }
        
        tokens.forEach(token => {
          const tokenItem = document.createElement('div');
          tokenItem.className = `token-item ${token.id === selectedTokenId ? 'selected' : ''}`;
          tokenItem.dataset.tokenId = token.id;
          tokenItem.draggable = true;
          
          const tokenImg = document.createElement('img');
          tokenImg.src = token.url;
          tokenImg.alt = token.name;
          
          tokenItem.appendChild(tokenImg);
          
          // Drag events for token from sidebar
          tokenItem.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', token.id);
            tokenItem.classList.add('dragging');
          });
          
          tokenItem.addEventListener('dragend', () => {
            tokenItem.classList.remove('dragging');
          });
          
          tokenList.appendChild(tokenItem);
        });
      }

      // Select token
      function selectToken(tokenId) {
        selectedTokenId = tokenId;
        renderTokenList();
        showNotification(`Selected token: ${tokens.find(t => t.id === tokenId)?.name}`);
      }

      // Select map
      function selectMap(mapId) {
        // Save current tokens before switching
        saveBoardTokens();
        
        currentMapId = mapId;
        const map = maps.find(m => m.id === mapId);
        if (map) {
          boardImage.src = map.url;
          currentMapName.textContent = map.name;
          renderMapSelector();
          
          // Load tokens for this map
          loadBoardTokens();
          
          showNotification(`Map changed: ${map.name}`);
        }
      }

      // Update current map display
      function updateCurrentMap() {
        const map = maps.find(m => m.id === currentMapId);
        if (map) {
          currentMapName.textContent = map.name;
        }
      }

      // Save tokens for current map
      function saveBoardTokens() {
        const tokensOnBoard = [];
        document.querySelectorAll('.token').forEach(tokenEl => {
          const tokenData = {
            id: tokenEl.dataset.tokenId,
            x: parseFloat(tokenEl.style.left),
            y: parseFloat(tokenEl.style.top),
            size: parseInt(tokenEl.style.width)
          };
          tokensOnBoard.push(tokenData);
        });
        
        boardTokens[currentMapId] = tokensOnBoard;
        localStorage.setItem('obBoardTokens', JSON.stringify(boardTokens));
      }

      // Load tokens for current map
      function loadBoardTokens() {
        // Clear existing tokens
        document.querySelectorAll('.token').forEach(token => token.remove());
        
        const tokensOnBoard = boardTokens[currentMapId] || [];
        
        tokensOnBoard.forEach(tokenData => {
          const token = createTokenElement(tokenData.id, tokenData.x, tokenData.y, tokenData.size);
          boardContainer.appendChild(token);
        });
      }

      // Create token element
      function createTokenElement(tokenId, x, y, size = 40) {
        const token = document.createElement('div');
        token.className = 'token';
        token.style.width = `${size}px`;
        token.style.height = `${size}px`;
        token.style.left = `${x}px`;
        token.style.top = `${y}px`;
        token.dataset.tokenId = tokenId;
        
        const tokenData = tokens.find(t => t.id === tokenId);
        if (tokenData) {
          const tokenImg = document.createElement('img');
          tokenImg.src = tokenData.url;
          tokenImg.className = 'token-image';
          token.appendChild(tokenImg);
        }
        
        // Add drag functionality - токен следует за курсором
        token.addEventListener('mousedown', startTokenDrag);
        
        // Add context menu for size control
        token.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showTokenSizeControls(token);
        });
        
        return token;
      }

      // Show token size controls
      function showTokenSizeControls(token) {
        // Remove existing controls
        document.querySelectorAll('.token-size-controls').forEach(ctrl => ctrl.remove());
        
        const controls = document.createElement('div');
        controls.className = 'token-size-controls';
        
        const sizes = [30, 40, 50, 60];
        sizes.forEach(size => {
          const btn = document.createElement('button');
          btn.className = 'token-size-btn';
          btn.textContent = size;
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            token.style.width = `${size}px`;
            token.style.height = `${size}px`;
            controls.remove();
            saveBoardTokens();
          });
          controls.appendChild(btn);
        });
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'token-size-btn';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          controls.remove();
        });
        controls.appendChild(closeBtn);
        
        token.appendChild(controls);
      }

      // Delete current map
      function deleteCurrentMap() {
        if (maps.length <= 1) {
          showNotification('Cannot delete the only map');
          return;
        }
        
        // Проверяем, не пытаемся ли удалить стандартную карту
        if (['mauve-root', 'forest', 'dungeon'].includes(currentMapId)) {
          showNotification('Cannot delete default maps');
          return;
        }
        
        if (confirm(`Are you sure you want to delete the map "${currentMapName.textContent}"? This action cannot be undone.`)) {
          deleteMap(currentMapId);
        }
      }

      // Delete specific map
      function deleteMap(mapId) {
        const mapIndex = maps.findIndex(m => m.id === mapId);
        if (mapIndex !== -1) {
          const mapName = maps[mapIndex].name;
          maps.splice(mapIndex, 1);
          
          // Delete tokens for this map
          delete boardTokens[mapId];
          
          // Select first available map if current map was deleted
          if (currentMapId === mapId) {
            currentMapId = maps[0].id;
            updateCurrentMap();
            loadBoardTokens();
          }
          
          saveMaps();
          localStorage.setItem('obBoardTokens', JSON.stringify(boardTokens));
          renderMapSelector();
          showNotification(`Map "${mapName}" deleted`);
        }
      }

      // Select tool
      toolBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          toolBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTool = btn.dataset.tool;
          
          // Reset cursor
          gameBoard.style.cursor = 'grab';
          if (currentTool === 'select') gameBoard.style.cursor = 'default';
          if (currentTool === 'eraser') gameBoard.style.cursor = 'not-allowed';
          
          showNotification(`Tool: ${btn.textContent.trim()}`);
        });
      });

      // Clear board
      clearBoardBtn.addEventListener('click', () => {
        if (confirm('Clear the entire board?')) {
          document.querySelectorAll('.token').forEach(t => t.remove());
          saveBoardTokens();
          showNotification('Board cleared');
        }
      });

      // Toggle chat
      toggleChatBtn.addEventListener('click', () => {
        const chatPanel = document.querySelector('.chat-panel');
        const isHidden = chatPanel.style.height === '40px';
        
        if (isHidden) {
          chatPanel.style.height = '280px';
          toggleChatBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        } else {
          chatPanel.style.height = '40px';
          toggleChatBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
      });

      // Обновление трансформации карты
      function updateBoardTransform() {
        boardContainer.style.transform = `translate(${boardX}px, ${boardY}px) scale(${zoomLevel})`;
      }

      // Обновление отображения значений
      function updateDisplay() {
        zoomPercent.textContent = `${Math.round(zoomLevel * 100)}%`;
        zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        zoomDisplayTop.textContent = `${Math.round(zoomLevel * 100)}%`;
        
        posXDisplay.textContent = boardX;
        posYDisplay.textContent = boardY;
        
        zoomSlider.value = Math.round(zoomLevel * 100);
        posXSlider.value = boardX;
        posYSlider.value = boardY;
        
        // Обновление значений в боковой панели
        sidebarZoomValue.textContent = `${Math.round(zoomLevel * 100)}%`;
        sidebarPosXValue.textContent = boardX;
        sidebarPosYValue.textContent = boardY;
      }

      // Обновление зума из уровня
      function updateZoomFromLevel() {
        updateBoardTransform();
        updateDisplay();
      }

      // Сброс карты
      function resetMap() {
        zoomLevel = 1.0;
        boardX = 0;
        boardY = 0;
        updateBoardTransform();
        updateDisplay();
      }

      // Центрирование карты
      function centerMap() {
        boardX = 0;
        boardY = 0;
        updateBoardTransform();
        updateDisplay();
      }

      // Обработка колесика мыши
      function handleWheel(e) {
        e.preventDefault();
        
        const rect = gameBoard.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newZoom = Math.min(Math.max(zoomLevel * zoomFactor, 0.1), 3.0);
        
        if (newZoom !== zoomLevel) {
          // Корректировка позиции для зума к курсору
          const scaleChange = newZoom / zoomLevel;
          boardX = mouseX - (mouseX - boardX) * scaleChange;
          boardY = mouseY - (mouseY - boardY) * scaleChange;
          
          zoomLevel = newZoom;
          updateBoardTransform();
          updateDisplay();
        }
      }

      // Начало перетаскивания
      function startDrag(e) {
        if (e.button === 1 || (e.button === 0 && e.altKey)) { // Middle mouse button or Alt+Left click
          e.preventDefault();
          isPanning = true;
          gameBoard.style.cursor = 'grabbing';
          gameBoard.classList.add('dragging');
        }
      }

      // Перетаскивание карты
      function dragMap(e) {
        if (!isPanning) return;
        
        const dx = e.movementX || 0;
        const dy = e.movementY || 0;
        
        boardX += dx;
        boardY += dy;
        
        // Ограничение перемещения
        const maxMove = 500;
        boardX = Math.max(Math.min(boardX, maxMove), -maxMove);
        boardY = Math.max(Math.min(boardY, maxMove), -maxMove);
        
        updateBoardTransform();
        updateDisplay();
      }

      // Окончание перетаскивания
      function stopDrag() {
        isPanning = false;
        gameBoard.style.cursor = currentTool === 'select' ? 'default' : 'grab';
        gameBoard.classList.remove('dragging');
      }

      // Обработка касаний (для мобильных устройств)
      function handleTouchStart(e) {
        if (e.touches.length === 1) {
          isPanning = true;
          gameBoard.classList.add('dragging');
        } else if (e.touches.length === 2) {
          // Мультитач для зума
          e.preventDefault();
          handlePinchStart(e);
        }
      }

      function handleTouchMove(e) {
        if (!isPanning) return;
        
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const dx = touch.clientX - startX;
          const dy = touch.clientY - startY;
          
          boardX = startPosX + dx;
          boardY = startPosY + dy;
          
          updateBoardTransform();
          updateDisplay();
        } else if (e.touches.length === 2) {
          e.preventDefault();
          handlePinchMove(e);
        }
      }

      let initialDistance = null;
      let initialZoom = null;

      function handlePinchStart(e) {
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        initialDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
        initialZoom = zoomLevel;
      }

      function handlePinchMove(e) {
        if (!initialDistance) return;
        
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
        
        const scale = currentDistance / initialDistance;
        zoomLevel = Math.min(Math.max(initialZoom * scale, 0.1), 3.0);
        
        updateBoardTransform();
        updateDisplay();
      }

      // Token dragging functionality - токен следует за курсором
      function startTokenDrag(e) {
        if (currentTool !== 'select') return;
        
        const token = e.target.closest('.token');
        selectedToken = token;
        isDragging = true;
        
        token.classList.add('selected', 'dragging');
        
        // Получаем начальные координаты
        const startX = e.clientX;
        const startY = e.clientY;
        const startLeft = parseFloat(token.style.left);
        const startTop = parseFloat(token.style.top);
        
        function moveAt(pageX, pageY) {
          const rect = boardContainer.getBoundingClientRect();
          const scale = zoomLevel;
          
          // Вычисляем смещение относительно начальной позиции
          const dx = (pageX - startX) / scale;
          const dy = (pageY - startY) / scale;
          
          // Новая позиция токена
          const newX = startLeft + dx;
          const newY = startTop + dy;
          
          // Выравнивание по сетке (50px клетка) при отпускании
          const gridSize = 50;
          const gridX = Math.round(newX / gridSize) * gridSize;
          const gridY = Math.round(newY / gridSize) * gridSize;
          
          // Boundary checks
          if (gridX >= 0 && gridX <= rect.width / scale && gridY >= 0 && gridY <= rect.height / scale) {
            // Во время перетаскивания используем точные координаты
            if (isDragging) {
              token.style.left = `${newX}px`;
              token.style.top = `${newY}px`;
            } else {
              // При отпускании выравниваем по сетке
              token.style.left = `${gridX}px`;
              token.style.top = `${gridY}px`;
            }
          }
        }
        
        function onMouseMove(e) {
          if (!isDragging) return;
          moveAt(e.clientX, e.clientY);
        }
        
        function onMouseUp(e) {
          // При отпускании выравниваем по сетке
          moveAt(e.clientX, e.clientY);
          
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          isDragging = false;
          token.classList.remove('dragging');
          saveBoardTokens();
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        
        // Предотвращаем выделение текста при перетаскивании
        e.preventDefault();
      }

      // Drop token from sidebar
      gameBoard.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      gameBoard.addEventListener('drop', (e) => {
        e.preventDefault();
        const tokenId = e.dataTransfer.getData('text/plain');
        
        if (tokenId) {
          const rect = boardContainer.getBoundingClientRect();
          const scale = zoomLevel;
          
          // Calculate position relative to board container
          const x = (e.clientX - rect.left) / scale;
          const y = (e.clientY - rect.top) / scale;
          
          // Выравнивание по сетке (50px клетка)
          const gridSize = 50;
          const gridX = Math.round(x / gridSize) * gridSize;
          const gridY = Math.round(y / gridSize) * gridSize;
          
          const token = createTokenElement(tokenId, gridX, gridY);
          boardContainer.appendChild(token);
          saveBoardTokens();
          showNotification('Token placed on board');
        }
      });

      // Eraser (remove token on click)
      gameBoard.addEventListener('click', (e) => {
        if (currentTool !== 'eraser') return;
        
        const token = e.target.closest('.token');
        if (token) {
          token.remove();
          saveBoardTokens();
          showNotification('Token removed');
        }
      });

      // Select token on field
      gameBoard.addEventListener('click', (e) => {
        if (currentTool !== 'select') return;
        
        const token = e.target.closest('.token');
        if (token) {
          // Deselect previous token
          if (selectedToken) {
            selectedToken.classList.remove('selected');
          }
          
          // Select new token
          selectedToken = token;
          token.classList.add('selected');
          showNotification('Token selected');
        } else {
          // Clicked outside token - deselect
          if (selectedToken) {
            selectedToken.classList.remove('selected');
            selectedToken = null;
          }
        }
      });

      // Chat functionality
      sendChatBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        // In a real app, this would come from user authentication
        const username = "Player"; 
        
        const message = document.createElement('div');
        message.className = 'message';
        message.innerHTML = `<strong>${username}:</strong> ${text}`;
        
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        chatInput.value = '';
      }

      // Notification system
      function showNotification(text) {
        notification.textContent = text;
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Map modal functionality
      loadMapBtn.addEventListener('click', () => {
        mapModalTitle.textContent = 'Load Map';
        mapForm.reset();
        mapPreviewContainer.style.display = 'none';
        editingMapId = null;
        mapModal.classList.add('active');
      });

      closeMapModal.addEventListener('click', () => {
        mapModal.classList.remove('active');
      });

      cancelMapBtn.addEventListener('click', () => {
        mapModal.classList.remove('active');
      });

      // Token modal functionality
      loadTokenBtn.addEventListener('click', () => {
        tokenForm.reset();
        tokenPreviewContainer.style.display = 'none';
        tokenModal.classList.add('active');
      });

      closeTokenModal.addEventListener('click', () => {
        tokenModal.classList.remove('active');
      });

      cancelTokenBtn.addEventListener('click', () => {
        tokenModal.classList.remove('active');
      });

      // File preview functionality
      mapFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            mapPreview.src = e.target.result;
            mapPreviewContainer.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      tokenFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            tokenPreview.src = e.target.result;
            tokenPreviewContainer.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      // Save map
      mapForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = mapName.value.trim();
        const file = mapFile.files[0];
        
        if (!name) {
          showNotification('Enter map name');
          return;
        }
        
        if (!file) {
          showNotification('Select map file');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const newMap = {
            id: 'map-' + Date.now(),
            name: name,
            url: e.target.result
          };
          
          maps.push(newMap);
          saveMaps();
          mapModal.classList.remove('active');
          renderMapSelector();
          showNotification('Map added');
        };
        reader.readAsDataURL(file);
      });

      // Save token
      tokenForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = tokenName.value.trim();
        const file = tokenFile.files[0];
        
        if (!name) {
          showNotification('Enter token name');
          return;
        }
        
        if (!file) {
          showNotification('Select token file');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const newToken = {
            id: 'token-' + Date.now(),
            name: name,
            url: e.target.result
          };
          
          tokens.push(newToken);
          saveTokens();
          tokenModal.classList.remove('active');
          renderTokenList();
          // Автоматически выбираем новый токен
          selectToken(newToken.id);
          showNotification('Token added');
        };
        reader.readAsDataURL(file);
      });

      // Save data to localStorage
      function saveMaps() {
        localStorage.setItem('obMaps', JSON.stringify(maps));
      }

      function saveTokens() {
        localStorage.setItem('obTokens', JSON.stringify(tokens));
      }

      // Initialize the application
      init();
    </script>
  </body>
</html>
